# 生产环境安全检查清单

> 版本: 1.0.0
> 更新时间: 2025-10-02
> 用途: 确保生产环境部署的安全性

---

## 🔴 第一优先级: 严重安全问题 (必须完成)

### 1. 身份验证和授权

- [ ] **移除开发环境认证绕过**
  - 文件: `lib/api/middleware.ts`
  - 验证: 确认没有 `if (env.NODE_ENV === 'development')` 绕过逻辑
  - 状态: ✅ 已完成

- [ ] **所有 API 路由需要身份验证**
  - 验证方法: 
    ```bash
    # 测试未登录访问 API
    curl -I https://your-domain.com/api/products
    # 应该返回 401 Unauthorized
    ```
  - 状态: ⏳ 待验证

- [ ] **会话管理正确配置**
  - 检查 `NEXTAUTH_SECRET` 已设置为强密钥
  - 检查 `NEXTAUTH_URL` 设置为正确的生产域名
  - 验证会话过期时间合理 (默认 90 天)
  - 状态: ⏳ 待配置

### 2. 安全响应头

- [ ] **Content Security Policy (CSP) 已配置**
  - 文件: `middleware.ts`
  - 验证方法:
    ```bash
    curl -I https://your-domain.com | grep "Content-Security-Policy"
    ```
  - 预期: 应该看到 CSP 头
  - 状态: ✅ 已完成

- [ ] **其他安全头已配置**
  - X-Content-Type-Options: nosniff
  - X-Frame-Options: DENY
  - X-XSS-Protection: 1; mode=block
  - Referrer-Policy: strict-origin-when-cross-origin
  - Permissions-Policy: camera=(), microphone=(), geolocation=()
  - 验证方法:
    ```bash
    curl -I https://your-domain.com | grep -E "(X-Content-Type-Options|X-Frame-Options|X-XSS-Protection|Referrer-Policy|Permissions-Policy)"
    ```
  - 状态: ✅ 已完成

### 3. 密钥和敏感信息

- [ ] **NEXTAUTH_SECRET 已更新**
  - 使用 `openssl rand -base64 32` 生成
  - 至少 32 字符
  - 不是开发环境的默认值
  - 状态: ⏳ 待生成

- [ ] **STORAGE_ENCRYPTION_KEY 已更新**
  - 使用 `openssl rand -base64 32` 生成
  - 至少 32 字符
  - 不是开发环境的默认值
  - 状态: ⏳ 待生成

- [ ] **数据库密码强度**
  - 至少 16 字符
  - 包含大小写字母、数字、特殊字符
  - 不是默认密码
  - 状态: ⏳ 待配置

- [ ] **Redis 密码已配置**
  - 在 `/etc/redis/redis.conf` 中设置 `requirepass`
  - 更新 `REDIS_URL` 包含密码
  - 状态: ⏳ 待配置

- [ ] **.env.production 未提交到 Git**
  - 验证方法:
    ```bash
    git check-ignore .env.production
    # 应该输出: .env.production
    
    git ls-files | grep ".env.production"
    # 应该没有输出
    ```
  - 状态: ⏳ 待验证

### 4. SSL/HTTPS 配置

- [ ] **SSL 证书已安装**
  - 使用 Let's Encrypt 或其他 CA
  - 证书有效期 > 30 天
  - 状态: ⏳ 待配置

- [ ] **强制 HTTPS**
  - HTTP 自动重定向到 HTTPS
  - 验证方法:
    ```bash
    curl -I http://your-domain.com
    # 应该返回 301 重定向到 https://
    ```
  - 状态: ⏳ 待配置

- [ ] **HSTS 已启用**
  - Strict-Transport-Security 头已设置
  - 验证方法:
    ```bash
    curl -I https://your-domain.com | grep "Strict-Transport-Security"
    ```
  - 状态: ⏳ 待验证

- [ ] **SSL 配置评分**
  - 访问: https://www.ssllabs.com/ssltest/
  - 目标评分: A 或 A+
  - 状态: ⏳ 待测试

### 5. 数据库安全

- [ ] **数据库连接使用 SSL**
  - 在 `DATABASE_URL` 中添加 `?ssl=true`
  - 状态: ⏳ 待配置

- [ ] **数据库用户权限最小化**
  - 只授予必要的权限 (SELECT, INSERT, UPDATE, DELETE)
  - 不授予 DROP, CREATE USER 等危险权限
  - 状态: ⏳ 待配置

- [ ] **数据库备份已配置**
  - 每日自动备份
  - 备份文件加密存储
  - 定期测试恢复
  - 状态: ⏳ 待配置

---

## 🟡 第二优先级: 重要安全配置 (强烈建议)

### 6. 文件上传安全

- [ ] **文件类型验证**
  - 检查 `STORAGE_ALLOWED_FILE_TYPES` 配置
  - 只允许必要的文件类型
  - 状态: ⏳ 待验证

- [ ] **文件大小限制**
  - 检查 `UPLOAD_MAX_SIZE` 配置
  - 默认 10MB,根据需求调整
  - 状态: ⏳ 待验证

- [ ] **上传目录权限**
  - 上传目录不可执行
  - 验证方法:
    ```bash
    ls -ld /var/www/uploads
    # 应该是 755 或 750,不是 777
    ```
  - 状态: ⏳ 待配置

### 7. 日志和监控

- [ ] **敏感信息不记录到日志**
  - 密码、密钥、Token 不出现在日志中
  - 检查 `logs/` 目录
  - 状态: ⏳ 待验证

- [ ] **日志级别正确配置**
  - 生产环境使用 `LOG_LEVEL=warn` 或 `error`
  - 不使用 `debug` 或 `info`
  - 状态: ⏳ 待配置

- [ ] **日志轮转已配置**
  - 防止日志文件过大
  - 自动清理旧日志
  - 状态: ⏳ 待配置

- [ ] **错误监控已集成**
  - 推荐: Sentry
  - 实时错误通知
  - 状态: ⏳ 待集成

### 8. 网络安全

- [ ] **防火墙已配置**
  - 只开放必要端口 (80, 443, 22)
  - 数据库端口 (3306) 不对外开放
  - Redis 端口 (6379) 不对外开放
  - 验证方法:
    ```bash
    sudo ufw status
    ```
  - 状态: ⏳ 待配置

- [ ] **SSH 安全配置**
  - 禁用 root 登录
  - 使用密钥认证
  - 修改默认端口 (可选)
  - 状态: ⏳ 待配置

- [ ] **DDoS 防护**
  - 使用 Cloudflare 或其他 CDN
  - 配置速率限制
  - 状态: ⏳ 待配置

### 9. 依赖安全

- [ ] **依赖包已更新**
  - 运行 `npm audit`
  - 修复高危和严重漏洞
  - 验证方法:
    ```bash
    npm audit --production
    ```
  - 状态: ⏳ 待检查

- [ ] **定期安全扫描**
  - 使用 Snyk 或 Dependabot
  - 自动检测漏洞
  - 状态: ⏳ 待配置

---

## 🟢 第三优先级: 最佳实践 (建议完成)

### 10. 性能和可用性

- [ ] **CDN 已配置**
  - 静态资源通过 CDN 分发
  - 减少服务器负载
  - 状态: ⏳ 待配置

- [ ] **缓存策略已优化**
  - Redis 缓存正常工作
  - 静态资源缓存时间合理
  - 状态: ⏳ 待优化

- [ ] **负载均衡已配置**
  - PM2 cluster 模式
  - 多实例运行
  - 状态: ⏳ 待配置

### 11. 备份和恢复

- [ ] **数据库备份策略**
  - 每日全量备份
  - 每小时增量备份 (可选)
  - 备份保留 30 天
  - 状态: ⏳ 待配置

- [ ] **文件备份策略**
  - 上传文件定期备份
  - 备份到异地存储
  - 状态: ⏳ 待配置

- [ ] **恢复流程已测试**
  - 定期测试备份恢复
  - 记录恢复时间 (RTO)
  - 状态: ⏳ 待测试

### 12. 合规性

- [ ] **隐私政策已发布**
  - 符合 GDPR/CCPA 要求 (如适用)
  - 用户数据处理透明
  - 状态: ⏳ 待发布

- [ ] **用户数据加密**
  - 敏感数据加密存储
  - 使用 `STORAGE_ENCRYPTION_KEY`
  - 状态: ⏳ 待验证

- [ ] **审计日志**
  - 记录关键操作 (登录、删除、修改设置)
  - 日志不可篡改
  - 状态: ⏳ 待配置

---

## 📊 安全评分

根据完成情况计算安全评分:

| 优先级 | 总项数 | 已完成 | 完成率 | 权重 |
|--------|--------|--------|--------|------|
| 🔴 第一优先级 | 20 | 4 | 20% | 50% |
| 🟡 第二优先级 | 15 | 0 | 0% | 30% |
| 🟢 第三优先级 | 10 | 0 | 0% | 20% |

**当前安全评分**: 10/100

**目标安全评分**: 
- 最小可行部署: 80/100 (完成所有第一优先级)
- 推荐部署: 90/100 (完成第一、第二优先级)
- 最佳实践: 95/100 (完成所有项目)

---

## 🔍 验证脚本

创建 `scripts/security-check.sh`:

```bash
#!/bin/bash

echo "=== 生产环境安全检查 ==="
echo ""

# 1. 检查环境变量
echo "1. 检查环境变量..."
if [ -f .env.production ]; then
    echo "✅ .env.production 存在"
    
    # 检查关键配置
    if grep -q "inventory-management-secret-key-for-development" .env.production; then
        echo "❌ NEXTAUTH_SECRET 仍使用开发环境密钥!"
    else
        echo "✅ NEXTAUTH_SECRET 已更新"
    fi
    
    if grep -q "dev-storage-encryption-key" .env.production; then
        echo "❌ STORAGE_ENCRYPTION_KEY 仍使用开发环境密钥!"
    else
        echo "✅ STORAGE_ENCRYPTION_KEY 已更新"
    fi
else
    echo "❌ .env.production 不存在!"
fi
echo ""

# 2. 检查 Git 忽略
echo "2. 检查 Git 配置..."
if git check-ignore .env.production > /dev/null 2>&1; then
    echo "✅ .env.production 已在 .gitignore 中"
else
    echo "❌ .env.production 未在 .gitignore 中!"
fi
echo ""

# 3. 检查认证绕过
echo "3. 检查认证绕过..."
if grep -q "if (env.NODE_ENV === 'development')" lib/api/middleware.ts; then
    echo "❌ 发现开发环境认证绕过!"
else
    echo "✅ 未发现开发环境认证绕过"
fi
echo ""

# 4. 检查安全头
echo "4. 检查安全头配置..."
if grep -q "Content-Security-Policy" middleware.ts; then
    echo "✅ CSP 已配置"
else
    echo "❌ CSP 未配置!"
fi
echo ""

# 5. 检查依赖漏洞
echo "5. 检查依赖漏洞..."
npm audit --production --audit-level=high
echo ""

echo "=== 检查完成 ==="
```

使用方法:

```bash
chmod +x scripts/security-check.sh
./scripts/security-check.sh
```

---

## 📝 部署前最终检查

在部署到生产环境前,请确认:

### ✅ 代码质量
- [ ] 所有 TypeScript 错误已修复
- [ ] 所有 ESLint Error 已修复
- [ ] 代码已通过 Prettier 格式化
- [ ] 所有测试通过

### ✅ 安全配置
- [ ] 所有第一优先级项目已完成
- [ ] 密钥已更新为强密钥
- [ ] SSL 证书已配置
- [ ] 安全头已正确设置

### ✅ 环境配置
- [ ] .env.production 已创建并配置
- [ ] 数据库已创建并迁移
- [ ] Redis 已安装并配置
- [ ] Nginx 已配置

### ✅ 测试验证
- [ ] 本地生产构建测试通过
- [ ] 功能测试通过
- [ ] 性能测试通过
- [ ] 安全测试通过

---

## 🚨 紧急联系

如果发现安全问题:

1. **立即停止服务**
   ```bash
   pm2 stop all
   ```

2. **评估影响范围**
   - 检查日志
   - 检查数据库
   - 检查用户数据

3. **修复问题**
   - 更新代码
   - 更新配置
   - 重新部署

4. **通知用户** (如需要)
   - 发送安全通知
   - 建议用户修改密码

---

## 📚 参考资源

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Next.js Security Best Practices](https://nextjs.org/docs/app/building-your-application/configuring/security)
- [Node.js Security Best Practices](https://nodejs.org/en/docs/guides/security/)
- [Prisma Security Best Practices](https://www.prisma.io/docs/guides/security)

---

**最后更新**: 2025-10-02
**下次审查**: 2025-11-02 (每月审查一次)

