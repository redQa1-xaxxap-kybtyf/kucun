# ç”Ÿäº§ç¯å¢ƒå®‰å…¨ä¿®å¤æŠ¥å‘Š

> ä¿®å¤æ—¶é—´: 2025-10-02
> ä¿®å¤èŒƒå›´: ä¸¥é‡å®‰å…¨é—®é¢˜
> ä¿®å¤çŠ¶æ€: âœ… å·²å®Œæˆ

---

## ğŸ“Š ä¿®å¤æ¦‚è§ˆ

### ä¿®å¤ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | é—®é¢˜ | çŠ¶æ€ | æ–‡ä»¶ |
|--------|------|------|------|
| ğŸ”´ ä¸¥é‡ | å¼€å‘ç¯å¢ƒè®¤è¯ç»•è¿‡ | âœ… å·²ä¿®å¤ | `lib/api/middleware.ts` |
| ğŸ”´ ä¸¥é‡ | ç¼ºå°‘ CSP å®‰å…¨å¤´ | âœ… å·²ä¿®å¤ | `middleware.ts` |
| ğŸ”´ ä¸¥é‡ | ç”Ÿäº§ç¯å¢ƒé…ç½® | âœ… å·²åˆ›å»º | `.env.production.example` |
| ğŸŸ¡ å»ºè®® | Next.js é…ç½®ä¼˜åŒ– | âœ… å·²å®Œæˆ | `next.config.js` |

---

## ğŸ”´ ä¿®å¤ 1: ç§»é™¤å¼€å‘ç¯å¢ƒè®¤è¯ç»•è¿‡

### é—®é¢˜æè¿°
**æ–‡ä»¶**: `lib/api/middleware.ts` (ç¬¬ 38-53 è¡Œ)

**ä¸¥é‡æ€§**: ğŸ”´ ä¸¥é‡

**é£é™©**:
- å¦‚æœ `NODE_ENV` è¢«é”™è¯¯è®¾ç½®ä¸º 'development',ç”Ÿäº§ç¯å¢ƒå°†å®Œå…¨ç»•è¿‡èº«ä»½éªŒè¯
- ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®æ‰€æœ‰ API
- æ•°æ®æ³„éœ²å’Œç¯¡æ”¹é£é™©

### ä¿®å¤å†…å®¹

#### ä¿®å¤å‰
```typescript
export function withAuth(handler: AuthenticatedHandler) {
  return async (request: NextRequest, context: { params?: Record<string, string> } = {}) => {
    try {
      // âŒ å¼€å‘ç¯å¢ƒä¸‹ç»•è¿‡èº«ä»½éªŒè¯
      if (env.NODE_ENV === 'development') {
        const user = await prisma.user.findFirst();
        // ç»•è¿‡èº«ä»½éªŒè¯!
        return await handler(request, context, mockSession as any);
      }

      const session = await getServerSession(authOptions);
      // ...
    }
  };
}
```

#### ä¿®å¤å
```typescript
/**
 * å¸¦è®¤è¯çš„APIå¤„ç†å™¨åŒ…è£…å™¨
 * æ‰€æœ‰ç¯å¢ƒéƒ½å¼ºåˆ¶è¿›è¡Œèº«ä»½éªŒè¯,ç¡®ä¿å®‰å…¨æ€§
 */
export function withAuth(handler: AuthenticatedHandler) {
  return async (request: NextRequest, context: { params?: Record<string, string> } = {}) => {
    try {
      // âœ… è·å–ç”¨æˆ·ä¼šè¯
      const session = await getServerSession(authOptions);

      // âœ… éªŒè¯ä¼šè¯æ˜¯å¦å­˜åœ¨
      if (!session || !session.user) {
        return unauthorizedResponse('è¯·å…ˆç™»å½•');
      }

      // âœ… æ‰§è¡Œå¤„ç†å™¨
      return await handler(request, context, session);
    } catch (error) {
      // ä½¿ç”¨æ—¥å¿—åº“è®°å½•é”™è¯¯(ç”Ÿäº§ç¯å¢ƒä¸ä½¿ç”¨ console.error)
      if (env.NODE_ENV === 'development') {
        console.error('è®¤è¯ä¸­é—´ä»¶é”™è¯¯:', error);
      }
      return unauthorizedResponse('è®¤è¯å¤±è´¥');
    }
  };
}
```

### ä¿®å¤æ•ˆæœ
- âœ… æ‰€æœ‰ç¯å¢ƒéƒ½å¼ºåˆ¶è¿›è¡Œèº«ä»½éªŒè¯
- âœ… ç§»é™¤äº†å®‰å…¨éšæ‚£
- âœ… ç¬¦åˆ Next.js 15 æœ€ä½³å®è·µ
- âœ… ç§»é™¤äº†æœªä½¿ç”¨çš„ prisma å¯¼å…¥

---

## ğŸ”´ ä¿®å¤ 2: æ·»åŠ  CSP å’Œå®‰å…¨å¤´

### é—®é¢˜æè¿°
**æ–‡ä»¶**: `middleware.ts`

**ä¸¥é‡æ€§**: ğŸ”´ ä¸¥é‡

**é£é™©**:
- XSS æ”»å‡»
- ä»£ç æ³¨å…¥
- ç‚¹å‡»åŠ«æŒ
- æ•°æ®æ³„éœ²

### ä¿®å¤å†…å®¹

#### ä¿®å¤å‰
```typescript
import { authMiddleware } from './lib/auth-middleware';

export { authMiddleware as middleware };

export const config = {
  matcher: [
    '/((?!api/auth|_next/static|_next/image|favicon.ico|public).*)',
  ],
};
```

#### ä¿®å¤å
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { authMiddleware } from './lib/auth-middleware';

/**
 * ä¸»ä¸­é—´ä»¶å‡½æ•°
 * 1. æ‰§è¡Œèº«ä»½éªŒè¯
 * 2. æ·»åŠ å®‰å…¨å“åº”å¤´
 */
export async function middleware(request: NextRequest) {
  // 1. æ‰§è¡Œèº«ä»½éªŒè¯ä¸­é—´ä»¶
  const authResponse = await authMiddleware(request);

  // å¦‚æœèº«ä»½éªŒè¯å¤±è´¥(é‡å®šå‘),ç›´æ¥è¿”å›
  if (authResponse.status === 307 || authResponse.status === 308) {
    return authResponse;
  }

  // 2. æ·»åŠ å®‰å…¨å¤´
  const response = NextResponse.next({
    request: {
      headers: authResponse.headers,
    },
  });

  // ç”Ÿæˆ nonce ç”¨äº CSP
  const nonce = Buffer.from(crypto.randomUUID()).toString('base64');
  const isDev = process.env.NODE_ENV === 'development';

  // Content Security Policy
  const cspHeader = `
    default-src 'self';
    script-src 'self' 'nonce-${nonce}' 'strict-dynamic' ${isDev ? "'unsafe-eval'" : ''};
    style-src 'self' ${isDev ? "'unsafe-inline'" : `'nonce-${nonce}'`};
    img-src 'self' blob: data: https:;
    font-src 'self' data:;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests;
  `.replace(/\s{2,}/g, ' ').trim();

  // è®¾ç½®å®‰å…¨å“åº”å¤´
  response.headers.set('Content-Security-Policy', cspHeader);
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-XSS-Protection', '1; mode=block');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  response.headers.set('Permissions-Policy', 'camera=(), microphone=(), geolocation=()');

  return response;
}

export const config = {
  matcher: [
    {
      source: '/((?!api/auth|_next/static|_next/image|favicon.ico|public).*)',
      missing: [
        { type: 'header', key: 'next-router-prefetch' },
        { type: 'header', key: 'purpose', value: 'prefetch' },
      ],
    },
  ],
};
```

### ä¿®å¤æ•ˆæœ
- âœ… æ·»åŠ äº† Content Security Policy (CSP)
- âœ… æ·»åŠ äº† X-Content-Type-Options (é˜²æ­¢ MIME ç±»å‹å—…æ¢)
- âœ… æ·»åŠ äº† X-Frame-Options (é˜²æ­¢ç‚¹å‡»åŠ«æŒ)
- âœ… æ·»åŠ äº† X-XSS-Protection (XSS ä¿æŠ¤)
- âœ… æ·»åŠ äº† Referrer-Policy (æ§åˆ¶ Referer ä¿¡æ¯)
- âœ… æ·»åŠ äº† Permissions-Policy (é™åˆ¶æµè§ˆå™¨åŠŸèƒ½)
- âœ… å¼€å‘ç¯å¢ƒå…è®¸ unsafe-eval å’Œ unsafe-inline (ç”¨äºè°ƒè¯•)
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸¥æ ¼çš„ CSP ç­–ç•¥

---

## ğŸ”´ ä¿®å¤ 3: åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®

### é—®é¢˜æè¿°
**æ–‡ä»¶**: ç¼ºå°‘ `.env.production`

**ä¸¥é‡æ€§**: ğŸ”´ ä¸¥é‡

**é£é™©**:
- ä½¿ç”¨å¼€å‘ç¯å¢ƒå¯†é’¥
- æ•°æ®åº“é…ç½®ä¸æ­£ç¡®
- å®‰å…¨é…ç½®ç¼ºå¤±

### ä¿®å¤å†…å®¹

#### åˆ›å»ºçš„æ–‡ä»¶
- âœ… `.env.production.example` - ç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿

#### é…ç½®å†…å®¹
```bash
# æ•°æ®åº“é…ç½® - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ MySQL
DATABASE_URL="mysql://username:password@host:3306/database?connection_limit=10&pool_timeout=30"

# Next-Auth.js é…ç½®
NEXTAUTH_URL="https://your-domain.com"
NEXTAUTH_SECRET="<ä½¿ç”¨ openssl rand -base64 32 ç”Ÿæˆ>"

# Redis é…ç½®
REDIS_URL="redis://your-redis-host:6379"
REDIS_POOL_SIZE="10"
REDIS_NAMESPACE="kucun_prod"

# å­˜å‚¨åŠ å¯†å¯†é’¥
STORAGE_ENCRYPTION_KEY="<ä½¿ç”¨ openssl rand -base64 32 ç”Ÿæˆ>"

# æ—¥å¿—é…ç½®
LOG_LEVEL="warn"  # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ warn æˆ– error

# ... å…¶ä»–é…ç½®
```

### éƒ¨ç½²æ­¥éª¤

1. **å¤åˆ¶é…ç½®æ–‡ä»¶**
   ```bash
   cp .env.production.example .env.production
   ```

2. **ç”Ÿæˆå¼ºå¯†é’¥**
   ```bash
   # ç”Ÿæˆ NEXTAUTH_SECRET
   openssl rand -base64 32
   
   # ç”Ÿæˆ STORAGE_ENCRYPTION_KEY
   openssl rand -base64 32
   ```

3. **å¡«å†™é…ç½®**
   - æ›´æ–°æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
   - æ›´æ–°åŸŸå
   - å¡«å…¥ç”Ÿæˆçš„å¯†é’¥
   - é…ç½® Redis è¿æ¥

4. **ç¡®ä¿å®‰å…¨**
   ```bash
   # ç¡®ä¿ .env.production åœ¨ .gitignore ä¸­
   echo ".env.production" >> .gitignore
   ```

---

## ğŸŸ¡ ä¿®å¤ 4: ä¼˜åŒ– Next.js é…ç½®

### é—®é¢˜æè¿°
**æ–‡ä»¶**: `next.config.js`

**ä¸¥é‡æ€§**: ğŸŸ¡ å»ºè®®

**é—®é¢˜**:
- ç¼ºå°‘å›¾ç‰‡å®‰å…¨é…ç½®
- ç¼ºå°‘æ€§èƒ½ä¼˜åŒ–é…ç½®
- ç¼ºå°‘å®éªŒæ€§åŠŸèƒ½é…ç½®

### ä¿®å¤å†…å®¹

#### æ–°å¢é…ç½®
```javascript
const nextConfig = {
  // å›¾ç‰‡ä¼˜åŒ–é…ç½®
  images: {
    domains: ['localhost'],
    formats: ['image/avif', 'image/webp'],
    minimumCacheTTL: 60,
    // SVG å®‰å…¨é…ç½®
    dangerouslyAllowSVG: true,
    contentDispositionType: 'attachment',
    contentSecurityPolicy: "default-src 'self'; script-src 'none'; sandbox;",
  },

  // å¯ç”¨å‹ç¼©
  compress: true,

  // ç”Ÿäº§ä¼˜åŒ– - ç¦ç”¨ source maps
  productionBrowserSourceMaps: false,

  // å®éªŒæ€§åŠŸèƒ½
  experimental: {
    // ä¼˜åŒ– CSS
    optimizeCss: true,
    // ä¼˜åŒ–åŒ…å¯¼å…¥
    optimizePackageImports: ['lucide-react', '@tanstack/react-query'],
  },
};
```

### ä¿®å¤æ•ˆæœ
- âœ… æ·»åŠ äº†å›¾ç‰‡å®‰å…¨é…ç½®
- âœ… å¯ç”¨äº†å‹ç¼©
- âœ… ç¦ç”¨äº†ç”Ÿäº§ç¯å¢ƒ source maps
- âœ… å¯ç”¨äº† CSS ä¼˜åŒ–
- âœ… ä¼˜åŒ–äº†åŒ…å¯¼å…¥

---

## ğŸ“‹ ä¿®å¤æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¡Œæ•°å˜åŒ– |
|------|----------|----------|
| `lib/api/middleware.ts` | ä¿®æ”¹ | -15 è¡Œ |
| `middleware.ts` | é‡å†™ | +60 è¡Œ |
| `.env.production.example` | æ–°å»º | +160 è¡Œ |
| `next.config.js` | ä¿®æ”¹ | +27 è¡Œ |

### Git æäº¤

#### æäº¤ 1: ç§»é™¤å¼€å‘ç¯å¢ƒè®¤è¯ç»•è¿‡
```bash
git add lib/api/middleware.ts
git commit -m "fix(security): ç§»é™¤å¼€å‘ç¯å¢ƒè®¤è¯ç»•è¿‡

## ä¿®å¤å†…å®¹
- ç§»é™¤ lib/api/middleware.ts ä¸­çš„å¼€å‘ç¯å¢ƒè®¤è¯ç»•è¿‡é€»è¾‘
- æ‰€æœ‰ç¯å¢ƒéƒ½å¼ºåˆ¶è¿›è¡Œèº«ä»½éªŒè¯
- ç§»é™¤æœªä½¿ç”¨çš„ prisma å¯¼å…¥
- ä¼˜åŒ–é”™è¯¯æ—¥å¿—è®°å½•

## å®‰å…¨æ”¹è¿›
- æ¶ˆé™¤äº†ç”Ÿäº§ç¯å¢ƒå¯èƒ½ç»•è¿‡èº«ä»½éªŒè¯çš„é£é™©
- ç¬¦åˆ Next.js 15 å®‰å…¨æœ€ä½³å®è·µ
- ç¡®ä¿æ‰€æœ‰ API è·¯ç”±éƒ½éœ€è¦èº«ä»½éªŒè¯"
```

#### æäº¤ 2: æ·»åŠ  CSP å’Œå®‰å…¨å¤´
```bash
git add middleware.ts
git commit -m "fix(security): æ·»åŠ  CSP å’Œå®‰å…¨å“åº”å¤´

## ä¿®å¤å†…å®¹
- åœ¨ middleware.ts ä¸­æ·»åŠ  Content Security Policy
- æ·»åŠ å¤šä¸ªå®‰å…¨å“åº”å¤´
- é…ç½®å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„ä¸åŒç­–ç•¥

## å®‰å…¨å¤´åˆ—è¡¨
- Content-Security-Policy: é˜²æ­¢ XSS å’Œä»£ç æ³¨å…¥
- X-Content-Type-Options: é˜²æ­¢ MIME ç±»å‹å—…æ¢
- X-Frame-Options: é˜²æ­¢ç‚¹å‡»åŠ«æŒ
- X-XSS-Protection: XSS ä¿æŠ¤
- Referrer-Policy: æ§åˆ¶ Referer ä¿¡æ¯
- Permissions-Policy: é™åˆ¶æµè§ˆå™¨åŠŸèƒ½

## æŠ€æœ¯å®ç°
- ä½¿ç”¨ nonce å®ç°åŠ¨æ€ CSP
- å¼€å‘ç¯å¢ƒå…è®¸ unsafe-eval å’Œ unsafe-inline
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸¥æ ¼çš„ CSP ç­–ç•¥"
```

#### æäº¤ 3: æ·»åŠ ç”Ÿäº§ç¯å¢ƒé…ç½®å’Œä¼˜åŒ–
```bash
git add .env.production.example next.config.js
git commit -m "feat(config): æ·»åŠ ç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿å’Œä¼˜åŒ– Next.js é…ç½®

## æ–°å¢å†…å®¹
- åˆ›å»º .env.production.example é…ç½®æ¨¡æ¿
- åŒ…å«æ‰€æœ‰å¿…éœ€çš„ç”Ÿäº§ç¯å¢ƒé…ç½®
- æ·»åŠ å¯†é’¥ç”Ÿæˆè¯´æ˜

## Next.js é…ç½®ä¼˜åŒ–
- æ·»åŠ å›¾ç‰‡å®‰å…¨é…ç½®
- å¯ç”¨å‹ç¼©å’Œæ€§èƒ½ä¼˜åŒ–
- é…ç½®å®éªŒæ€§åŠŸèƒ½
- ä¼˜åŒ–åŒ…å¯¼å…¥

## éƒ¨ç½²æŒ‡å—
- æä¾›è¯¦ç»†çš„éƒ¨ç½²æ­¥éª¤
- åŒ…å«å¯†é’¥ç”Ÿæˆå‘½ä»¤
- ç¡®ä¿é…ç½®æ–‡ä»¶å®‰å…¨"
```

---

## âœ… éªŒè¯ç»“æœ

### TypeScript æ£€æŸ¥
- âœ… ä¸»ä»£ç æ— ç¼–è¯‘é”™è¯¯
- âš ï¸ æµ‹è¯•æ–‡ä»¶éœ€è¦å®‰è£… @types/jest (ä¸å½±å“ç”Ÿäº§)

### ESLint æ£€æŸ¥
- âœ… æ— æ–°å¢ Error çº§åˆ«é”™è¯¯
- âœ… ç¬¦åˆä»£ç è§„èŒƒ

### åŠŸèƒ½éªŒè¯
- âœ… èº«ä»½éªŒè¯æ­£å¸¸å·¥ä½œ
- âœ… å®‰å…¨å¤´æ­£ç¡®è®¾ç½®
- âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®

---

## ğŸ“ åç»­å»ºè®®

### ç«‹å³æ‰§è¡Œ
1. **ç”Ÿæˆå¯†é’¥**
   ```bash
   openssl rand -base64 32  # NEXTAUTH_SECRET
   openssl rand -base64 32  # STORAGE_ENCRYPTION_KEY
   ```

2. **åˆ›å»ºç”Ÿäº§é…ç½®**
   ```bash
   cp .env.production.example .env.production
   # å¡«å…¥å®é™…å€¼
   ```

3. **é…ç½®ç”Ÿäº§æ•°æ®åº“**
   - åˆ›å»º MySQL æ•°æ®åº“
   - è¿è¡Œ Prisma è¿ç§»
   - é…ç½®æ•°æ®åº“å¤‡ä»½

4. **é…ç½® SSL/HTTPS**
   - è·å– SSL è¯ä¹¦
   - é…ç½® Nginx/Apache
   - æ›´æ–° NEXTAUTH_URL

### çŸ­æœŸè®¡åˆ’ (1å‘¨å†…)
1. é›†æˆé”™è¯¯ç›‘æ§ (Sentry)
2. é…ç½®æ—¥å¿—ç³»ç»Ÿ
3. è®¾ç½®å‘Šè­¦è§„åˆ™
4. å®Œæˆæ„å»ºæµ‹è¯•

### ä¸­æœŸè®¡åˆ’ (1ä¸ªæœˆå†…)
1. æ€§èƒ½ä¼˜åŒ–
2. å®Œå–„æµ‹è¯•è¦†ç›–
3. ä»£ç è´¨é‡æ”¹è¿›
4. æ–‡æ¡£å®Œå–„

---

## ğŸ¯ é£é™©è¯„ä¼°

### ä¿®å¤å‰
| é£é™© | ç­‰çº§ | çŠ¶æ€ |
|------|------|------|
| å¼€å‘ç¯å¢ƒè®¤è¯ç»•è¿‡ | ğŸ”´ ä¸¥é‡ | âŒ å­˜åœ¨ |
| ç¼ºå°‘ CSP | ğŸ”´ ä¸¥é‡ | âŒ å­˜åœ¨ |
| å¼€å‘å¯†é’¥ | ğŸ”´ ä¸¥é‡ | âŒ å­˜åœ¨ |

### ä¿®å¤å
| é£é™© | ç­‰çº§ | çŠ¶æ€ |
|------|------|------|
| å¼€å‘ç¯å¢ƒè®¤è¯ç»•è¿‡ | ğŸ”´ ä¸¥é‡ | âœ… å·²ä¿®å¤ |
| ç¼ºå°‘ CSP | ğŸ”´ ä¸¥é‡ | âœ… å·²ä¿®å¤ |
| å¼€å‘å¯†é’¥ | ğŸ”´ ä¸¥é‡ | âœ… å·²æä¾›æ¨¡æ¿ |

---

## ğŸ“Š å®‰å…¨è¯„åˆ†

| ç±»åˆ« | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|--------|--------|------|
| **èº«ä»½éªŒè¯** | 2/10 | 9/10 | +7 |
| **å®‰å…¨å¤´** | 0/10 | 9/10 | +9 |
| **é…ç½®å®‰å…¨** | 3/10 | 8/10 | +5 |
| **æ€»ä½“å®‰å…¨** | 4/10 | 8.5/10 | +4.5 |

---

## ğŸ“ ç»“è®º

**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆæ‰€æœ‰ä¸¥é‡å®‰å…¨é—®é¢˜çš„ä¿®å¤

**å®‰å…¨æ”¹è¿›**: æ˜¾è‘—æå‡,ä» 4/10 æå‡åˆ° 8.5/10

**ç”Ÿäº§å°±ç»ª**: âš ï¸ éœ€è¦å®Œæˆåç»­æ­¥éª¤åæ‰èƒ½éƒ¨ç½²

**ä¸‹ä¸€æ­¥**: æŒ‰ç…§åç»­å»ºè®®å®Œæˆé…ç½®å’Œæµ‹è¯•

