# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

> ç‰ˆæœ¬: 1.0.0
> æ›´æ–°æ—¶é—´: 2025-10-02
> é€‚ç”¨é¡¹ç›®: åº“å­˜ç®¡ç†ç³»ç»Ÿ

---

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### âœ… ä»£ç è´¨é‡æ£€æŸ¥
- [x] ç§»é™¤å¼€å‘ç¯å¢ƒè®¤è¯ç»•è¿‡
- [x] æ·»åŠ  CSP å’Œå®‰å…¨å“åº”å¤´
- [x] åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿
- [x] ä¼˜åŒ– Next.js é…ç½®
- [ ] ä¿®å¤å‰©ä½™çš„ TypeScript é”™è¯¯
- [ ] ä¿®å¤å‰©ä½™çš„ ESLint Warning

### âœ… ç¯å¢ƒå‡†å¤‡
- [ ] ç”Ÿäº§æœåŠ¡å™¨å·²å‡†å¤‡
- [ ] MySQL æ•°æ®åº“å·²åˆ›å»º
- [ ] Redis æœåŠ¡å·²å®‰è£…
- [ ] Node.js 18+ å·²å®‰è£…
- [ ] PM2 è¿›ç¨‹ç®¡ç†å™¨å·²å®‰è£…
- [ ] Nginx/Apache å·²é…ç½®
- [ ] SSL è¯ä¹¦å·²è·å–

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µ: ç¯å¢ƒé…ç½® (é¢„è®¡ 2-3 å°æ—¶)

#### 1. ç”Ÿæˆå¼ºå¯†é’¥

```bash
# ç”Ÿæˆ NEXTAUTH_SECRET (è‡³å°‘ 32 å­—ç¬¦)
openssl rand -base64 32

# ç”Ÿæˆ STORAGE_ENCRYPTION_KEY (è‡³å°‘ 32 å­—ç¬¦)
openssl rand -base64 32

# ä¿å­˜è¿™äº›å¯†é’¥,ç¨åä¼šç”¨åˆ°
```

**é‡è¦**: è¯·å°†ç”Ÿæˆçš„å¯†é’¥ä¿å­˜åˆ°å®‰å…¨çš„åœ°æ–¹,ä¸è¦æ³„éœ²!

#### 2. åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®

```bash
# å¤åˆ¶é…ç½®æ¨¡æ¿
cp .env.production.example .env.production

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano .env.production  # æˆ–ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨
```

**å¿…é¡»ä¿®æ”¹çš„é…ç½®é¡¹**:

```bash
# æ•°æ®åº“é…ç½® - ä½¿ç”¨ç”Ÿäº§ MySQL æ•°æ®åº“
DATABASE_URL="mysql://username:password@host:3306/database?connection_limit=10&pool_timeout=30"

# Next-Auth.js é…ç½®
NEXTAUTH_URL="https://your-domain.com"  # æ›¿æ¢ä¸ºå®é™…åŸŸå
NEXTAUTH_SECRET="<ç²˜è´´ç¬¬1æ­¥ç”Ÿæˆçš„å¯†é’¥>"

# Redis é…ç½®
REDIS_URL="redis://your-redis-host:6379"  # æ›¿æ¢ä¸ºå®é™… Redis åœ°å€
REDIS_POOL_SIZE="10"
REDIS_NAMESPACE="kucun_prod"

# WebSocket é…ç½®
WS_PORT="3002"
WS_ALLOWED_ORIGINS="https://your-domain.com"  # æ›¿æ¢ä¸ºå®é™…åŸŸå
NEXT_PUBLIC_WS_PORT="3002"

# åº”ç”¨é…ç½®
NODE_ENV="production"
PORT="3000"

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_DIR="/var/www/uploads"  # ç¡®ä¿ç›®å½•å­˜åœ¨ä¸”æœ‰å†™æƒé™
UPLOAD_MAX_SIZE="10485760"

# å­˜å‚¨åŠ å¯†å¯†é’¥
STORAGE_ENCRYPTION_KEY="<ç²˜è´´ç¬¬1æ­¥ç”Ÿæˆçš„å¯†é’¥>"
STORAGE_REGION="z0"

# æ—¥å¿—é…ç½®
LOG_LEVEL="warn"  # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ warn æˆ– error
```

#### 3. ç¡®ä¿é…ç½®æ–‡ä»¶å®‰å…¨

```bash
# ç¡®ä¿ .env.production ä¸ä¼šè¢«æäº¤åˆ° Git
echo ".env.production" >> .gitignore

# è®¾ç½®æ–‡ä»¶æƒé™ (ä»…æ‰€æœ‰è€…å¯è¯»å†™)
chmod 600 .env.production

# éªŒè¯ .gitignore
git check-ignore .env.production
# åº”è¯¥è¾“å‡º: .env.production
```

#### 4. é…ç½®ç”Ÿäº§æ•°æ®åº“

```bash
# è¿æ¥åˆ° MySQL æœåŠ¡å™¨
mysql -u root -p

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE kucun_prod CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# åˆ›å»ºæ•°æ®åº“ç”¨æˆ·
CREATE USER 'kucun_user'@'localhost' IDENTIFIED BY 'strong_password';

# æˆäºˆæƒé™
GRANT ALL PRIVILEGES ON kucun_prod.* TO 'kucun_user'@'localhost';
FLUSH PRIVILEGES;

# é€€å‡º
EXIT;
```

#### 5. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# ç”Ÿæˆ Prisma Client
npx prisma generate

# è¿è¡Œè¿ç§»
npx prisma migrate deploy

# éªŒè¯è¿ç§»
npx prisma migrate status

# (å¯é€‰) æŸ¥çœ‹æ•°æ®åº“ç»“æ„
npx prisma studio
```

#### 6. é…ç½® Redis

```bash
# å®‰è£… Redis (å¦‚æœæœªå®‰è£…)
# Ubuntu/Debian:
sudo apt-get install redis-server

# CentOS/RHEL:
sudo yum install redis

# å¯åŠ¨ Redis
sudo systemctl start redis
sudo systemctl enable redis

# éªŒè¯ Redis è¿æ¥
redis-cli ping
# åº”è¯¥è¿”å›: PONG

# é…ç½® Redis å¯†ç  (æ¨è)
sudo nano /etc/redis/redis.conf
# æ‰¾åˆ°å¹¶å–æ¶ˆæ³¨é‡Š: requirepass your_strong_password

# é‡å¯ Redis
sudo systemctl restart redis

# æ›´æ–° .env.production ä¸­çš„ REDIS_URL
# REDIS_URL="redis://:your_strong_password@localhost:6379"
```

---

### ç¬¬äºŒé˜¶æ®µ: æ„å»ºå’Œæµ‹è¯• (é¢„è®¡ 1-2 å°æ—¶)

#### 7. å®‰è£…ä¾èµ–

```bash
# æ¸…ç†æ—§çš„ä¾èµ–
rm -rf node_modules package-lock.json

# å®‰è£…ç”Ÿäº§ä¾èµ–
npm ci --production=false

# éªŒè¯ä¾èµ–
npm list --depth=0
```

#### 8. è¿è¡Œä»£ç æ£€æŸ¥

```bash
# TypeScript æ£€æŸ¥
npm run type-check

# ESLint æ£€æŸ¥
npm run lint

# æ ¼å¼åŒ–ä»£ç 
npm run format
```

**æ³¨æ„**: å¦‚æœæœ‰é”™è¯¯,è¯·å…ˆä¿®å¤åå†ç»§ç»­ã€‚

#### 9. æ„å»ºç”Ÿäº§ç‰ˆæœ¬

```bash
# æ„å»º Next.js åº”ç”¨
npm run build

# æ£€æŸ¥æ„å»ºè¾“å‡º
ls -lh .next/

# éªŒè¯æ„å»ºæˆåŠŸ
# åº”è¯¥çœ‹åˆ° .next/standalone ç›®å½•
```

#### 10. æœ¬åœ°æµ‹è¯•ç”Ÿäº§æ„å»º

```bash
# å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
npm start

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æµ‹è¯•
curl http://localhost:3000

# æµ‹è¯• API
curl http://localhost:3000/api/health

# æµ‹è¯•å®Œæˆååœæ­¢æœåŠ¡å™¨ (Ctrl+C)
```

---

### ç¬¬ä¸‰é˜¶æ®µ: æœåŠ¡å™¨éƒ¨ç½² (é¢„è®¡ 2-3 å°æ—¶)

#### 11. é…ç½® PM2

åˆ›å»º `ecosystem.config.js`:

```javascript
module.exports = {
  apps: [
    {
      name: 'kucun',
      script: 'node_modules/next/dist/bin/next',
      args: 'start',
      instances: 'max',
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3000,
      },
      error_file: './logs/err.log',
      out_file: './logs/out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      merge_logs: true,
      max_memory_restart: '1G',
    },
    {
      name: 'kucun-ws',
      script: 'lib/ws/ws-server.ts',
      interpreter: 'node',
      interpreter_args: '--loader ts-node/esm',
      instances: 1,
      exec_mode: 'fork',
      env: {
        NODE_ENV: 'production',
        WS_PORT: 3002,
      },
      error_file: './logs/ws-err.log',
      out_file: './logs/ws-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    },
  ],
};
```

#### 12. åˆ›å»ºæ—¥å¿—ç›®å½•

```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# è®¾ç½®æƒé™
chmod 755 logs
```

#### 13. å¯åŠ¨åº”ç”¨

```bash
# ä½¿ç”¨ PM2 å¯åŠ¨
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs kucun

# ä¿å­˜ PM2 é…ç½®
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
# æŒ‰ç…§æç¤ºæ‰§è¡Œå‘½ä»¤
```

#### 14. é…ç½® Nginx åå‘ä»£ç†

åˆ›å»º `/etc/nginx/sites-available/kucun`:

```nginx
# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS é…ç½®
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSL è¯ä¹¦
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # SSL é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # å®‰å…¨å¤´ (Next.js middleware å·²è®¾ç½®,è¿™é‡Œä½œä¸ºå¤‡ä»½)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;

    # æ—¥å¿—
    access_log /var/log/nginx/kucun-access.log;
    error_log /var/log/nginx/kucun-error.log;

    # Next.js åº”ç”¨
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocket
    location /ws {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # é™æ€æ–‡ä»¶ç¼“å­˜
    location /_next/static {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, max-age=3600, immutable";
    }

    # ä¸Šä¼ æ–‡ä»¶
    location /uploads {
        alias /var/www/uploads;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }
}
```

å¯ç”¨é…ç½®:

```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/kucun /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

#### 15. é…ç½® SSL è¯ä¹¦ (Let's Encrypt)

```bash
# å®‰è£… Certbot
sudo apt-get install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# æµ‹è¯•è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run

# è®¾ç½®è‡ªåŠ¨ç»­æœŸ (cron job)
sudo crontab -e
# æ·»åŠ : 0 0 * * * certbot renew --quiet
```

---

### ç¬¬å››é˜¶æ®µ: éªŒè¯å’Œç›‘æ§ (é¢„è®¡ 1 å°æ—¶)

#### 16. åŠŸèƒ½éªŒè¯

```bash
# æµ‹è¯• HTTPS è®¿é—®
curl -I https://your-domain.com

# æµ‹è¯• API
curl https://your-domain.com/api/health

# æµ‹è¯• WebSocket
# ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æµ‹è¯•

# æµ‹è¯•ç™»å½•åŠŸèƒ½
# ä½¿ç”¨æµè§ˆå™¨è®¿é—®å¹¶ç™»å½•
```

#### 17. æ€§èƒ½æµ‹è¯•

```bash
# å®‰è£… Apache Bench (å¦‚æœæœªå®‰è£…)
sudo apt-get install apache2-utils

# å¹¶å‘æµ‹è¯•
ab -n 1000 -c 10 https://your-domain.com/

# æŸ¥çœ‹å“åº”æ—¶é—´
```

#### 18. å®‰å…¨æ£€æŸ¥

```bash
# æ£€æŸ¥å®‰å…¨å¤´
curl -I https://your-domain.com | grep -E "(Content-Security-Policy|X-Frame-Options|X-Content-Type-Options)"

# SSL æµ‹è¯•
# è®¿é—®: https://www.ssllabs.com/ssltest/
# è¾“å…¥åŸŸåè¿›è¡Œæµ‹è¯•,ç›®æ ‡è¯„åˆ†: A+
```

---

## ğŸ“Š éƒ¨ç½²åæ£€æŸ¥æ¸…å•

### âœ… åŠŸèƒ½æ£€æŸ¥
- [ ] ç½‘ç«™å¯ä»¥é€šè¿‡ HTTPS è®¿é—®
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] API æ¥å£æ­£å¸¸å“åº”
- [ ] WebSocket è¿æ¥æ­£å¸¸
- [ ] æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [ ] æ•°æ®åº“è¯»å†™æ­£å¸¸
- [ ] Redis ç¼“å­˜æ­£å¸¸

### âœ… å®‰å…¨æ£€æŸ¥
- [ ] SSL è¯ä¹¦æœ‰æ•ˆ
- [ ] å®‰å…¨å“åº”å¤´æ­£ç¡®è®¾ç½®
- [ ] èº«ä»½éªŒè¯æ­£å¸¸å·¥ä½œ
- [ ] ç¯å¢ƒå˜é‡å·²æ›´æ–°ä¸ºå¼ºå¯†é’¥
- [ ] .env.production æœªæäº¤åˆ° Git
- [ ] æ•°æ®åº“è¿æ¥ä½¿ç”¨å¼ºå¯†ç 

### âœ… æ€§èƒ½æ£€æŸ¥
- [ ] é¡µé¢åŠ è½½æ—¶é—´ < 3ç§’
- [ ] API å“åº”æ—¶é—´ < 500ms
- [ ] é™æ€èµ„æºæ­£ç¡®ç¼“å­˜
- [ ] å›¾ç‰‡æ­£ç¡®ä¼˜åŒ–

### âœ… ç›‘æ§æ£€æŸ¥
- [ ] PM2 è¿›ç¨‹æ­£å¸¸è¿è¡Œ
- [ ] æ—¥å¿—æ­£å¸¸è®°å½•
- [ ] é”™è¯¯ç›‘æ§å·²é…ç½® (å¯é€‰)
- [ ] æ€§èƒ½ç›‘æ§å·²é…ç½® (å¯é€‰)

---

## ğŸ”§ å¸¸ç”¨å‘½ä»¤

### PM2 ç®¡ç†

```bash
# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs kucun
pm2 logs kucun-ws

# é‡å¯åº”ç”¨
pm2 restart kucun
pm2 restart all

# åœæ­¢åº”ç”¨
pm2 stop kucun
pm2 stop all

# åˆ é™¤åº”ç”¨
pm2 delete kucun

# ç›‘æ§
pm2 monit
```

### æ•°æ®åº“ç®¡ç†

```bash
# å¤‡ä»½æ•°æ®åº“
mysqldump -u kucun_user -p kucun_prod > backup_$(date +%Y%m%d).sql

# æ¢å¤æ•°æ®åº“
mysql -u kucun_user -p kucun_prod < backup_20250102.sql

# æŸ¥çœ‹æ•°æ®åº“å¤§å°
mysql -u kucun_user -p -e "SELECT table_schema AS 'Database', ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)' FROM information_schema.TABLES WHERE table_schema = 'kucun_prod';"
```

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/out.log
tail -f logs/err.log

# æŸ¥çœ‹ Nginx æ—¥å¿—
tail -f /var/log/nginx/kucun-access.log
tail -f /var/log/nginx/kucun-error.log

# æ¸…ç†æ—§æ—¥å¿—
find logs/ -name "*.log" -mtime +30 -delete
```

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### åº”ç”¨æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tulpn | grep :3000

# æ£€æŸ¥ç¯å¢ƒå˜é‡
pm2 env kucun

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs kucun --lines 100
```

### æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u kucun_user -p -h localhost kucun_prod

# æ£€æŸ¥ Prisma é…ç½®
npx prisma db pull
```

### Redis è¿æ¥å¤±è´¥

```bash
# æµ‹è¯• Redis è¿æ¥
redis-cli -h localhost -p 6379 ping

# æ£€æŸ¥ Redis çŠ¶æ€
sudo systemctl status redis
```

---

## ğŸ“ ä¸‹ä¸€æ­¥

éƒ¨ç½²å®Œæˆå,å»ºè®®:

1. **é…ç½®ç›‘æ§**: é›†æˆ Sentry æˆ–å…¶ä»–é”™è¯¯ç›‘æ§æœåŠ¡
2. **é…ç½®å¤‡ä»½**: è®¾ç½®è‡ªåŠ¨æ•°æ®åº“å¤‡ä»½
3. **æ€§èƒ½ä¼˜åŒ–**: æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µä¼˜åŒ–é…ç½®
4. **æ–‡æ¡£å®Œå–„**: è®°å½•éƒ¨ç½²è¿‡ç¨‹ä¸­çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

è¯¦è§: `ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ£€æŸ¥æ¸…å•.md`

