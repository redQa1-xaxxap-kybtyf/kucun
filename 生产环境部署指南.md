# 生产环境部署指南

> 版本: 1.0.0
> 更新时间: 2025-10-02
> 适用项目: 库存管理系统

---

## 📋 部署前检查清单

### ✅ 代码质量检查
- [x] 移除开发环境认证绕过
- [x] 添加 CSP 和安全响应头
- [x] 创建生产环境配置模板
- [x] 优化 Next.js 配置
- [ ] 修复剩余的 TypeScript 错误
- [ ] 修复剩余的 ESLint Warning

### ✅ 环境准备
- [ ] 生产服务器已准备
- [ ] MySQL 数据库已创建
- [ ] Redis 服务已安装
- [ ] Node.js 18+ 已安装
- [ ] PM2 进程管理器已安装
- [ ] Nginx/Apache 已配置
- [ ] SSL 证书已获取

---

## 🚀 部署步骤

### 第一阶段: 环境配置 (预计 2-3 小时)

#### 1. 生成强密钥

```bash
# 生成 NEXTAUTH_SECRET (至少 32 字符)
openssl rand -base64 32

# 生成 STORAGE_ENCRYPTION_KEY (至少 32 字符)
openssl rand -base64 32

# 保存这些密钥,稍后会用到
```

**重要**: 请将生成的密钥保存到安全的地方,不要泄露!

#### 2. 创建生产环境配置

```bash
# 复制配置模板
cp .env.production.example .env.production

# 编辑配置文件
nano .env.production  # 或使用其他编辑器
```

**必须修改的配置项**:

```bash
# 数据库配置 - 使用生产 MySQL 数据库
DATABASE_URL="mysql://username:password@host:3306/database?connection_limit=10&pool_timeout=30"

# Next-Auth.js 配置
NEXTAUTH_URL="https://your-domain.com"  # 替换为实际域名
NEXTAUTH_SECRET="<粘贴第1步生成的密钥>"

# Redis 配置
REDIS_URL="redis://your-redis-host:6379"  # 替换为实际 Redis 地址
REDIS_POOL_SIZE="10"
REDIS_NAMESPACE="kucun_prod"

# WebSocket 配置
WS_PORT="3002"
WS_ALLOWED_ORIGINS="https://your-domain.com"  # 替换为实际域名
NEXT_PUBLIC_WS_PORT="3002"

# 应用配置
NODE_ENV="production"
PORT="3000"

# 文件上传配置
UPLOAD_DIR="/var/www/uploads"  # 确保目录存在且有写权限
UPLOAD_MAX_SIZE="10485760"

# 存储加密密钥
STORAGE_ENCRYPTION_KEY="<粘贴第1步生成的密钥>"
STORAGE_REGION="z0"

# 日志配置
LOG_LEVEL="warn"  # 生产环境使用 warn 或 error
```

#### 3. 确保配置文件安全

```bash
# 确保 .env.production 不会被提交到 Git
echo ".env.production" >> .gitignore

# 设置文件权限 (仅所有者可读写)
chmod 600 .env.production

# 验证 .gitignore
git check-ignore .env.production
# 应该输出: .env.production
```

#### 4. 配置生产数据库

```bash
# 连接到 MySQL 服务器
mysql -u root -p

# 创建数据库
CREATE DATABASE kucun_prod CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建数据库用户
CREATE USER 'kucun_user'@'localhost' IDENTIFIED BY 'strong_password';

# 授予权限
GRANT ALL PRIVILEGES ON kucun_prod.* TO 'kucun_user'@'localhost';
FLUSH PRIVILEGES;

# 退出
EXIT;
```

#### 5. 运行数据库迁移

```bash
# 生成 Prisma Client
npx prisma generate

# 运行迁移
npx prisma migrate deploy

# 验证迁移
npx prisma migrate status

# (可选) 查看数据库结构
npx prisma studio
```

#### 6. 配置 Redis

```bash
# 安装 Redis (如果未安装)
# Ubuntu/Debian:
sudo apt-get install redis-server

# CentOS/RHEL:
sudo yum install redis

# 启动 Redis
sudo systemctl start redis
sudo systemctl enable redis

# 验证 Redis 连接
redis-cli ping
# 应该返回: PONG

# 配置 Redis 密码 (推荐)
sudo nano /etc/redis/redis.conf
# 找到并取消注释: requirepass your_strong_password

# 重启 Redis
sudo systemctl restart redis

# 更新 .env.production 中的 REDIS_URL
# REDIS_URL="redis://:your_strong_password@localhost:6379"
```

---

### 第二阶段: 构建和测试 (预计 1-2 小时)

#### 7. 安装依赖

```bash
# 清理旧的依赖
rm -rf node_modules package-lock.json

# 安装生产依赖
npm ci --production=false

# 验证依赖
npm list --depth=0
```

#### 8. 运行代码检查

```bash
# TypeScript 检查
npm run type-check

# ESLint 检查
npm run lint

# 格式化代码
npm run format
```

**注意**: 如果有错误,请先修复后再继续。

#### 9. 构建生产版本

```bash
# 构建 Next.js 应用
npm run build

# 检查构建输出
ls -lh .next/

# 验证构建成功
# 应该看到 .next/standalone 目录
```

#### 10. 本地测试生产构建

```bash
# 启动生产服务器
npm start

# 在另一个终端测试
curl http://localhost:3000

# 测试 API
curl http://localhost:3000/api/health

# 测试完成后停止服务器 (Ctrl+C)
```

---

### 第三阶段: 服务器部署 (预计 2-3 小时)

#### 11. 配置 PM2

创建 `ecosystem.config.js`:

```javascript
module.exports = {
  apps: [
    {
      name: 'kucun',
      script: 'node_modules/next/dist/bin/next',
      args: 'start',
      instances: 'max',
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3000,
      },
      error_file: './logs/err.log',
      out_file: './logs/out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      merge_logs: true,
      max_memory_restart: '1G',
    },
    {
      name: 'kucun-ws',
      script: 'lib/ws/ws-server.ts',
      interpreter: 'node',
      interpreter_args: '--loader ts-node/esm',
      instances: 1,
      exec_mode: 'fork',
      env: {
        NODE_ENV: 'production',
        WS_PORT: 3002,
      },
      error_file: './logs/ws-err.log',
      out_file: './logs/ws-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    },
  ],
};
```

#### 12. 创建日志目录

```bash
# 创建日志目录
mkdir -p logs

# 设置权限
chmod 755 logs
```

#### 13. 启动应用

```bash
# 使用 PM2 启动
pm2 start ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs kucun

# 保存 PM2 配置
pm2 save

# 设置开机自启
pm2 startup
# 按照提示执行命令
```

#### 14. 配置 Nginx 反向代理

创建 `/etc/nginx/sites-available/kucun`:

```nginx
# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS 配置
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSL 证书
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # SSL 配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 安全头 (Next.js middleware 已设置,这里作为备份)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;

    # 日志
    access_log /var/log/nginx/kucun-access.log;
    error_log /var/log/nginx/kucun-error.log;

    # Next.js 应用
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocket
    location /ws {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件缓存
    location /_next/static {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, max-age=3600, immutable";
    }

    # 上传文件
    location /uploads {
        alias /var/www/uploads;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }
}
```

启用配置:

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/kucun /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

#### 15. 配置 SSL 证书 (Let's Encrypt)

```bash
# 安装 Certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 测试自动续期
sudo certbot renew --dry-run

# 设置自动续期 (cron job)
sudo crontab -e
# 添加: 0 0 * * * certbot renew --quiet
```

---

### 第四阶段: 验证和监控 (预计 1 小时)

#### 16. 功能验证

```bash
# 测试 HTTPS 访问
curl -I https://your-domain.com

# 测试 API
curl https://your-domain.com/api/health

# 测试 WebSocket
# 使用浏览器开发者工具测试

# 测试登录功能
# 使用浏览器访问并登录
```

#### 17. 性能测试

```bash
# 安装 Apache Bench (如果未安装)
sudo apt-get install apache2-utils

# 并发测试
ab -n 1000 -c 10 https://your-domain.com/

# 查看响应时间
```

#### 18. 安全检查

```bash
# 检查安全头
curl -I https://your-domain.com | grep -E "(Content-Security-Policy|X-Frame-Options|X-Content-Type-Options)"

# SSL 测试
# 访问: https://www.ssllabs.com/ssltest/
# 输入域名进行测试,目标评分: A+
```

---

## 📊 部署后检查清单

### ✅ 功能检查
- [ ] 网站可以通过 HTTPS 访问
- [ ] 登录功能正常
- [ ] API 接口正常响应
- [ ] WebSocket 连接正常
- [ ] 文件上传功能正常
- [ ] 数据库读写正常
- [ ] Redis 缓存正常

### ✅ 安全检查
- [ ] SSL 证书有效
- [ ] 安全响应头正确设置
- [ ] 身份验证正常工作
- [ ] 环境变量已更新为强密钥
- [ ] .env.production 未提交到 Git
- [ ] 数据库连接使用强密码

### ✅ 性能检查
- [ ] 页面加载时间 < 3秒
- [ ] API 响应时间 < 500ms
- [ ] 静态资源正确缓存
- [ ] 图片正确优化

### ✅ 监控检查
- [ ] PM2 进程正常运行
- [ ] 日志正常记录
- [ ] 错误监控已配置 (可选)
- [ ] 性能监控已配置 (可选)

---

## 🔧 常用命令

### PM2 管理

```bash
# 查看状态
pm2 status

# 查看日志
pm2 logs kucun
pm2 logs kucun-ws

# 重启应用
pm2 restart kucun
pm2 restart all

# 停止应用
pm2 stop kucun
pm2 stop all

# 删除应用
pm2 delete kucun

# 监控
pm2 monit
```

### 数据库管理

```bash
# 备份数据库
mysqldump -u kucun_user -p kucun_prod > backup_$(date +%Y%m%d).sql

# 恢复数据库
mysql -u kucun_user -p kucun_prod < backup_20250102.sql

# 查看数据库大小
mysql -u kucun_user -p -e "SELECT table_schema AS 'Database', ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)' FROM information_schema.TABLES WHERE table_schema = 'kucun_prod';"
```

### 日志管理

```bash
# 查看应用日志
tail -f logs/out.log
tail -f logs/err.log

# 查看 Nginx 日志
tail -f /var/log/nginx/kucun-access.log
tail -f /var/log/nginx/kucun-error.log

# 清理旧日志
find logs/ -name "*.log" -mtime +30 -delete
```

---

## 🚨 故障排查

### 应用无法启动

```bash
# 检查端口占用
sudo netstat -tulpn | grep :3000

# 检查环境变量
pm2 env kucun

# 查看详细日志
pm2 logs kucun --lines 100
```

### 数据库连接失败

```bash
# 测试数据库连接
mysql -u kucun_user -p -h localhost kucun_prod

# 检查 Prisma 配置
npx prisma db pull
```

### Redis 连接失败

```bash
# 测试 Redis 连接
redis-cli -h localhost -p 6379 ping

# 检查 Redis 状态
sudo systemctl status redis
```

---

## 📝 下一步

部署完成后,建议:

1. **配置监控**: 集成 Sentry 或其他错误监控服务
2. **配置备份**: 设置自动数据库备份
3. **性能优化**: 根据实际使用情况优化配置
4. **文档完善**: 记录部署过程中的问题和解决方案

详见: `生产环境安全检查清单.md`

