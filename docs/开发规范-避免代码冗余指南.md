# 开发规范 - 避免代码冗余指南

## 📖 文档目的

本文档旨在帮助开发团队建立良好的编码习惯，避免产生冗余代码，提高代码质量和维护性。基于项目实际冗余清理经验总结而成。

## 🎯 核心原则

### 1. 单一来源原则 (Single Source of Truth)
每个概念、配置或数据在系统中只有一个明确的、权威的来源。

### 2. DRY原则 (Don't Repeat Yourself)
避免重复代码，通过抽象和复用来减少重复。

### 3. 约定优于配置
遵循既定的项目结构和命名约定，减少个人化的实现差异。

## 📁 项目结构规范

### 工具函数组织
```
lib/
├── utils/
│   ├── index.ts              # 通用工具函数
│   ├── validation-helpers.ts # 验证相关工具
│   ├── style-classes.ts      # 样式工具类
│   └── date-helpers.ts       # 日期处理工具
├── constants/
│   ├── error-messages.ts     # 错误消息常量
│   ├── status-values.ts      # 状态值常量
│   └── api-endpoints.ts      # API端点常量
└── types/
    ├── api.ts               # API相关类型
    ├── common.ts            # 通用类型
    └── business.ts          # 业务类型
```

### 组件组织
```
components/
├── ui/                      # shadcn/ui 基础组件
├── common/                  # 通用业务组件
├── forms/                   # 表单组件
├── layouts/                 # 布局组件
└── features/                # 功能特定组件
```

## 🛠️ 开发前检查清单

### 新增函数前必须检查
1. **搜索现有实现**
   ```bash
   # 搜索相似功能的函数
   grep -r "functionName" lib/ components/ app/
   ```

2. **检查工具函数库**
   - 查看 `lib/utils/index.ts` 是否有类似功能
   - 查看 `lib/utils/validation-helpers.ts` 验证函数
   - 查看 `lib/utils/date-helpers.ts` 日期处理函数

3. **确定放置位置**
   - 通用工具 → `lib/utils/index.ts`
   - 验证函数 → `lib/utils/validation-helpers.ts`
   - 业务特定 → 对应业务模块

### 新增常量前必须检查
1. **检查现有常量文件**
   - `lib/constants/error-messages.ts` - 错误消息
   - `lib/constants/status-values.ts` - 状态值
   - `lib/constants/api-endpoints.ts` - API端点

2. **避免硬编码字符串**
   ```typescript
   // ❌ 错误做法
   if (status === 'active') { ... }
   
   // ✅ 正确做法
   import { STATUS_VALUES } from '@/lib/constants/status-values';
   if (status === STATUS_VALUES.ACTIVE) { ... }
   ```

## 📋 常见冗余场景及解决方案

### 1. 格式化函数冗余

#### ❌ 错误做法
```typescript
// 在多个文件中重复定义
const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('zh-CN', {
    style: 'currency',
    currency: 'CNY'
  }).format(amount);
};
```

#### ✅ 正确做法
```typescript
// lib/utils/index.ts - 统一定义
export const formatCurrency = (amount: number): string => {
  return new Intl.NumberFormat('zh-CN', {
    style: 'currency',
    currency: 'CNY'
  }).format(amount);
};

// 其他文件中使用
import { formatCurrency } from '@/lib/utils';
```

### 2. 验证函数冗余

#### ❌ 错误做法
```typescript
// 在多个文件中重复定义相同的验证逻辑
const validateEmail = (email: string) => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
};
```

#### ✅ 正确做法
```typescript
// lib/utils/validation-helpers.ts - 统一定义
export const validateEmail = (email: string): boolean => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
};

// 使用时导入
import { validateEmail } from '@/lib/utils/validation-helpers';
```

### 3. 错误消息冗余

#### ❌ 错误做法
```typescript
// 在多个API文件中重复定义
return NextResponse.json(
  { success: false, error: '未授权访问' },
  { status: 401 }
);
```

#### ✅ 正确做法
```typescript
// lib/constants/error-messages.ts - 统一定义
export const API_ERROR_MESSAGES = {
  UNAUTHORIZED: '未授权访问',
  INVALID_INPUT: '输入数据格式不正确',
  // ...
} as const;

// API文件中使用
import { API_ERROR_MESSAGES } from '@/lib/constants/error-messages';
return NextResponse.json(
  { success: false, error: API_ERROR_MESSAGES.UNAUTHORIZED },
  { status: 401 }
);
```

### 4. 样式类名冗余

#### ❌ 错误做法
```tsx
// 在多个组件中重复使用相同的样式组合
<div className="flex items-center gap-2">
<div className="flex items-center justify-between">
<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
```

#### ✅ 正确做法
```typescript
// lib/utils/style-classes.ts - 统一定义
export const layoutStyles = {
  flexGap2: 'flex items-center gap-2',
  flexBetween: 'flex items-center justify-between',
  gridResponsive: 'grid grid-cols-1 md:grid-cols-2 gap-4',
} as const;

// 组件中使用
import { layoutStyles } from '@/lib/utils/style-classes';
<div className={layoutStyles.flexGap2}>
```

## 🔍 代码审查检查点

### Pull Request 审查清单

#### 1. 函数重复检查
- [ ] 新增函数是否已在项目中存在类似实现？
- [ ] 是否放在了正确的工具函数文件中？
- [ ] 是否有完整的TypeScript类型定义？

#### 2. 常量重复检查
- [ ] 硬编码字符串是否应该提取为常量？
- [ ] 新增常量是否已在常量文件中存在？
- [ ] 是否使用了正确的常量导入？

#### 3. 样式重复检查
- [ ] 是否使用了重复的样式类名组合？
- [ ] 是否可以使用预定义的样式工具类？
- [ ] 新增样式是否应该添加到样式工具库？

#### 4. 导入检查
- [ ] 是否从正确的模块导入工具函数？
- [ ] 是否有未使用的导入？
- [ ] 导入路径是否使用了别名（@/）？

## 🛡️ 自动化检查工具

### 1. 冗余函数检查
```bash
# 运行冗余函数检查
npx tsx scripts/check-redundant-functions.ts
```

### 2. TypeScript 类型检查
```bash
# 确保没有类型错误
npx tsc --noEmit --skipLibCheck
```

### 3. ESLint 代码质量检查
```bash
# 检查代码质量问题
npx eslint . --ext .ts,.tsx
```

## 📚 最佳实践示例

### 1. 创建新的工具函数
```typescript
// 1. 先检查是否已存在
// 2. 确定放置位置
// 3. 添加完整类型定义
// 4. 编写单元测试

// lib/utils/string-helpers.ts
export const capitalizeFirst = (str: string): string => {
  if (!str) return str;
  return str.charAt(0).toUpperCase() + str.slice(1);
};

// 导出到主工具文件
// lib/utils/index.ts
export { capitalizeFirst } from './string-helpers';
```

### 2. 添加新的常量
```typescript
// 1. 确定常量类型和用途
// 2. 放入对应的常量文件
// 3. 添加类型导出

// lib/constants/business-status.ts
export const ORDER_STATUS = {
  PENDING: 'pending',
  CONFIRMED: 'confirmed',
  SHIPPED: 'shipped',
  DELIVERED: 'delivered',
} as const;

export type OrderStatus = typeof ORDER_STATUS[keyof typeof ORDER_STATUS];
```

## 🎯 团队协作规范

### 1. 代码提交前
- 运行自动化检查工具
- 确保TypeScript编译通过
- 检查是否引入了新的冗余

### 2. 代码审查时
- 重点关注是否有重复实现
- 检查是否遵循了项目结构规范
- 确认新增代码的必要性

### 3. 定期维护
- 每月运行冗余检查工具
- 及时清理发现的冗余代码
- 更新和完善工具函数库

## 📈 持续改进

### 1. 监控指标
- 冗余函数数量
- 重复常量数量
- 代码重复率

### 2. 工具完善
- 扩展自动化检查覆盖范围
- 集成到CI/CD流程
- 开发IDE插件提醒

### 3. 团队培训
- 定期分享最佳实践
- 新人入职培训
- 代码审查经验分享

## 🔧 集成到开发流程

### 1. Git Hooks 集成
```bash
# 安装 pre-commit hook
cp scripts/pre-commit-quality-check.ts .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```

### 2. VS Code 配置
```json
// .vscode/settings.json
{
  "typescript.preferences.includePackageJsonAutoImports": "on",
  "typescript.suggest.autoImports": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true,
    "source.fixAll.eslint": true
  }
}
```

### 3. 快捷命令
```json
// package.json scripts
{
  "scripts": {
    "check:redundant": "tsx scripts/check-redundant-functions.ts",
    "check:quality": "tsx scripts/pre-commit-quality-check.ts",
    "fix:imports": "tsx scripts/fix-imports.ts"
  }
}
```

## 📚 相关文档

- [开发快速参考卡](./开发快速参考卡.md) - 日常开发速查手册
- [最终冗余代码检查报告](./最终冗余代码检查报告.md) - 项目冗余清理总结
- [全栈项目统一约定规范](../.augment/rules/全栈项目统一约定规范.md) - 项目整体规范

---

**记住：预防胜于治疗。遵循这些规范，从源头避免冗余代码的产生，比事后清理更加高效！**
