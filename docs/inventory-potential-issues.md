# åº“å­˜ç®¡ç†æ¨¡å—æ½œåœ¨é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ” æ·±åº¦ä»£ç å®¡æŸ¥ç»“æœ

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†åº“å­˜ç®¡ç†æ¨¡å—ä¸­å‘ç°çš„æ½œåœ¨é—®é¢˜ã€é£é™©ç‚¹å’Œæ”¹è¿›å»ºè®®ã€‚

---

## ğŸš¨ é«˜ä¼˜å…ˆçº§é—®é¢˜

### 1. å¹¶å‘æ§åˆ¶ä¸è¶³ - ç«æ€æ¡ä»¶é£é™©

**é—®é¢˜ä½ç½®**: `app/api/inventory/outbound/route.ts` (è¡Œ160-242)

**é—®é¢˜æè¿°**:

```typescript
// å½“å‰å®ç°
const availableInventory = await tx.inventory.findFirst({
  where: whereCondition,
});

// æ£€æŸ¥åº“å­˜
if (availableQuantity < quantity) {
  throw new Error('å¯ç”¨åº“å­˜ä¸è¶³');
}

// æ›´æ–°åº“å­˜
await tx.inventory.update({
  where: { id: availableInventory.id },
  data: { quantity: availableInventory.quantity - quantity },
});
```

**é£é™©**:

- åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹,å¤šä¸ªè¯·æ±‚å¯èƒ½åŒæ—¶è¯»å–ç›¸åŒçš„åº“å­˜æ•°é‡
- å¯èƒ½å¯¼è‡´è¶…å–é—®é¢˜(å®é™…å‡ºåº“é‡è¶…è¿‡åº“å­˜)
- äº‹åŠ¡éš”ç¦»çº§åˆ«åœ¨SQLiteä¸‹æœªè®¾ç½®,å¯èƒ½å‡ºç°è„è¯»

**å½±å“**: âš ï¸ ä¸¥é‡ - å¯èƒ½å¯¼è‡´åº“å­˜æ•°æ®ä¸ä¸€è‡´

**å»ºè®®ä¿®å¤**:

```typescript
// ä½¿ç”¨ä¹è§‚é”æˆ–æ‚²è§‚é”
const updatedInventory = await tx.inventory.updateMany({
  where: {
    id: availableInventory.id,
    quantity: { gte: quantity }, // ç¡®ä¿åº“å­˜è¶³å¤Ÿ
  },
  data: {
    quantity: { decrement: quantity },
  },
});

if (updatedInventory.count === 0) {
  throw new Error('åº“å­˜ä¸è¶³æˆ–å·²è¢«å…¶ä»–æ“ä½œå ç”¨');
}
```

### 2. ç¼ºå°‘å¹‚ç­‰æ€§ä¿è¯

**é—®é¢˜ä½ç½®**: æ‰€æœ‰POST APIç«¯ç‚¹

**é—®é¢˜æè¿°**:

- æ‰€æœ‰åº“å­˜æ“ä½œAPI(å…¥åº“ã€å‡ºåº“ã€è°ƒæ•´)éƒ½æ²¡æœ‰å¹‚ç­‰æ€§ä¿è¯
- ç½‘ç»œé‡è¯•æˆ–å®¢æˆ·ç«¯é‡å¤æäº¤å¯èƒ½å¯¼è‡´é‡å¤æ“ä½œ
- æ²¡æœ‰è¯·æ±‚IDæˆ–æ“ä½œIDæ¥é˜²æ­¢é‡å¤

**é£é™©**:

- ç”¨æˆ·ç‚¹å‡»ä¸¤æ¬¡å¯èƒ½å¯¼è‡´åº“å­˜è¢«æ‰£å‡ä¸¤æ¬¡
- ç½‘ç»œè¶…æ—¶é‡è¯•å¯èƒ½å¯¼è‡´é‡å¤å…¥åº“

**å½±å“**: âš ï¸ ä¸¥é‡ - æ•°æ®å‡†ç¡®æ€§é—®é¢˜

**å»ºè®®ä¿®å¤**:

```typescript
// æ·»åŠ å¹‚ç­‰æ€§é”®
export const inventoryOperationSchema = z.object({
  idempotencyKey: z.string().uuid('å¹‚ç­‰æ€§é”®æ ¼å¼ä¸æ­£ç¡®'),
  // ... å…¶ä»–å­—æ®µ
});

// åœ¨äº‹åŠ¡ä¸­æ£€æŸ¥
const existing = await tx.inventoryOperation.findUnique({
  where: { idempotencyKey },
});
if (existing) {
  return existing; // è¿”å›å·²æœ‰ç»“æœ
}
```

### 3. é¢„ç•™åº“å­˜ç®¡ç†ä¸å®Œå–„

**é—®é¢˜ä½ç½®**: `app/api/inventory/outbound/route.ts` (è¡Œ204-210)

**é—®é¢˜æè¿°**:

```typescript
reservedQuantity: Math.max(
  0,
  Math.min(
    availableInventory.reservedQuantity,
    availableInventory.quantity - quantity
  )
),
```

**é£é™©**:

- é¢„ç•™åº“å­˜çš„é‡Šæ”¾é€»è¾‘ä¸æ˜ç¡®
- æ²¡æœ‰é¢„ç•™è¶…æ—¶æœºåˆ¶
- ç¼ºå°‘é¢„ç•™è®°å½•è¿½è¸ª

**å½±å“**: âš ï¸ ä¸­ç­‰ - å¯èƒ½å¯¼è‡´åº“å­˜é”å®šæ— æ³•é‡Šæ”¾

**å»ºè®®**:

1. åˆ›å»ºç‹¬ç«‹çš„é¢„ç•™è®°å½•è¡¨
2. å®ç°é¢„ç•™è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾æœºåˆ¶
3. æ·»åŠ é¢„ç•™çŠ¶æ€è¿½è¸ª

---

## âš ï¸ ä¸­ä¼˜å…ˆçº§é—®é¢˜

### 4. é”™è¯¯å¤„ç†ä¸å¤Ÿç»†è‡´

**é—®é¢˜ä½ç½®**: å¤šä¸ªAPIç«¯ç‚¹

**é—®é¢˜æè¿°**:

```typescript
catch (error) {
  console.error('åº“å­˜è°ƒæ•´å¤±è´¥:', error);
  return NextResponse.json(
    { success: false, error: error instanceof Error ? error.message : 'åº“å­˜è°ƒæ•´å¤±è´¥' },
    { status: 500 }
  );
}
```

**é—®é¢˜**:

- æ‰€æœ‰é”™è¯¯éƒ½è¿”å›500çŠ¶æ€ç 
- æ²¡æœ‰åŒºåˆ†ä¸šåŠ¡é”™è¯¯å’Œç³»ç»Ÿé”™è¯¯
- é”™è¯¯ä¿¡æ¯å¯èƒ½æš´éœ²æ•æ„Ÿä¿¡æ¯

**å»ºè®®**:

```typescript
catch (error) {
  if (error instanceof BusinessError) {
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 400 }
    );
  }

  // è®°å½•è¯¦ç»†é”™è¯¯ä½†è¿”å›é€šç”¨æ¶ˆæ¯
  logger.error('åº“å­˜æ“ä½œå¤±è´¥', { error, context });
  return NextResponse.json(
    { success: false, error: 'æ“ä½œå¤±è´¥,è¯·ç¨åé‡è¯•' },
    { status: 500 }
  );
}
```

### 5. ç¼ºå°‘æ“ä½œæ—¥å¿—å’Œå®¡è®¡è¿½è¸ª

**é—®é¢˜ä½ç½®**: æ‰€æœ‰åº“å­˜æ“ä½œ

**é—®é¢˜æè¿°**:

- åªæœ‰è°ƒæ•´æ“ä½œæœ‰å®¡è®¡è®°å½•(`inventoryAdjustment`)
- å…¥åº“å’Œå‡ºåº“æ“ä½œç¼ºå°‘å®Œæ•´çš„å®¡è®¡è¿½è¸ª
- æ— æ³•è¿½æº¯è°åœ¨ä»€ä¹ˆæ—¶å€™åšäº†ä»€ä¹ˆæ“ä½œ

**å½±å“**: âš ï¸ ä¸­ç­‰ - å®¡è®¡å’Œé—®é¢˜æ’æŸ¥å›°éš¾

**å»ºè®®**:

1. ç»Ÿä¸€çš„æ“ä½œæ—¥å¿—è¡¨
2. è®°å½•æ“ä½œå‰åçš„å®Œæ•´çŠ¶æ€
3. åŒ…å«ç”¨æˆ·ã€æ—¶é—´ã€IPã€æ“ä½œç±»å‹ç­‰ä¿¡æ¯

### 6. æ•°æ®éªŒè¯ä¸å¤Ÿä¸¥æ ¼

**é—®é¢˜ä½ç½®**: `lib/validations/inventory-operations.ts`

**é—®é¢˜æè¿°**:

```typescript
adjustQuantity: z.number()
  .int('è°ƒæ•´æ•°é‡å¿…é¡»ä¸ºæ•´æ•°')
  .min(-999999, 'è°ƒæ•´æ•°é‡ä¸èƒ½å°äº-999,999')
  .max(999999, 'è°ƒæ•´æ•°é‡ä¸èƒ½è¶…è¿‡999,999')
  .refine(val => val !== 0, 'è°ƒæ•´æ•°é‡ä¸èƒ½ä¸º0'),
```

**é—®é¢˜**:

- å…è®¸è´Ÿæ•°è°ƒæ•´ä½†æ²¡æœ‰æ£€æŸ¥å½“å‰åº“å­˜æ˜¯å¦è¶³å¤Ÿ
- æ²¡æœ‰ä¸šåŠ¡è§„åˆ™éªŒè¯(å¦‚:å•æ¬¡è°ƒæ•´ä¸Šé™)
- ç¼ºå°‘è·¨å­—æ®µéªŒè¯

**å»ºè®®**:

```typescript
.refine(
  (data) => {
    if (data.adjustQuantity < 0) {
      return data.currentQuantity >= Math.abs(data.adjustQuantity);
    }
    return true;
  },
  { message: 'è°ƒæ•´ååº“å­˜ä¸èƒ½ä¸ºè´Ÿæ•°' }
)
```

### 7. ç¼“å­˜å¤±æ•ˆç­–ç•¥ä¸å®Œæ•´

**é—®é¢˜ä½ç½®**: å„APIç«¯ç‚¹çš„ç¼“å­˜å¤±æ•ˆè°ƒç”¨

**é—®é¢˜æè¿°**:

```typescript
await invalidateInventoryCache(adjustmentData.productId);
```

**é—®é¢˜**:

- åªæ¸…é™¤å•ä¸ªäº§å“çš„ç¼“å­˜
- åˆ—è¡¨ç¼“å­˜å¯èƒ½ä¸ä¼šæ›´æ–°
- ç›¸å…³ç»Ÿè®¡æ•°æ®ç¼“å­˜æœªæ¸…é™¤

**å»ºè®®**:

```typescript
// æ¸…é™¤å¤šä¸ªç›¸å…³ç¼“å­˜
await Promise.all([
  invalidateInventoryCache(productId),
  invalidateNamespace('inventory:list:*'),
  invalidateNamespace('dashboard:*'),
  invalidateNamespace('alerts:*'),
]);
```

---

## ğŸ“ ä½ä¼˜å…ˆçº§é—®é¢˜

### 8. ç¡¬ç¼–ç çš„ä¸šåŠ¡è§„åˆ™

**é—®é¢˜ä½ç½®**: å¤šå¤„

**ç¤ºä¾‹**:

```typescript
// ä½åº“å­˜é˜ˆå€¼ç¡¬ç¼–ç 
conditions.push(Prisma.sql`i.quantity <= 10`);

// ç¼“å­˜TTLç¡¬ç¼–ç 
cacheConfig.inventoryTtl; // 10ç§’
```

**å»ºè®®**: å°†ä¸šåŠ¡è§„åˆ™é…ç½®åŒ–,å­˜å‚¨åœ¨æ•°æ®åº“æˆ–é…ç½®æ–‡ä»¶ä¸­

### 9. ç¼ºå°‘æ€§èƒ½ç›‘æ§

**é—®é¢˜**:

- æ²¡æœ‰æ…¢æŸ¥è¯¢ç›‘æ§
- æ²¡æœ‰APIå“åº”æ—¶é—´è¿½è¸ª
- ç¼ºå°‘ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡

**å»ºè®®**: é›†æˆAPMå·¥å…·æˆ–è‡ªå»ºç›‘æ§

### 10. å¼€å‘ç¯å¢ƒæƒé™ç»•è¿‡

**é—®é¢˜ä½ç½®**: å¤šä¸ªAPIç«¯ç‚¹

```typescript
if (env.NODE_ENV !== 'development') {
  const session = await getServerSession(authOptions);
  // ...
}
```

**é£é™©**: å¼€å‘ç¯å¢ƒå¯èƒ½è¢«è¯¯ç”¨,å¯¼è‡´æ•°æ®æ±¡æŸ“

**å»ºè®®**: å³ä½¿åœ¨å¼€å‘ç¯å¢ƒä¹Ÿåº”éªŒè¯æƒé™,æˆ–ä½¿ç”¨æµ‹è¯•è´¦å·

### 11. TODOæ ‡è®°æœªå¤„ç†

**é—®é¢˜ä½ç½®**: `app/api/inventory/outbound/route.ts` (è¡Œ237)

```typescript
operatorId: 'system', // TODO: ä½¿ç”¨å®é™…ç”¨æˆ·ID
```

**å½±å“**: æ— æ³•è¿½è¸ªå®é™…æ“ä½œäºº

**å»ºè®®**: ç«‹å³ä¿®å¤,ä½¿ç”¨session.user.id

### 12. æ‰¹æ¬¡å·ç”Ÿæˆé€»è¾‘ä¸æ˜ç¡®

**é—®é¢˜ä½ç½®**: `app/api/inventory/inbound/route.ts`

```typescript
const finalBatchNumber = validatedData.batchNumber || `BATCH-${Date.now()}`;
```

**é—®é¢˜**:

- æ‰¹æ¬¡å·æ ¼å¼ä¸ç»Ÿä¸€
- å¯èƒ½äº§ç”Ÿé‡å¤
- æ²¡æœ‰ä¸šåŠ¡å«ä¹‰

**å»ºè®®**: å®ç°ç»Ÿä¸€çš„æ‰¹æ¬¡å·ç”Ÿæˆå™¨

---

## ğŸ”’ å®‰å…¨é—®é¢˜

### 13. SQLæ³¨å…¥é£é™©(å·²ç¼“è§£)

**çŠ¶æ€**: âœ… å·²ä½¿ç”¨Prismaå‚æ•°åŒ–æŸ¥è¯¢,é£é™©è¾ƒä½

**ä½ç½®**: `lib/api/inventory-query-builder.ts`

**è¯´æ˜**: ä½¿ç”¨äº†`Prisma.sql`æ¨¡æ¿æ ‡ç­¾,è‡ªåŠ¨é˜²æ­¢SQLæ³¨å…¥

### 14. æƒé™æ§åˆ¶ç²’åº¦ä¸å¤Ÿ

**é—®é¢˜**:

- åªéªŒè¯æ˜¯å¦ç™»å½•,æœªéªŒè¯å…·ä½“æƒé™
- æ²¡æœ‰åŒºåˆ†è¯»æƒé™å’Œå†™æƒé™
- ç¼ºå°‘è§’è‰²åŸºç¡€çš„è®¿é—®æ§åˆ¶(RBAC)

**å»ºè®®**: å®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ç³»ç»Ÿ

---

## ğŸ“Š æ€§èƒ½é—®é¢˜

### 15. N+1æŸ¥è¯¢é—®é¢˜(å·²è§£å†³)

**çŠ¶æ€**: âœ… å·²é€šè¿‡JOINæŸ¥è¯¢è§£å†³

**ä½ç½®**: `lib/api/inventory-query-builder.ts`

### 16. ç¼ºå°‘æ•°æ®åº“è¿æ¥æ± ç›‘æ§

**é—®é¢˜**: æ— æ³•çŸ¥é“è¿æ¥æ± ä½¿ç”¨æƒ…å†µ

**å»ºè®®**: æ·»åŠ è¿æ¥æ± æŒ‡æ ‡ç›‘æ§

### 17. å¤§æ•°æ®é‡åˆ†é¡µæ€§èƒ½

**é—®é¢˜**:

- æ·±åº¦åˆ†é¡µ(å¤§offset)æ€§èƒ½å·®
- æ²¡æœ‰æ¸¸æ ‡åˆ†é¡µé€‰é¡¹

**å»ºè®®**:

```typescript
// å®ç°æ¸¸æ ‡åˆ†é¡µ
export const cursorPaginationSchema = z.object({
  cursor: z.string().optional(),
  limit: z.number().max(100),
});
```

---

## ğŸ¯ æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§

### ç«‹å³ä¿®å¤(1å‘¨å†…)

1. âœ… å¹¶å‘æ§åˆ¶ - æ·»åŠ ä¹è§‚é”
2. âœ… å¹‚ç­‰æ€§ä¿è¯ - æ·»åŠ å¹‚ç­‰æ€§é”®
3. âœ… TODOæ ‡è®° - ä½¿ç”¨å®é™…ç”¨æˆ·ID

### çŸ­æœŸæ”¹è¿›(1ä¸ªæœˆå†…)

4. å®Œå–„é”™è¯¯å¤„ç†å’Œåˆ†ç±»
5. å®ç°æ“ä½œæ—¥å¿—å’Œå®¡è®¡è¿½è¸ª
6. ä¼˜åŒ–ç¼“å­˜å¤±æ•ˆç­–ç•¥
7. å®ç°é¢„ç•™åº“å­˜ç®¡ç†

### ä¸­æœŸæ”¹è¿›(3ä¸ªæœˆå†…)

8. å®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶
9. æ·»åŠ æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦
10. é…ç½®åŒ–ä¸šåŠ¡è§„åˆ™
11. å®ç°æ¸¸æ ‡åˆ†é¡µ

### é•¿æœŸè§„åˆ’(6ä¸ªæœˆå†…)

12. åˆ†å¸ƒå¼äº‹åŠ¡æ”¯æŒ
13. è¯»å†™åˆ†ç¦»
14. æ•°æ®å½’æ¡£ç­–ç•¥

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£](./performance-optimization.md)
- [ESLintè§„èŒƒæŒ‡å—](../.augment/rules/ESLintè§„èŒƒéµå¾ªæŒ‡å—.md)
- [å…¨å±€çº¦å®šè§„èŒƒ](../.augment/rules/AGENTS.md)

---

**åˆ›å»ºæ—¶é—´**: 2025-09-30
**å®¡æŸ¥äºº**: AI Agent
**ä¸‹æ¬¡å®¡æŸ¥**: 2025-10-30
