# 库存管理工具 - 对齐文档 (ALIGNMENT)

## 1. 项目上下文分析

### 1.1 现有项目结构分析

- **项目类型**: 瓷砖行业专用库存管理工具
- **业务域**: 库存管理、销售管理、客户管理
- **目标用户**: 瓷砖行业的管理员和销售员
- **部署环境**: 单租户系统，支持移动端访问

### 1.2 现有文档状态

- ✅ **CONSENSUS文档**: 已存在，包含完整的需求共识
- ✅ **技术架构**: 基础架构已定义
- ❌ **ALIGNMENT文档**: 缺失，需要创建
- ❌ **详细设计文档**: 待后续阶段创建

### 1.3 业务特性分析

- **行业特色**: 瓷砖行业特有的色号、生产日期、每件片数等属性
- **核心流程**: 销售→审核→出库→发货→收款的完整业务闭环
- **管理模式**: 基于角色的权限控制（管理员/销售员）
- **操作场景**: 支持PC端和移动端双端操作

## 2. 技术栈对齐分析

### 2.1 技术栈差异对比

| 技术领域     | CONSENSUS文档            | 用户提供版本                              | 对齐状态    | 建议              |
| ------------ | ------------------------ | ----------------------------------------- | ----------- | ----------------- |
| 全栈框架     | Next.js 14               | Next.js 15.4 (App Router)                 | ⚠️ 版本差异 | 升级到15.4        |
| 数据库       | Supabase (PostgreSQL)    | MySQL 8.0+                                | ❌ 技术差异 | 需要确认选择      |
| 数据库驱动   | -                        | Prisma                                    | ✅ 新增     | 采用Prisma        |
| 身份认证     | Next-Auth.js             | Next-Auth.js                              | ✅ 一致     | 保持              |
| 状态管理     | Zustand                  | TanStack Query v5.79.0                    | ❌ 技术差异 | 需要确认选择      |
| UI组件库     | Tailwind CSS + Shadcn/ui | Tailwind CSS v4.1.12 + shadcn/ui 2025.1.2 | ⚠️ 版本差异 | 升级到最新版本    |
| 服务器管理   | -                        | 宝塔面板                                  | ✅ 新增     | 采用宝塔面板      |
| 文件上传     | -                        | multer                                    | ✅ 新增     | 采用multer        |
| 环境管理     | -                        | .env.local 文件                           | ✅ 新增     | 采用.env.local    |
| 类型定义     | TypeScript               | TypeScript 5.2                            | ✅ 一致     | 保持              |
| 代码质量工具 | -                        | ESLint 9 + Prettier + Husky               | ✅ 新增     | 采用完整工具链    |
| 表单处理     | -                        | React Hook Form 7.54.1                    | ✅ 新增     | 采用RHF           |
| 图片处理     | -                        | sharp                                     | ✅ 新增     | 采用sharp         |
| 数据验证     | Zod                      | Zod 4.0                                   | ✅ 一致     | 保持              |
| 单位转换     | -                        | convert-units 4.0.0                       | ✅ 新增     | 采用convert-units |
| 缓存         | Redis                    | -                                         | ⚠️ 缺失     | 需要确认是否保留  |

### 2.2 关键技术决策点

#### 🔴 高优先级决策

1. **数据库选择**: Supabase (PostgreSQL) vs MySQL 8.0+
   - CONSENSUS文档: Supabase (PostgreSQL)
   - 用户提供: MySQL 8.0+ with Prisma
   - **影响**: 数据库架构、部署方式、开发复杂度

2. **状态管理**: Zustand vs TanStack Query
   - CONSENSUS文档: Zustand
   - 用户提供: TanStack Query v5.79.0
   - **影响**: 数据流管理、缓存策略、API调用方式

#### 🟡 中优先级决策

3. **缓存策略**: Redis vs 内置缓存
   - CONSENSUS文档: Redis
   - 用户提供: 未明确
   - **影响**: 性能优化、部署复杂度

4. **Next.js版本**: 14 vs 15.4
   - CONSENSUS文档: Next.js 14
   - 用户提供: Next.js 15.4 (App Router)
   - **影响**: 新特性支持、稳定性

## 3. 需求理解确认

### 3.1 原始需求分析

基于CONSENSUS文档，核心需求包括：

#### 功能需求

- ✅ **用户管理**: 管理员/销售员角色权限
- ✅ **产品管理**: 瓷砖特有属性（色号、生产日期等）
- ✅ **销售管理**: 销售单创建、审核、出库流程
- ✅ **库存管理**: 入库、库存预警、严格库存控制
- ✅ **客户管理**: 客户信息和历史价格记录
- ✅ **移动端支持**: 响应式设计、触屏操作

#### 非功能需求

- ✅ **性能**: 页面加载<3秒，API响应<500ms
- ✅ **并发**: 支持50个并发用户
- ✅ **数据量**: 支持10万级产品数据
- ✅ **安全**: 基于角色的权限控制

### 3.2 边界确认

#### 包含功能

- ✅ 销售、入库、客户管理核心功能
- ✅ 瓷砖行业特有属性管理
- ✅ 移动端友好操作
- ✅ 图片生成单据功能
- ✅ 库存预警和严格库存控制

#### 明确排除功能

- ❌ 多租户支持
- ❌ 第三方系统集成（财务软件、ERP）
- ❌ 在线支付功能
- ❌ 打印功能模块
- ❌ 复杂价格策略（多级价格、批量折扣）
- ❌ 盘点功能和邮件提醒

### 3.3 对现有项目的理解

#### 架构理解

- **单体应用**: Next.js全栈应用，前后端一体化
- **数据层**: 关系型数据库，支持复杂查询
- **认证层**: Next-Auth.js统一身份认证
- **UI层**: 现代化组件库，响应式设计

#### 业务理解

- **行业专用**: 专为瓷砖行业定制，非通用库存系统
- **流程简化**: 避免过度复杂的业务逻辑
- **移动优先**: 考虑现场操作的移动端需求
- **数据完整**: 支持完整的销售和库存业务闭环

## 4. 疑问澄清

### 4.1 技术选型疑问

#### 🔴 关键决策点

1. **数据库技术栈确认**
   - **问题**: Supabase (PostgreSQL) vs MySQL 8.0+ with Prisma
   - **影响**: 影响整体架构设计和部署方式
   - **建议**: 推荐MySQL + Prisma，原因：
     - 用户明确提供MySQL技术栈
     - Prisma提供优秀的类型安全和开发体验
     - 宝塔面板对MySQL支持更好

2. **状态管理策略确认**
   - **问题**: Zustand vs TanStack Query
   - **影响**: 数据流管理和API调用方式
   - **建议**: 推荐TanStack Query，原因：
     - 专门为服务端状态管理设计
     - 内置缓存、重试、背景更新等功能
     - 与React Hook Form配合更好

#### 🟡 次要决策点

3. **缓存策略确认**
   - **问题**: 是否需要Redis缓存
   - **影响**: 性能优化vs部署复杂度
   - **建议**: 采用Redis缓存，提升系统性能和用户体验

4. **Next.js版本确认**
   - **问题**: 使用Next.js 15.4是否稳定
   - **影响**: 新特性vs稳定性
   - **建议**: 采用15.4，App Router是未来方向

### 4.2 业务逻辑疑问

#### 已明确的业务规则

- ✅ 不允许负库存销售，严格库存控制
- ✅ 已审核订单不可修改
- ✅ 基于历史价格的自动填充
- ✅ 管理员和销售员的权限差异

#### 需要进一步确认的细节

1. **文件上传场景**
   - **问题**: multer主要用于哪些文件上传场景？
   - **推测**: 可能用于产品图片、单据附件等

2. **图片处理需求**
   - **问题**: sharp的具体使用场景？
   - **推测**: 产品图片压缩、单据图片生成等

## 5. 智能决策策略

### 5.1 自动决策项

基于行业最佳实践和技术趋势，以下决策可以自动确定：

#### 技术栈决策

- ✅ **采用用户提供的技术栈版本**，保持技术栈的现代化
- ✅ **使用MySQL + Prisma**，提供更好的类型安全和开发体验
- ✅ **采用TanStack Query**，专业的服务端状态管理
- ✅ **使用React Hook Form + Zod**，现代化表单处理方案
- ✅ **采用完整的代码质量工具链**，确保代码质量

#### 架构决策

- ✅ **Next.js 15.4 App Router**，严格执行，禁止替换其他框架
- ✅ **TypeScript严格模式**，强制类型安全，禁止any类型
- ✅ **移动端优先设计**，使用Tailwind CSS响应式方案
- ✅ **组件化开发**，优先使用shadcn/ui，禁止重复开发组件
- ✅ **标准化实现**，禁止重复造轮子，必须使用现有成熟库

### 5.2 需要确认的决策

#### 🔴 高优先级确认

1. **数据库迁移策略**: 如何从Supabase迁移到MySQL
2. **部署环境**: 宝塔面板的具体配置要求
3. **文件存储**: 图片和文件的存储方案

#### 🟡 中优先级确认

1. **缓存策略**: 是否需要引入Redis
2. **监控方案**: 生产环境的监控和日志方案
3. **备份策略**: 数据库备份和恢复方案

## 6. 技术架构对齐建议

### 6.1 推荐技术栈

```
前端框架: Next.js 15.4 (App Router) - 严格执行，禁止替换
类型系统: TypeScript 5.2 - 严格模式，禁止any类型
数据库: MySQL 8.0+ - 指定数据库，禁止替换
数据库驱动: Prisma - 唯一数据库操作方案，禁止直接SQL
缓存系统: Redis - 性能优化，缓存热点数据和查询结果
身份认证: Next-Auth.js - 标准认证方案
状态管理: TanStack Query v5.79.0 - 唯一状态管理方案
UI组件库: Tailwind CSS v4.1.12 + shadcn/ui 2025.1.2 - 唯一样式方案，优先使用shadcn/ui
表单处理: React Hook Form 7.54.1 - 标准表单方案
数据验证: Zod 4.0 - 禁止自定义验证
单位转换: convert-units 4.0.0 - 标准单位转换库
文件上传: multer - 标准文件处理方案
图片处理: sharp - 标准图片处理方案
代码质量: ESLint 9 + Prettier + Husky - 代码规范强制执行
环境管理: .env.local - 标准环境配置
服务器管理: 宝塔面板 - 指定服务器管理方案
```

### 6.2 架构调整建议

#### 数据层调整

- **从Supabase迁移到MySQL + Prisma**
- **保持现有的数据模型设计**
- **利用Prisma的类型生成能力**

#### 状态管理调整

- **从Zustand迁移到TanStack Query**
- **保持现有的数据流设计**
- **利用TanStack Query的缓存能力**

#### 开发工具链升级

- **引入完整的代码质量工具**
- **配置自动化的代码检查和格式化**
- **设置Git提交钩子**

## 7. 下一步行动计划

### 7.1 立即行动项

1. **确认技术栈选择**: 特别是数据库和状态管理方案
2. **更新CONSENSUS文档**: 根据对齐结果更新技术架构部分
3. **创建技术架构文档**: 详细的系统设计文档

### 7.2 后续阶段规划

1. **Architect阶段**: 基于对齐结果设计详细架构
2. **Atomize阶段**: 拆分具体的开发任务
3. **Approve阶段**: 人工审查和确认
4. **Automate阶段**: 自动化开发实施
5. **Assess阶段**: 质量评估和验收

## 8. 风险评估

### 8.1 技术风险

- **🟡 中等风险**: Next.js 15.4的稳定性（新版本可能存在未知问题）
- **🟢 低风险**: MySQL + Prisma技术栈成熟稳定
- **🟢 低风险**: TanStack Query在React生态中广泛使用

### 8.2 业务风险

- **🟢 低风险**: 需求边界清晰，业务逻辑相对简单
- **🟢 低风险**: 瓷砖行业特性明确，不存在复杂的业务规则

### 8.3 项目风险

- **🟡 中等风险**: 技术栈调整可能影响开发进度
- **🟢 低风险**: 团队对现代前端技术栈熟悉

## 9. 总结

### 9.1 对齐状态

- ✅ **项目目标明确**: 瓷砖行业库存管理工具
- ✅ **功能边界清晰**: 核心功能已确定，排除功能已明确
- ⚠️ **技术栈需要调整**: 主要是数据库和状态管理方案
- ✅ **架构方向正确**: 全栈TypeScript，移动端友好

### 9.2 关键决策

推荐采用用户提供的现代化技术栈，主要调整：

1. **数据库**: Supabase → MySQL 8.0+ + Prisma
2. **状态管理**: Zustand → TanStack Query v5.79.0
3. **版本升级**: Next.js 14 → 15.4, Tailwind CSS → v4.1.12
4. **工具链完善**: 添加ESLint 9 + Prettier + Husky

### 9.3 准备进入下一阶段

对齐阶段基本完成，具备进入Architect（架构设计）阶段的条件：

- ✅ 需求理解清晰
- ✅ 技术方向明确
- ✅ 边界条件确定
- ⚠️ 部分技术细节需要在架构阶段进一步确认

**建议**: 立即进入架构设计阶段，同时更新CONSENSUS文档中的技术架构部分。
