# 库存管理系统 - 开发快速参考卡

## 🚀 快速启动

### 项目启动
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 访问地址
http://localhost:3000
```

### 数据库操作
```bash
# 生成 Prisma 客户端
npx prisma generate

# 推送架构到数据库（开发环境）
npx prisma db push

# 创建迁移文件（生产环境）
npx prisma migrate dev

# 查看数据库
npx prisma studio
```

## 📁 项目结构速查

### 核心目录
```
app/
├── (dashboard)/           # 仪表板页面
│   ├── products/         # 产品管理
│   ├── categories/       # 分类管理
│   ├── customers/        # 客户管理
│   ├── inventory/        # 库存管理
│   └── sales/           # 销售管理
├── api/                 # API 路由
└── auth/               # 认证页面

components/
├── ui/                 # shadcn/ui 组件（不可修改）
└── common/            # 业务组件

lib/
├── auth.ts            # 认证配置
├── db.ts              # Prisma 客户端
├── env.ts             # 环境变量验证
├── api/               # API 客户端函数
└── validations/       # Zod 验证规则
```

## 🛠️ 常用命令

### 代码质量
```bash
# ESLint 检查
npm run lint

# 自动修复 ESLint 问题
npm run lint:fix

# Prettier 格式化
npm run format

# TypeScript 类型检查
npm run type-check

# 构建项目
npm run build
```

### shadcn/ui 组件
```bash
# 添加新组件
npx shadcn-ui@latest add button
npx shadcn-ui@latest add form
npx shadcn-ui@latest add dialog

# 查看可用组件
npx shadcn-ui@latest add
```

### Git 操作
```bash
# 提交代码（会触发质量检查）
git add .
git commit -m "feat(产品): 添加批量删除功能"

# 跳过质量检查（紧急情况）
git commit -m "fix: 紧急修复" --no-verify
```

## 🎯 开发模式

### 1. 新增功能开发流程

#### 步骤1: 数据库设计
```prisma
// prisma/schema.prisma
model Product {
  id          String   @id @default(cuid())
  name        String
  price       Decimal
  category_id String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  category    Category @relation(fields: [category_id], references: [id])
  
  @@map("products")
}
```

#### 步骤2: 验证规则定义
```typescript
// lib/validations/product.ts
export const productValidations = {
  create: z.object({
    name: z.string().min(1, '产品名称不能为空'),
    price: z.number().min(0, '价格不能为负数'),
    categoryId: z.string().min(1, '分类不能为空'),
  }),
};

export type ProductCreateInput = z.infer<typeof productValidations.create>;
```

#### 步骤3: API 路由实现
```typescript
// app/api/products/route.ts
export async function POST(request: NextRequest) {
  try {
    // 1. 身份验证
    const session = await getServerSession(authOptions);
    if (!session) {
      return NextResponse.json({ error: '未授权' }, { status: 401 });
    }

    // 2. 输入验证
    const body = await request.json();
    const validatedData = productValidations.create.parse(body);

    // 3. 业务逻辑
    const product = await prisma.product.create({
      data: {
        name: validatedData.name,
        price: validatedData.price,
        category_id: validatedData.categoryId,
      },
    });

    // 4. 响应
    return NextResponse.json({ success: true, data: product });
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: '输入数据无效' }, { status: 400 });
    }
    return NextResponse.json({ error: '服务器错误' }, { status: 500 });
  }
}
```

#### 步骤4: API 客户端函数
```typescript
// lib/api/products.ts
export async function createProduct(data: ProductCreateInput) {
  const response = await fetch('/api/products', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
  });
  
  if (!response.ok) {
    throw new Error('创建产品失败');
  }
  
  return response.json();
}
```

#### 步骤5: 前端组件实现
```tsx
// app/(dashboard)/products/create-product-form.tsx
export function CreateProductForm() {
  const form = useForm<ProductCreateInput>({
    resolver: zodResolver(productValidations.create),
  });

  const createMutation = useMutation({
    mutationFn: createProduct,
    onSuccess: () => {
      toast({ title: '产品创建成功' });
      queryClient.invalidateQueries({ queryKey: ['products'] });
    },
  });

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(createMutation.mutate)}>
        <FormField
          control={form.control}
          name="name"
          render={({ field }) => (
            <FormItem>
              <FormLabel>产品名称</FormLabel>
              <FormControl>
                <Input {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <Button type="submit" disabled={createMutation.isPending}>
          {createMutation.isPending ? '创建中...' : '创建产品'}
        </Button>
      </form>
    </Form>
  );
}
```

### 2. 页面开发模式

#### 服务器组件（数据获取）
```tsx
// app/(dashboard)/products/page.tsx
export default async function ProductsPage() {
  const products = await prisma.product.findMany({
    include: { category: true },
    orderBy: { created_at: 'desc' },
  });

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-3xl font-bold">产品管理</h1>
        <CreateProductButton />
      </div>
      <ProductList products={products} />
    </div>
  );
}
```

#### 客户端组件（交互功能）
```tsx
// components/product-list.tsx
'use client';

export function ProductList({ products }: { products: Product[] }) {
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  
  const deleteProductsMutation = useMutation({
    mutationFn: batchDeleteProducts,
    onSuccess: () => {
      toast({ title: '删除成功' });
      queryClient.invalidateQueries({ queryKey: ['products'] });
    },
  });

  return (
    <div className="space-y-4">
      {selectedIds.length > 0 && (
        <Button 
          variant="destructive"
          onClick={() => deleteProductsMutation.mutate({ productIds: selectedIds })}
        >
          批量删除 ({selectedIds.length})
        </Button>
      )}
      
      <div className="grid gap-4">
        {products.map((product) => (
          <ProductCard 
            key={product.id} 
            product={product}
            selected={selectedIds.includes(product.id)}
            onSelect={(selected) => {
              if (selected) {
                setSelectedIds([...selectedIds, product.id]);
              } else {
                setSelectedIds(selectedIds.filter(id => id !== product.id));
              }
            }}
          />
        ))}
      </div>
    </div>
  );
}
```

## 🎨 UI 组件速查

### 常用组件导入
```tsx
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Form, FormControl, FormField, FormItem, FormLabel } from '@/components/ui/form';
import { useToast } from '@/components/ui/use-toast';
```

### 表单模式
```tsx
const form = useForm<FormData>({
  resolver: zodResolver(validationSchema),
  defaultValues: { /* 默认值 */ },
});

<Form {...form}>
  <form onSubmit={form.handleSubmit(onSubmit)}>
    <FormField
      control={form.control}
      name="fieldName"
      render={({ field }) => (
        <FormItem>
          <FormLabel>字段标签</FormLabel>
          <FormControl>
            <Input {...field} />
          </FormControl>
          <FormMessage />
        </FormItem>
      )}
    />
  </form>
</Form>
```

### 对话框模式
```tsx
const [open, setOpen] = useState(false);

<Dialog open={open} onOpenChange={setOpen}>
  <DialogTrigger asChild>
    <Button>打开对话框</Button>
  </DialogTrigger>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>对话框标题</DialogTitle>
    </DialogHeader>
    {/* 对话框内容 */}
  </DialogContent>
</Dialog>
```

## 🔍 调试技巧

### 数据库查询调试
```typescript
// 启用 Prisma 查询日志
const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
});
```

### API 调试
```typescript
// 在 API 路由中添加日志
console.log('Request body:', body);
console.log('Validated data:', validatedData);
console.log('Database result:', result);
```

### 前端状态调试
```tsx
// React Query DevTools
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';

<ReactQueryDevtools initialIsOpen={false} />
```

## 📝 提交信息模板

```
feat(模块): 添加新功能的简短描述

详细描述功能的实现和影响：
- 添加了什么功能
- 解决了什么问题
- 有什么注意事项

相关问题: #123
```

### 常用提交类型
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建工具或依赖更新

## 🚨 常见问题解决

### 1. Prisma 连接问题
```bash
# 重新生成客户端
npx prisma generate

# 重置数据库
npx prisma db push --force-reset
```

### 2. ESLint 错误
```bash
# 自动修复
npm run lint:fix

# 跳过特定规则
// eslint-disable-next-line @typescript-eslint/no-unused-vars
```

### 3. 类型错误
```typescript
// 使用类型断言（谨慎使用）
const data = response as ApiResponse;

// 使用类型守卫
function isUser(obj: any): obj is User {
  return obj && typeof obj.id === 'string';
}
```

---

**快速参考，高效开发！** ⚡
