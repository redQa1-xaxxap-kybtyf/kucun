# ä»£ç åˆ†å±‚æ¶æ„é‡æ„è®¡åˆ’

## é‡æ„ç›®æ ‡

å°†é¡¹ç›®ä»£ç é‡æ„ä¸ºæ¸…æ™°çš„åˆ†å±‚æ¶æ„,ç¡®ä¿èŒè´£åˆ†ç¦»å’Œä»£ç å¯ç»´æŠ¤æ€§ã€‚

## åˆ†å±‚èŒè´£å®šä¹‰

### 1. ä¸šåŠ¡é€»è¾‘å±‚ (`lib/services/*`)

- âœ… é›†ä¸­æ‰€æœ‰ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®å¤„ç†
- âœ… é€šè¿‡ Prisma å®¢æˆ·ç«¯ä¸æ•°æ®åº“äº¤äº’
- âœ… è¿”å›ç±»å‹å®‰å…¨çš„æ•°æ®å¯¹è±¡(ä½¿ç”¨ Zod éªŒè¯)
- âœ… ä¸ä¾èµ– HTTP è¯·æ±‚/å“åº”å¯¹è±¡
- âœ… å¯è¢« API Route å’ŒæœåŠ¡å™¨ç»„ä»¶å¤ç”¨

### 2. API Route å±‚ (`app/api/**/route.ts`)

- âœ… èº«ä»½è®¤è¯å’Œæˆæƒæ£€æŸ¥(ä½¿ç”¨ Next-Auth)
- âœ… è¯·æ±‚å‚æ•°éªŒè¯(ä½¿ç”¨ Zod schema)
- âœ… è°ƒç”¨ `lib/services/*` ä¸­çš„ä¸šåŠ¡é€»è¾‘
- âœ… æ•°æ®åºåˆ—åŒ–å’Œ HTTP å“åº”æ ¼å¼åŒ–
- âœ… é”™è¯¯å¤„ç†å’Œç»Ÿä¸€å“åº”æ ¼å¼ `{ data, error }`
- âŒ ç¦æ­¢ç›´æ¥ä½¿ç”¨ Prisma å®¢æˆ·ç«¯æŸ¥è¯¢æ•°æ®åº“
- âŒ ç¦æ­¢ç¼–å†™ä¸šåŠ¡é€»è¾‘ä»£ç 

### 3. æœåŠ¡å™¨ç»„ä»¶å±‚ (`app/**/page.tsx`)

- âœ… ç›´æ¥è°ƒç”¨ `lib/services/*` è·å–æ•°æ®(ä¸é€šè¿‡ API)
- âœ… ä½¿ç”¨ `getServerSession()` è¿›è¡ŒæœåŠ¡ç«¯è®¤è¯
- âœ… å°†æ•°æ®ä½œä¸º props ä¼ é€’ç»™å®¢æˆ·ç«¯ç»„ä»¶

### 4. å®¢æˆ·ç«¯ç»„ä»¶å±‚ (`components/**/*.tsx`)

- âœ… UI äº¤äº’çŠ¶æ€ç®¡ç†(ä½¿ç”¨ `useState`, `useReducer`)
- âœ… è¡¨å•å¤„ç†(ä½¿ç”¨ React Hook Form + Zod)
- âœ… é€šè¿‡ TanStack Query è°ƒç”¨ API è¿›è¡Œæ•°æ®å˜æ›´
- âŒ ç¦æ­¢ç›´æ¥è°ƒç”¨ `lib/services/*`

## å·²å®Œæˆçš„é‡æ„

### âœ… åº”æ”¶è´¦æ¬¾æ¨¡å—

**æœåŠ¡å±‚æ–‡ä»¶**: `lib/services/receivables-service.ts`

- åˆ›å»ºäº†å®Œæ•´çš„åº”æ”¶è´¦æ¬¾ä¸šåŠ¡é€»è¾‘æœåŠ¡
- åŒ…å«ç±»å‹å®šä¹‰ã€è¾…åŠ©å‡½æ•°å’Œå…¬å…±æœåŠ¡å‡½æ•°
- æ”¯æŒå¤æ‚çš„æŸ¥è¯¢ã€è¿‡æ»¤ã€æ’åºå’Œåˆ†é¡µ
- è®¡ç®—æ”¯ä»˜çŠ¶æ€å’Œé€¾æœŸå¤©æ•°

**API Route é‡æ„**: `app/api/finance/receivables/route.ts`

- ä» 398 è¡Œå‡å°‘åˆ° 129 è¡Œ(å‡å°‘ 67%)
- ç§»é™¤æ‰€æœ‰ Prisma æŸ¥è¯¢å’Œä¸šåŠ¡é€»è¾‘
- åªä¿ç•™è®¤è¯ã€éªŒè¯ã€è°ƒç”¨æœåŠ¡ã€è¿”å›å“åº”
- ä»£ç æ¸…æ™°,èŒè´£æ˜ç¡®

**é‡æ„æ•ˆæœ**:

- âœ… ä»£ç è¡Œæ•°å‡å°‘ 67%
- âœ… ä¸šåŠ¡é€»è¾‘å¯å¤ç”¨(API å’ŒæœåŠ¡å™¨ç»„ä»¶å…±äº«)
- âœ… æ›´æ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- âœ… ç¬¦åˆ Next.js 15 App Router æœ€ä½³å®è·µ
- âœ… æ—  TypeScript ç±»å‹é”™è¯¯

## å¾…é‡æ„çš„æ¨¡å—

### ğŸ”´ é«˜ä¼˜å…ˆçº§(ç›´æ¥ä½¿ç”¨ Prisma ä¸”ä¸šåŠ¡é€»è¾‘å¤æ‚)

1. **åˆ†ç±»ç®¡ç†** (`app/api/categories/route.ts`)
   - å½“å‰çŠ¶æ€: ç›´æ¥ä½¿ç”¨ Prisma æŸ¥è¯¢
   - éœ€è¦åˆ›å»º: `lib/services/category-service.ts`
   - ä¸šåŠ¡é€»è¾‘: åˆ†ç±»æŸ¥è¯¢ã€åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ã€å±‚çº§å…³ç³»å¤„ç†

2. **äº§å“æœç´¢** (`app/api/products/search/route.ts`)
   - å½“å‰çŠ¶æ€: ç›´æ¥ä½¿ç”¨ Prisma æŸ¥è¯¢å’Œèšåˆ
   - éœ€è¦åˆ›å»º: `lib/services/product-search-service.ts`
   - ä¸šåŠ¡é€»è¾‘: äº§å“æœç´¢ã€åº“å­˜æ±‡æ€»ã€æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

3. **ä¾›åº”å•†ç®¡ç†** (`app/api/suppliers/route.ts`)
   - å½“å‰çŠ¶æ€: ç›´æ¥ä½¿ç”¨ Prisma æŸ¥è¯¢
   - éœ€è¦åˆ›å»º: `lib/services/supplier-service.ts`
   - ä¸šåŠ¡é€»è¾‘: ä¾›åº”å•†æŸ¥è¯¢ã€åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤

4. **åº“å­˜é¢„è­¦** (`app/api/inventory/alerts/route.ts`)
   - å½“å‰çŠ¶æ€: ç›´æ¥ä½¿ç”¨ Prisma æŸ¥è¯¢
   - éœ€è¦åˆ›å»º: `lib/services/inventory-alert-service.ts`
   - ä¸šåŠ¡é€»è¾‘: ä½åº“å­˜æ£€æµ‹ã€é›¶åº“å­˜æ£€æµ‹ã€é¢„è­¦ç»Ÿè®¡

5. **ä»ªè¡¨ç›˜é¢„è­¦** (`app/api/dashboard/alerts/route.ts`)
   - å½“å‰çŠ¶æ€: ç›´æ¥ä½¿ç”¨ Prisma æŸ¥è¯¢
   - éœ€è¦åˆ›å»º: `lib/services/dashboard-service.ts`
   - ä¸šåŠ¡é€»è¾‘: åº“å­˜é¢„è­¦æ±‡æ€»ã€ç»Ÿè®¡æ•°æ®

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§(å·²æœ‰éƒ¨åˆ†æœåŠ¡å±‚æŠ½è±¡)

6. **å®¢æˆ·ç®¡ç†** (`app/api/customers/[id]/route.ts`)
   - å½“å‰çŠ¶æ€: å·²ä½¿ç”¨ `lib/api/customer-handlers.ts` éƒ¨åˆ†æŠ½è±¡
   - éœ€è¦ä¼˜åŒ–: å°† handlers ç§»è‡³ `lib/services/customer-service.ts`
   - ä¸šåŠ¡é€»è¾‘: å®¢æˆ·è¯¦æƒ…ã€æ›´æ–°ã€åˆ é™¤

7. **å¾€æ¥è´¦å•** (`app/api/statements/[id]/route.ts`)
   - å½“å‰çŠ¶æ€: å·²ä½¿ç”¨ `lib/api/handlers/statement-details.ts` éƒ¨åˆ†æŠ½è±¡
   - éœ€è¦ä¼˜åŒ–: å°† handlers ç§»è‡³ `lib/services/statement-service.ts`
   - ä¸šåŠ¡é€»è¾‘: è´¦å•è¯¦æƒ…ã€è´¢åŠ¡è®¡ç®—ã€é€¾æœŸè®¡ç®—

8. **å…¥åº“ç®¡ç†** (`app/api/inventory/inbound/route.ts`)
   - å½“å‰çŠ¶æ€: å·²ä½¿ç”¨ `lib/api/inbound-handlers.ts` éƒ¨åˆ†æŠ½è±¡
   - éœ€è¦ä¼˜åŒ–: å°† handlers ç§»è‡³ `lib/services/inbound-service.ts`
   - ä¸šåŠ¡é€»è¾‘: å…¥åº“è®°å½•ã€åº“å­˜æ›´æ–°

9. **æ‰¹æ¬¡è§„æ ¼** (`app/api/batch-specifications/[id]/route.ts`)
   - å½“å‰çŠ¶æ€: å·²ä½¿ç”¨ `lib/api/batch-specification-handlers.ts` éƒ¨åˆ†æŠ½è±¡
   - éœ€è¦ä¼˜åŒ–: å°† handlers ç§»è‡³ `lib/services/batch-specification-service.ts`
   - ä¸šåŠ¡é€»è¾‘: æ‰¹æ¬¡è§„æ ¼æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤

### ğŸŸ¢ ä½ä¼˜å…ˆçº§(ç®€å•æŸ¥è¯¢æˆ–é™æ€æ•°æ®)

10. **å®¢æˆ·æœç´¢** (`app/api/customers/search/route.ts`)
    - ç®€å•çš„æœç´¢æŸ¥è¯¢,å¯ä»¥ä¿æŒç°çŠ¶æˆ–å¿«é€Ÿé‡æ„

11. **ä»·æ ¼å†å²** (`app/api/price-history/supplier/route.ts`, `app/api/price-history/customer/route.ts`)
    - ä½¿ç”¨åŸç”Ÿ SQL æŸ¥è¯¢,éœ€è¦ç‰¹æ®Šå¤„ç†

12. **åœ°å€æ•°æ®** (`app/api/address/provinces/route.ts`, `app/api/address/districts/route.ts`)
    - é™æ€æ•°æ®,æ— éœ€é‡æ„

13. **æµ‹è¯•æ•°æ®ç”Ÿæˆ** (`app/api/seed-test-data/route.ts`)
    - å·²ä½¿ç”¨ `lib/api/handlers/seed-data.ts`,å¯ä»¥ä¿æŒç°çŠ¶

## é‡æ„æ­¥éª¤æ¨¡æ¿

å¯¹äºæ¯ä¸ªéœ€è¦é‡æ„çš„æ¨¡å—:

### 1. åˆ›å»ºæœåŠ¡å±‚æ–‡ä»¶

```typescript
// lib/services/[module]-service.ts

/**
 * [æ¨¡å—åç§°]ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚
 * èŒè´£:
 * - å°è£…æ‰€æœ‰[æ¨¡å—]ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
 * - é€šè¿‡ Prisma å®¢æˆ·ç«¯ä¸æ•°æ®åº“äº¤äº’
 * - è¿”å›ç±»å‹å®‰å…¨çš„æ•°æ®å¯¹è±¡
 * - å¯è¢« API Route å’ŒæœåŠ¡å™¨ç»„ä»¶å¤ç”¨
 */

import { prisma } from '@/lib/db';

// ç±»å‹å®šä¹‰
export interface [Module]QueryParams {
  // ...
}

export interface [Module]Result {
  // ...
}

// è¾…åŠ©å‡½æ•°(ç§æœ‰)
function buildWhereConditions() {
  // ...
}

// å…¬å…±æœåŠ¡å‡½æ•°
export async function get[Module]s(params: [Module]QueryParams) {
  // ä¸šåŠ¡é€»è¾‘
  const data = await prisma.[model].findMany({
    // ...
  });

  return data;
}
```

### 2. é‡æ„ API Route

```typescript
// app/api/[module]/route.ts

/**
 * [æ¨¡å—] API è·¯ç”±
 * èŒè´£:
 * - èº«ä»½è®¤è¯å’Œæˆæƒæ£€æŸ¥
 * - è¯·æ±‚å‚æ•°éªŒè¯
 * - è°ƒç”¨æœåŠ¡å±‚ä¸šåŠ¡é€»è¾‘
 * - æ•°æ®åºåˆ—åŒ–å’Œ HTTP å“åº”æ ¼å¼åŒ–
 * - é”™è¯¯å¤„ç†å’Œç»Ÿä¸€å“åº”æ ¼å¼
 */

import { get[Module]s } from '@/lib/services/[module]-service';

export async function GET(request: NextRequest) {
  try {
    // 1. èº«ä»½è®¤è¯
    const auth = verifyApiAuth(request);
    if (!auth.success) {
      return errorResponse(auth.error || 'æœªæˆæƒè®¿é—®', 401);
    }

    // 2. å‚æ•°éªŒè¯
    const params = [schema].parse(/* ... */);

    // 3. è°ƒç”¨æœåŠ¡å±‚
    const result = await get[Module]s(params);

    // 4. è¿”å›å“åº”
    return NextResponse.json({
      success: true,
      data: result,
    });
  } catch (error) {
    // é”™è¯¯å¤„ç†
  }
}
```

### 3. éªŒè¯é‡æ„

```bash
# TypeScript ç±»å‹æ£€æŸ¥
npm run type-check

# ESLint æ£€æŸ¥
npm run lint

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# æµ‹è¯•åŠŸèƒ½
# ä½¿ç”¨ Playwright æµè§ˆå™¨æµ‹è¯•
```

## é‡æ„åŸåˆ™

1. **ä¸€æ¬¡é‡æ„ä¸€ä¸ªæ¨¡å—**: é¿å…åŒæ—¶ä¿®æ”¹å¤šä¸ªæ–‡ä»¶å¯¼è‡´é—®é¢˜éš¾ä»¥å®šä½
2. **ä¿æŒå‘åå…¼å®¹**: ç¡®ä¿ API å“åº”æ ¼å¼ä¸å˜
3. **ç±»å‹å®‰å…¨ä¼˜å…ˆ**: ä½¿ç”¨ TypeScript å’Œ Zod ç¡®ä¿ç±»å‹å®‰å…¨
4. **æµ‹è¯•é©±åŠ¨**: é‡æ„åç«‹å³æµ‹è¯•åŠŸèƒ½
5. **ä»£ç å®¡æŸ¥**: ç¡®ä¿é‡æ„åçš„ä»£ç ç¬¦åˆè§„èŒƒ

## é¢„æœŸæˆæœ

- âœ… æ¸…æ™°çš„ä»£ç åˆ†å±‚,èŒè´£æ˜ç¡®
- âœ… ä¸šåŠ¡é€»è¾‘å¯å¤ç”¨(API å’ŒæœåŠ¡å™¨ç»„ä»¶å…±äº«)
- âœ… æ›´æ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- âœ… ç¬¦åˆ Next.js 15 App Router æœ€ä½³å®è·µ
- âœ… ä»£ç è¡Œæ•°å‡å°‘ 50-70%
- âœ… æ—  TypeScript ç±»å‹é”™è¯¯
- âœ… é€šè¿‡æ‰€æœ‰ ESLint æ£€æŸ¥

## è¿›åº¦è·Ÿè¸ª

- [x] åº”æ”¶è´¦æ¬¾æ¨¡å— (`lib/services/receivables-service.ts`) - å‡å°‘ 67%
- [x] åˆ†ç±»ç®¡ç†æ¨¡å— (`lib/services/category-service.ts`) - å‡å°‘ 62%
- [x] ä¾›åº”å•†ç®¡ç†æ¨¡å— (`lib/services/supplier-service.ts`) - å‡å°‘ 37%
- [ ] äº§å“æœç´¢æ¨¡å—
- [ ] åº“å­˜é¢„è­¦æ¨¡å—
- [ ] ä»ªè¡¨ç›˜é¢„è­¦æ¨¡å—
- [ ] å®¢æˆ·ç®¡ç†æ¨¡å—ä¼˜åŒ–
- [ ] å¾€æ¥è´¦å•æ¨¡å—ä¼˜åŒ–
- [ ] å…¥åº“ç®¡ç†æ¨¡å—ä¼˜åŒ–
- [ ] æ‰¹æ¬¡è§„æ ¼æ¨¡å—ä¼˜åŒ–

---

**æœ€åæ›´æ–°**: 2025-10-03
**é‡æ„è´Ÿè´£äºº**: AI Assistant
**å®¡æ ¸çŠ¶æ€**: è¿›è¡Œä¸­
**å·²å®Œæˆ**: 3/10 æ¨¡å—
