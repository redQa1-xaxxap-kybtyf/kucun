# 登录功能测试指南

## 📅 测试日期

2025-10-01

## 🎯 测试目标

验证所有登录功能改进是否按预期工作,包括:

1. 验证码功能
2. 登录日志记录
3. 登录失败次数限制
4. 错误提示准确性
5. 安全性改进

---

## 🧪 测试环境

- **服务器地址**: http://localhost:3003
- **登录页面**: http://localhost:3003/auth/signin
- **测试账户**:
  - 管理员: `admin` / `admin123456`
  - 销售员: `sales` / `sales123456`

---

## 📋 测试用例

### 1. ✅ 正常登录流程

**测试步骤**:

1. 访问登录页面
2. 输入正确的用户名: `admin`
3. 输入正确的密码: `admin123456`
4. 输入正确的验证码
5. 点击"登录"按钮

**预期结果**:

- ✅ 登录成功,跳转到仪表盘
- ✅ 服务器日志显示: `[登录日志] type: success`
- ✅ Redis 中的失败次数被重置

**检查点**:

- [ ] 登录成功
- [ ] 跳转到 `/dashboard`
- [ ] 服务器日志记录成功
- [ ] 失败次数重置

---

### 2. ❌ 用户名不存在

**测试步骤**:

1. 访问登录页面
2. 输入不存在的用户名: `nonexistent`
3. 输入任意密码: `password123`
4. 输入正确的验证码
5. 点击"登录"按钮

**预期结果**:

- ❌ 登录失败
- ❌ 显示错误: "用户名或密码错误，请检查后重试"
- ✅ 服务器日志显示: `[登录日志] type: failed, failureReason: invalid_credentials`
- ✅ Redis 中的失败次数 +1

**检查点**:

- [ ] 登录失败
- [ ] 错误提示正确
- [ ] 不泄露用户是否存在
- [ ] 失败次数增加

---

### 3. ❌ 密码错误

**测试步骤**:

1. 访问登录页面
2. 输入正确的用户名: `admin`
3. 输入错误的密码: `wrongpassword`
4. 输入正确的验证码
5. 点击"登录"按钮

**预期结果**:

- ❌ 登录失败
- ❌ 显示错误: "用户名或密码错误，请检查后重试"
- ✅ 服务器日志显示: `[登录日志] type: failed, failureReason: invalid_credentials`
- ✅ Redis 中的失败次数 +1

**检查点**:

- [ ] 登录失败
- [ ] 错误提示正确
- [ ] 不泄露密码错误
- [ ] 失败次数增加

---

### 4. ❌ 验证码错误

**测试步骤**:

1. 访问登录页面
2. 输入正确的用户名: `admin`
3. 输入正确的密码: `admin123456`
4. 输入错误的验证码: `XXXX`
5. 点击"登录"按钮

**预期结果**:

- ❌ 登录失败
- ❌ 显示错误: "验证码错误，请重新输入"
- ✅ 服务器日志显示: `[登录日志] type: failed, failureReason: captcha_incorrect`
- ✅ Redis 中的失败次数 +1

**检查点**:

- [ ] 登录失败
- [ ] 错误提示正确
- [ ] 验证码被刷新
- [ ] 失败次数增加

---

### 5. ❌ 验证码过期

**测试步骤**:

1. 访问登录页面
2. 等待 5 分钟(验证码过期时间)
3. 输入正确的用户名和密码
4. 输入验证码(已过期)
5. 点击"登录"按钮

**预期结果**:

- ❌ 登录失败
- ❌ 显示错误: "验证码会话已过期，请刷新验证码"
- ✅ 服务器日志显示验证码过期

**检查点**:

- [ ] 登录失败
- [ ] 错误提示正确
- [ ] 提示刷新验证码

---

### 6. ❌ 验证码重复使用

**测试步骤**:

1. 访问登录页面
2. 输入正确的用户名、密码和验证码
3. 点击"登录"按钮(登录成功)
4. 退出登录
5. 再次访问登录页面
6. 使用相同的验证码尝试登录

**预期结果**:

- ❌ 第二次登录失败
- ❌ 显示错误: "验证码会话已过期，请刷新验证码"
- ✅ 验证码会话已被删除

**检查点**:

- [ ] 第一次登录成功
- [ ] 验证码被删除
- [ ] 第二次登录失败
- [ ] 错误提示正确

---

### 7. ❌ 登录失败次数限制

**测试步骤**:

1. 访问登录页面
2. 连续 5 次输入错误的密码
3. 第 6 次尝试登录

**预期结果**:

- ❌ 前 5 次显示: "用户名或密码错误，请检查后重试"
- ❌ 第 6 次显示: "登录失败次数过多，请稍后再试"
- ✅ 服务器日志显示: `[登录日志] type: blocked, failureReason: too_many_attempts`
- ✅ 15 分钟内无法登录

**检查点**:

- [ ] 前 5 次正常提示
- [ ] 第 6 次被阻止
- [ ] 错误提示正确
- [ ] 15 分钟后可以登录

---

### 8. ❌ 账户被禁用

**测试步骤**:

1. 在数据库中将用户状态改为 `inactive`
2. 访问登录页面
3. 输入正确的用户名、密码和验证码
4. 点击"登录"按钮

**预期结果**:

- ❌ 登录失败
- ❌ 显示错误: "该账户已被禁用，请联系管理员"
- ✅ 服务器日志显示: `[登录日志] type: failed, failureReason: account_disabled`

**检查点**:

- [ ] 登录失败
- [ ] 错误提示正确
- [ ] 提示联系管理员

---

### 9. ✅ IP 变化记录

**测试步骤**:

1. 从 IP A 访问登录页面并获取验证码
2. 切换到 IP B(使用 VPN 或代理)
3. 使用相同的验证码登录

**预期结果**:

- ✅ 登录成功(不阻止)
- ✅ 服务器日志显示: `[安全审计] 验证码 IP 变化`
- ✅ 记录 IP 变化但不影响登录

**检查点**:

- [ ] 登录成功
- [ ] IP 变化被记录
- [ ] 不阻止登录

---

### 10. ✅ 验证码会话存储在 Redis

**测试步骤**:

1. 访问登录页面获取验证码
2. 使用 Redis CLI 查看会话: `redis-cli keys "captcha:*"`
3. 查看会话详情: `redis-cli get "captcha:<sessionId>"`

**预期结果**:

- ✅ Redis 中存在验证码会话
- ✅ 会话包含: sessionId, captchaText, clientIp, expiresAt, attempts
- ✅ 会话有 TTL(5 分钟)

**检查点**:

- [ ] Redis 中有会话
- [ ] 会话数据完整
- [ ] TTL 正确设置

---

## 🔍 日志检查

### 服务器日志

登录时应该看到以下日志:

```bash
# 登录成功
[登录日志] {
  type: 'success',
  username: 'admin',
  userId: 'xxx',
  clientIp: '127.0.0.1',
  userAgent: 'Mozilla/5.0...',
  timestamp: '2025-10-01T...'
}

# 登录失败
[登录日志] {
  type: 'failed',
  username: 'admin',
  failureReason: 'invalid_credentials',
  clientIp: '127.0.0.1',
  userAgent: 'Mozilla/5.0...',
  timestamp: '2025-10-01T...'
}

# 登录被阻止
[登录日志] {
  type: 'blocked',
  username: 'admin',
  failureReason: 'too_many_attempts',
  clientIp: '127.0.0.1',
  userAgent: 'Mozilla/5.0...',
  timestamp: '2025-10-01T...'
}
```

### Redis 检查

```bash
# 查看所有验证码会话
redis-cli keys "captcha:*"

# 查看登录失败次数
redis-cli keys "login:attempts:*"

# 查看具体值
redis-cli get "login:attempts:admin"
redis-cli get "login:attempts:127.0.0.1"

# 查看 TTL
redis-cli ttl "login:attempts:admin"
```

---

## 📊 测试结果记录

| 测试用例            | 状态      | 备注 |
| ------------------- | --------- | ---- |
| 1. 正常登录流程     | ⏳ 待测试 |      |
| 2. 用户名不存在     | ⏳ 待测试 |      |
| 3. 密码错误         | ⏳ 待测试 |      |
| 4. 验证码错误       | ⏳ 待测试 |      |
| 5. 验证码过期       | ⏳ 待测试 |      |
| 6. 验证码重复使用   | ⏳ 待测试 |      |
| 7. 登录失败次数限制 | ⏳ 待测试 |      |
| 8. 账户被禁用       | ⏳ 待测试 |      |
| 9. IP 变化记录      | ⏳ 待测试 |      |
| 10. Redis 存储      | ⏳ 待测试 |      |

---

## 🎯 测试通过标准

- ✅ 所有 10 个测试用例通过
- ✅ 服务器日志正确记录
- ✅ Redis 数据正确存储
- ✅ 错误提示准确友好
- ✅ 安全性符合要求

---

**测试人员**: ******\_******  
**测试日期**: ******\_******  
**测试结果**: ⏳ 待测试
