# 产品管理模块修复方案

## 🎯 修复目标

将产品管理模块的代码质量从 **83.6分** 提升到 **90+分**，确保完全符合全栈开发执行手册的技术规范。

---

## 🔴 高优先级修复 (立即执行)

### 1. 统一分页默认值

**问题**: API默认limit=20，前端默认limit=10，导致数据显示不一致

**修复文件**: 
- `app/api/products/route.ts` (第28行)
- `app/(dashboard)/products/page.tsx` (第89行)

**修复代码**:

```typescript
// app/api/products/route.ts
const queryParams = {
  page: parseInt(searchParams.get('page') || '1'),
  limit: parseInt(searchParams.get('limit') || '10'), // 改为10
  // ... 其他参数
};

// app/(dashboard)/products/page.tsx - 已经是10，无需修改
const [queryParams, setQueryParams] = React.useState<ProductQueryParams>({
  page: 1,
  limit: 10, // ✅ 保持10
  // ... 其他参数
});
```

### 2. 修复API客户端credentials配置

**问题**: 大部分API调用缺少`credentials: 'include'`配置

**修复文件**: `lib/api/products.ts`

**修复代码**:

```typescript
// lib/api/products.ts - 创建统一配置
const API_CONFIG = {
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include' as RequestCredentials,
};

// 修复所有API函数
export async function getProducts(params: ProductQueryParams = {}) {
  // ... URL构建逻辑
  const response = await fetch(url, {
    method: 'GET',
    ...API_CONFIG,
  });
  // ... 其余代码
}

export async function createProduct(productData: ProductCreateInput) {
  const response = await fetch(API_BASE, {
    method: 'POST',
    ...API_CONFIG,
    body: JSON.stringify(productData),
  });
  // ... 其余代码
}

export async function updateProduct(id: string, productData: ProductUpdateInput) {
  const response = await fetch(`${API_BASE}/${id}`, {
    method: 'PUT',
    ...API_CONFIG,
    body: JSON.stringify(productData),
  });
  // ... 其余代码
}

export async function deleteProduct(id: string) {
  const response = await fetch(`${API_BASE}/${id}`, {
    method: 'DELETE',
    ...API_CONFIG,
  });
  // ... 其余代码
}

export async function batchDeleteProducts(input: BatchDeleteProductsInput) {
  const response = await fetch(`${API_BASE}/batch`, {
    method: 'DELETE',
    ...API_CONFIG,
    body: JSON.stringify(input),
  });
  // ... 其余代码
}
```

### 3. 合并重复的验证规则

**问题**: `lib/validations/product.ts` 和 `lib/schemas/product.ts` 中有重复定义

**解决方案**: 统一使用 `lib/schemas/product.ts`，删除 `lib/validations/product.ts` 中的重复部分

**修复步骤**:

1. **保留** `lib/schemas/product.ts` 作为主要验证规则
2. **更新** `lib/validations/product.ts` 只保留表单特定的验证
3. **更新** 所有导入引用

```typescript
// lib/validations/product.ts - 简化版本
import { 
  CreateProductSchema, 
  UpdateProductSchema,
  ProductQuerySchema 
} from '@/lib/schemas/product';

// 只保留表单特定的扩展验证
export const productCreateSchema = CreateProductSchema;
export const productUpdateSchema = UpdateProductSchema;
export const productSearchSchema = ProductQuerySchema;

// 表单默认值
export const productCreateDefaults = {
  code: '',
  name: '',
  specification: '',
  unit: 'piece' as const,
  piecesPerUnit: 1,
  weight: undefined,
  thickness: undefined,
  status: 'active' as const,
  categoryId: undefined,
  specifications: {},
};
```

---

## 🟡 中优先级修复 (1周内完成)

### 4. 优化数据库查询性能

**问题**: 产品列表查询可能存在性能问题

**修复文件**: `app/api/products/route.ts`

**修复代码**:

```typescript
// app/api/products/route.ts - 优化查询
export async function GET(request: NextRequest) {
  // ... 验证和参数解析

  // 优化查询字段选择
  const selectFields = {
    id: true,
    code: true,
    name: true,
    specification: true,
    unit: true,
    piecesPerUnit: true,
    weight: true,
    thickness: true,
    status: true,
    categoryId: true,
    createdAt: true,
    updatedAt: true,
    // 使用include替代嵌套select，性能更好
  };

  const includeRelations = {
    category: {
      select: {
        id: true,
        name: true,
        code: true,
      },
    },
  };

  // 添加排序优化
  const orderBy = {
    [sortBy]: sortOrder,
  };

  const [products, total] = await Promise.all([
    prisma.product.findMany({
      where,
      select: selectFields,
      include: includeRelations,
      orderBy,
      skip: (page - 1) * limit,
      take: limit,
    }),
    prisma.product.count({ where }),
  ]);

  // ... 其余代码
}
```

**数据库索引建议**:

```sql
-- 添加复合索引提升查询性能
CREATE INDEX idx_products_search ON products(name, code, specification);
CREATE INDEX idx_products_status_unit ON products(status, unit);
CREATE INDEX idx_products_category_created ON products(category_id, created_at);
CREATE INDEX idx_products_created_at ON products(created_at DESC);
```

### 5. 创建通用数字输入Hook

**问题**: 数字字段处理逻辑重复

**新建文件**: `hooks/useNumberInput.ts`

```typescript
// hooks/useNumberInput.ts
import { useCallback } from 'react';

interface UseNumberInputOptions {
  min?: number;
  max?: number;
  step?: number;
  allowDecimals?: boolean;
}

export function useNumberInput(
  onChange: (value: number | undefined) => void,
  options: UseNumberInputOptions = {}
) {
  const { min, max, allowDecimals = true } = options;

  const handleChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      const value = e.target.value.trim();
      
      if (value === '') {
        onChange(undefined);
        return;
      }

      const numValue = Number(value);
      
      // 验证数字格式
      if (isNaN(numValue)) {
        return; // 不更新无效值
      }

      // 验证小数位
      if (!allowDecimals && !Number.isInteger(numValue)) {
        return;
      }

      // 验证范围
      if (min !== undefined && numValue < min) {
        return;
      }
      if (max !== undefined && numValue > max) {
        return;
      }

      onChange(numValue);
    },
    [onChange, min, max, allowDecimals]
  );

  return handleChange;
}
```

**更新表单组件**:

```typescript
// app/(dashboard)/products/create/page.tsx
import { useNumberInput } from '@/hooks/useNumberInput';

export default function CreateProductPage() {
  // ... 现有代码

  // 使用自定义hook
  const handlePiecesPerUnitChange = useNumberInput(
    (value) => form.setValue('piecesPerUnit', value),
    { min: 1, allowDecimals: false }
  );

  const handleWeightChange = useNumberInput(
    (value) => form.setValue('weight', value),
    { min: 0, step: 0.01 }
  );

  const handleThicknessChange = useNumberInput(
    (value) => form.setValue('thickness', value),
    { min: 0, max: 100, step: 0.1 }
  );

  // 在表单字段中使用
  <FormField
    control={form.control}
    name="piecesPerUnit"
    render={({ field }) => (
      <FormItem>
        <FormLabel>每单位片数</FormLabel>
        <FormControl>
          <Input
            type="number"
            placeholder="请输入每单位片数"
            value={field.value ?? ''}
            onChange={handlePiecesPerUnitChange}
          />
        </FormControl>
        <FormMessage />
      </FormItem>
    )}
  />
}
```

### 6. 添加错误边界组件

**新建文件**: `components/common/ErrorBoundary.tsx`

```typescript
// components/common/ErrorBoundary.tsx
'use client';

import React from 'react';
import { AlertTriangle, RefreshCw } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

interface ErrorBoundaryState {
  hasError: boolean;
  error?: Error;
}

interface ErrorBoundaryProps {
  children: React.ReactNode;
  fallback?: React.ComponentType<{ error?: Error; reset: () => void }>;
}

export class ErrorBoundary extends React.Component<
  ErrorBoundaryProps,
  ErrorBoundaryState
> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('ErrorBoundary caught an error:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      const FallbackComponent = this.props.fallback || DefaultErrorFallback;
      return (
        <FallbackComponent
          error={this.state.error}
          reset={() => this.setState({ hasError: false, error: undefined })}
        />
      );
    }

    return this.props.children;
  }
}

function DefaultErrorFallback({ 
  error, 
  reset 
}: { 
  error?: Error; 
  reset: () => void; 
}) {
  return (
    <Card className="mx-auto max-w-md">
      <CardHeader>
        <CardTitle className="flex items-center gap-2 text-red-600">
          <AlertTriangle className="h-5 w-5" />
          出现错误
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <p className="text-sm text-muted-foreground">
          {error?.message || '页面加载时发生了未知错误'}
        </p>
        <Button onClick={reset} className="w-full">
          <RefreshCw className="mr-2 h-4 w-4" />
          重新加载
        </Button>
      </CardContent>
    </Card>
  );
}
```

**在页面中使用**:

```typescript
// app/(dashboard)/products/page.tsx
import { ErrorBoundary } from '@/components/common/ErrorBoundary';

export default function ProductsPage() {
  return (
    <ErrorBoundary>
      {/* 现有页面内容 */}
    </ErrorBoundary>
  );
}
```

---

## 🟢 长期优化 (1个月内完成)

### 7. 性能优化

**优化组件渲染**:

```typescript
// app/(dashboard)/products/page.tsx
import React from 'react';

export default function ProductsPage() {
  // 缓存移动端列配置
  const mobileColumns = React.useMemo(() => [
    { key: 'name', title: '产品名称', mobilePrimary: true },
    { key: 'code', title: '产品编码', mobileLabel: '编码' },
    // ... 其他配置
  ], []);

  // 缓存状态标签渲染函数
  const getStatusBadge = React.useCallback((status: string) => {
    const variant = status === 'active' ? 'default' : 'secondary';
    return (
      <Badge variant={variant}>
        {PRODUCT_STATUS_LABELS[status as keyof typeof PRODUCT_STATUS_LABELS] || status}
      </Badge>
    );
  }, []);

  // 缓存事件处理函数
  const handleSearch = React.useCallback((value: string) => {
    setQueryParams(prev => ({ ...prev, search: value, page: 1 }));
  }, []);

  const handleFilter = React.useCallback((key: keyof ProductQueryParams, value: any) => {
    setQueryParams(prev => ({ ...prev, [key]: value, page: 1 }));
  }, []);

  // ... 其余代码
}
```

### 8. 添加单元测试

**新建文件**: `__tests__/lib/api/products.test.ts`

```typescript
// __tests__/lib/api/products.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { getProducts, createProduct } from '@/lib/api/products';

// Mock fetch
global.fetch = vi.fn();

describe('Products API', () => {
  beforeEach(() => {
    vi.resetAllMocks();
  });

  describe('getProducts', () => {
    it('should fetch products with correct parameters', async () => {
      const mockResponse = {
        success: true,
        data: [],
        pagination: { page: 1, limit: 10, total: 0, totalPages: 0 },
      };

      (fetch as any).mockResolvedValueOnce({
        ok: true,
        json: async () => mockResponse,
      });

      const result = await getProducts({ page: 1, limit: 10 });

      expect(fetch).toHaveBeenCalledWith(
        '/api/products?page=1&limit=10',
        expect.objectContaining({
          method: 'GET',
          credentials: 'include',
        })
      );
      expect(result).toEqual(mockResponse);
    });
  });

  describe('createProduct', () => {
    it('should create product with correct data', async () => {
      const productData = {
        code: 'TEST001',
        name: 'Test Product',
        unit: 'piece' as const,
      };

      const mockResponse = {
        success: true,
        data: { id: '1', ...productData },
      };

      (fetch as any).mockResolvedValueOnce({
        ok: true,
        json: async () => mockResponse,
      });

      const result = await createProduct(productData);

      expect(fetch).toHaveBeenCalledWith(
        '/api/products',
        expect.objectContaining({
          method: 'POST',
          credentials: 'include',
          body: JSON.stringify(productData),
        })
      );
      expect(result).toEqual(mockResponse.data);
    });
  });
});
```

---

## 📋 修复检查清单

### 🔴 高优先级 (必须完成)

- [ ] 统一API和前端的分页默认值为10
- [ ] 为所有API调用添加`credentials: 'include'`配置
- [ ] 合并重复的验证规则定义
- [ ] 测试所有修复后的功能

### 🟡 中优先级 (建议完成)

- [ ] 优化数据库查询性能
- [ ] 创建通用数字输入Hook
- [ ] 添加错误边界组件
- [ ] 添加数据库索引

### 🟢 长期优化 (可选完成)

- [ ] 添加React性能优化
- [ ] 编写单元测试
- [ ] 完善API文档
- [ ] 添加组件文档

---

## 🎯 预期效果

完成所有修复后，预期达到的效果：

| 评估维度 | 修复前 | 修复后 | 提升 |
|---------|--------|--------|------|
| **技术栈合规性** | 85/100 | 95/100 | +10 |
| **类型安全** | 90/100 | 95/100 | +5 |
| **性能优化** | 75/100 | 90/100 | +15 |
| **错误处理** | 80/100 | 90/100 | +10 |
| **代码质量** | 88/100 | 95/100 | +7 |

**总体评分**: **83.6/100** → **93/100** (+9.4分)

---

## 🚀 实施计划

### 第1天: 高优先级修复
- 上午: 统一分页默认值
- 下午: 修复API客户端配置

### 第2天: 验证规则整理
- 上午: 合并重复验证规则
- 下午: 测试所有修复功能

### 第3-7天: 中优先级优化
- 第3天: 数据库查询优化
- 第4天: 创建数字输入Hook
- 第5天: 添加错误边界
- 第6-7天: 测试和调试

### 第2-4周: 长期优化
- 性能优化和单元测试
- 文档完善
- 代码审查和最终测试

完成后将产品管理模块打造成项目的**标杆模块**，为其他模块提供最佳实践参考。
