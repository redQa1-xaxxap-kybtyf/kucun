# äº§å“ç®¡ç†æ¨¡å—ä¿®å¤æ–¹æ¡ˆ

## ğŸ¯ ä¿®å¤ç›®æ ‡

å°†äº§å“ç®¡ç†æ¨¡å—çš„ä»£ç è´¨é‡ä» **83.6åˆ†** æå‡åˆ° **90+åˆ†**ï¼Œç¡®ä¿å®Œå…¨ç¬¦åˆå…¨æ ˆå¼€å‘æ‰§è¡Œæ‰‹å†Œçš„æŠ€æœ¯è§„èŒƒã€‚

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§ä¿®å¤ (ç«‹å³æ‰§è¡Œ)

### 1. ç»Ÿä¸€åˆ†é¡µé»˜è®¤å€¼

**é—®é¢˜**: APIé»˜è®¤limit=20ï¼Œå‰ç«¯é»˜è®¤limit=10ï¼Œå¯¼è‡´æ•°æ®æ˜¾ç¤ºä¸ä¸€è‡´

**ä¿®å¤æ–‡ä»¶**: 
- `app/api/products/route.ts` (ç¬¬28è¡Œ)
- `app/(dashboard)/products/page.tsx` (ç¬¬89è¡Œ)

**ä¿®å¤ä»£ç **:

```typescript
// app/api/products/route.ts
const queryParams = {
  page: parseInt(searchParams.get('page') || '1'),
  limit: parseInt(searchParams.get('limit') || '10'), // æ”¹ä¸º10
  // ... å…¶ä»–å‚æ•°
};

// app/(dashboard)/products/page.tsx - å·²ç»æ˜¯10ï¼Œæ— éœ€ä¿®æ”¹
const [queryParams, setQueryParams] = React.useState<ProductQueryParams>({
  page: 1,
  limit: 10, // âœ… ä¿æŒ10
  // ... å…¶ä»–å‚æ•°
});
```

### 2. ä¿®å¤APIå®¢æˆ·ç«¯credentialsé…ç½®

**é—®é¢˜**: å¤§éƒ¨åˆ†APIè°ƒç”¨ç¼ºå°‘`credentials: 'include'`é…ç½®

**ä¿®å¤æ–‡ä»¶**: `lib/api/products.ts`

**ä¿®å¤ä»£ç **:

```typescript
// lib/api/products.ts - åˆ›å»ºç»Ÿä¸€é…ç½®
const API_CONFIG = {
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include' as RequestCredentials,
};

// ä¿®å¤æ‰€æœ‰APIå‡½æ•°
export async function getProducts(params: ProductQueryParams = {}) {
  // ... URLæ„å»ºé€»è¾‘
  const response = await fetch(url, {
    method: 'GET',
    ...API_CONFIG,
  });
  // ... å…¶ä½™ä»£ç 
}

export async function createProduct(productData: ProductCreateInput) {
  const response = await fetch(API_BASE, {
    method: 'POST',
    ...API_CONFIG,
    body: JSON.stringify(productData),
  });
  // ... å…¶ä½™ä»£ç 
}

export async function updateProduct(id: string, productData: ProductUpdateInput) {
  const response = await fetch(`${API_BASE}/${id}`, {
    method: 'PUT',
    ...API_CONFIG,
    body: JSON.stringify(productData),
  });
  // ... å…¶ä½™ä»£ç 
}

export async function deleteProduct(id: string) {
  const response = await fetch(`${API_BASE}/${id}`, {
    method: 'DELETE',
    ...API_CONFIG,
  });
  // ... å…¶ä½™ä»£ç 
}

export async function batchDeleteProducts(input: BatchDeleteProductsInput) {
  const response = await fetch(`${API_BASE}/batch`, {
    method: 'DELETE',
    ...API_CONFIG,
    body: JSON.stringify(input),
  });
  // ... å…¶ä½™ä»£ç 
}
```

### 3. åˆå¹¶é‡å¤çš„éªŒè¯è§„åˆ™

**é—®é¢˜**: `lib/validations/product.ts` å’Œ `lib/schemas/product.ts` ä¸­æœ‰é‡å¤å®šä¹‰

**è§£å†³æ–¹æ¡ˆ**: ç»Ÿä¸€ä½¿ç”¨ `lib/schemas/product.ts`ï¼Œåˆ é™¤ `lib/validations/product.ts` ä¸­çš„é‡å¤éƒ¨åˆ†

**ä¿®å¤æ­¥éª¤**:

1. **ä¿ç•™** `lib/schemas/product.ts` ä½œä¸ºä¸»è¦éªŒè¯è§„åˆ™
2. **æ›´æ–°** `lib/validations/product.ts` åªä¿ç•™è¡¨å•ç‰¹å®šçš„éªŒè¯
3. **æ›´æ–°** æ‰€æœ‰å¯¼å…¥å¼•ç”¨

```typescript
// lib/validations/product.ts - ç®€åŒ–ç‰ˆæœ¬
import { 
  CreateProductSchema, 
  UpdateProductSchema,
  ProductQuerySchema 
} from '@/lib/schemas/product';

// åªä¿ç•™è¡¨å•ç‰¹å®šçš„æ‰©å±•éªŒè¯
export const productCreateSchema = CreateProductSchema;
export const productUpdateSchema = UpdateProductSchema;
export const productSearchSchema = ProductQuerySchema;

// è¡¨å•é»˜è®¤å€¼
export const productCreateDefaults = {
  code: '',
  name: '',
  specification: '',
  unit: 'piece' as const,
  piecesPerUnit: 1,
  weight: undefined,
  thickness: undefined,
  status: 'active' as const,
  categoryId: undefined,
  specifications: {},
};
```

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ä¿®å¤ (1å‘¨å†…å®Œæˆ)

### 4. ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

**é—®é¢˜**: äº§å“åˆ—è¡¨æŸ¥è¯¢å¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜

**ä¿®å¤æ–‡ä»¶**: `app/api/products/route.ts`

**ä¿®å¤ä»£ç **:

```typescript
// app/api/products/route.ts - ä¼˜åŒ–æŸ¥è¯¢
export async function GET(request: NextRequest) {
  // ... éªŒè¯å’Œå‚æ•°è§£æ

  // ä¼˜åŒ–æŸ¥è¯¢å­—æ®µé€‰æ‹©
  const selectFields = {
    id: true,
    code: true,
    name: true,
    specification: true,
    unit: true,
    piecesPerUnit: true,
    weight: true,
    thickness: true,
    status: true,
    categoryId: true,
    createdAt: true,
    updatedAt: true,
    // ä½¿ç”¨includeæ›¿ä»£åµŒå¥—selectï¼Œæ€§èƒ½æ›´å¥½
  };

  const includeRelations = {
    category: {
      select: {
        id: true,
        name: true,
        code: true,
      },
    },
  };

  // æ·»åŠ æ’åºä¼˜åŒ–
  const orderBy = {
    [sortBy]: sortOrder,
  };

  const [products, total] = await Promise.all([
    prisma.product.findMany({
      where,
      select: selectFields,
      include: includeRelations,
      orderBy,
      skip: (page - 1) * limit,
      take: limit,
    }),
    prisma.product.count({ where }),
  ]);

  // ... å…¶ä½™ä»£ç 
}
```

**æ•°æ®åº“ç´¢å¼•å»ºè®®**:

```sql
-- æ·»åŠ å¤åˆç´¢å¼•æå‡æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_products_search ON products(name, code, specification);
CREATE INDEX idx_products_status_unit ON products(status, unit);
CREATE INDEX idx_products_category_created ON products(category_id, created_at);
CREATE INDEX idx_products_created_at ON products(created_at DESC);
```

### 5. åˆ›å»ºé€šç”¨æ•°å­—è¾“å…¥Hook

**é—®é¢˜**: æ•°å­—å­—æ®µå¤„ç†é€»è¾‘é‡å¤

**æ–°å»ºæ–‡ä»¶**: `hooks/useNumberInput.ts`

```typescript
// hooks/useNumberInput.ts
import { useCallback } from 'react';

interface UseNumberInputOptions {
  min?: number;
  max?: number;
  step?: number;
  allowDecimals?: boolean;
}

export function useNumberInput(
  onChange: (value: number | undefined) => void,
  options: UseNumberInputOptions = {}
) {
  const { min, max, allowDecimals = true } = options;

  const handleChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      const value = e.target.value.trim();
      
      if (value === '') {
        onChange(undefined);
        return;
      }

      const numValue = Number(value);
      
      // éªŒè¯æ•°å­—æ ¼å¼
      if (isNaN(numValue)) {
        return; // ä¸æ›´æ–°æ— æ•ˆå€¼
      }

      // éªŒè¯å°æ•°ä½
      if (!allowDecimals && !Number.isInteger(numValue)) {
        return;
      }

      // éªŒè¯èŒƒå›´
      if (min !== undefined && numValue < min) {
        return;
      }
      if (max !== undefined && numValue > max) {
        return;
      }

      onChange(numValue);
    },
    [onChange, min, max, allowDecimals]
  );

  return handleChange;
}
```

**æ›´æ–°è¡¨å•ç»„ä»¶**:

```typescript
// app/(dashboard)/products/create/page.tsx
import { useNumberInput } from '@/hooks/useNumberInput';

export default function CreateProductPage() {
  // ... ç°æœ‰ä»£ç 

  // ä½¿ç”¨è‡ªå®šä¹‰hook
  const handlePiecesPerUnitChange = useNumberInput(
    (value) => form.setValue('piecesPerUnit', value),
    { min: 1, allowDecimals: false }
  );

  const handleWeightChange = useNumberInput(
    (value) => form.setValue('weight', value),
    { min: 0, step: 0.01 }
  );

  const handleThicknessChange = useNumberInput(
    (value) => form.setValue('thickness', value),
    { min: 0, max: 100, step: 0.1 }
  );

  // åœ¨è¡¨å•å­—æ®µä¸­ä½¿ç”¨
  <FormField
    control={form.control}
    name="piecesPerUnit"
    render={({ field }) => (
      <FormItem>
        <FormLabel>æ¯å•ä½ç‰‡æ•°</FormLabel>
        <FormControl>
          <Input
            type="number"
            placeholder="è¯·è¾“å…¥æ¯å•ä½ç‰‡æ•°"
            value={field.value ?? ''}
            onChange={handlePiecesPerUnitChange}
          />
        </FormControl>
        <FormMessage />
      </FormItem>
    )}
  />
}
```

### 6. æ·»åŠ é”™è¯¯è¾¹ç•Œç»„ä»¶

**æ–°å»ºæ–‡ä»¶**: `components/common/ErrorBoundary.tsx`

```typescript
// components/common/ErrorBoundary.tsx
'use client';

import React from 'react';
import { AlertTriangle, RefreshCw } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

interface ErrorBoundaryState {
  hasError: boolean;
  error?: Error;
}

interface ErrorBoundaryProps {
  children: React.ReactNode;
  fallback?: React.ComponentType<{ error?: Error; reset: () => void }>;
}

export class ErrorBoundary extends React.Component<
  ErrorBoundaryProps,
  ErrorBoundaryState
> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('ErrorBoundary caught an error:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      const FallbackComponent = this.props.fallback || DefaultErrorFallback;
      return (
        <FallbackComponent
          error={this.state.error}
          reset={() => this.setState({ hasError: false, error: undefined })}
        />
      );
    }

    return this.props.children;
  }
}

function DefaultErrorFallback({ 
  error, 
  reset 
}: { 
  error?: Error; 
  reset: () => void; 
}) {
  return (
    <Card className="mx-auto max-w-md">
      <CardHeader>
        <CardTitle className="flex items-center gap-2 text-red-600">
          <AlertTriangle className="h-5 w-5" />
          å‡ºç°é”™è¯¯
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <p className="text-sm text-muted-foreground">
          {error?.message || 'é¡µé¢åŠ è½½æ—¶å‘ç”Ÿäº†æœªçŸ¥é”™è¯¯'}
        </p>
        <Button onClick={reset} className="w-full">
          <RefreshCw className="mr-2 h-4 w-4" />
          é‡æ–°åŠ è½½
        </Button>
      </CardContent>
    </Card>
  );
}
```

**åœ¨é¡µé¢ä¸­ä½¿ç”¨**:

```typescript
// app/(dashboard)/products/page.tsx
import { ErrorBoundary } from '@/components/common/ErrorBoundary';

export default function ProductsPage() {
  return (
    <ErrorBoundary>
      {/* ç°æœ‰é¡µé¢å†…å®¹ */}
    </ErrorBoundary>
  );
}
```

---

## ğŸŸ¢ é•¿æœŸä¼˜åŒ– (1ä¸ªæœˆå†…å®Œæˆ)

### 7. æ€§èƒ½ä¼˜åŒ–

**ä¼˜åŒ–ç»„ä»¶æ¸²æŸ“**:

```typescript
// app/(dashboard)/products/page.tsx
import React from 'react';

export default function ProductsPage() {
  // ç¼“å­˜ç§»åŠ¨ç«¯åˆ—é…ç½®
  const mobileColumns = React.useMemo(() => [
    { key: 'name', title: 'äº§å“åç§°', mobilePrimary: true },
    { key: 'code', title: 'äº§å“ç¼–ç ', mobileLabel: 'ç¼–ç ' },
    // ... å…¶ä»–é…ç½®
  ], []);

  // ç¼“å­˜çŠ¶æ€æ ‡ç­¾æ¸²æŸ“å‡½æ•°
  const getStatusBadge = React.useCallback((status: string) => {
    const variant = status === 'active' ? 'default' : 'secondary';
    return (
      <Badge variant={variant}>
        {PRODUCT_STATUS_LABELS[status as keyof typeof PRODUCT_STATUS_LABELS] || status}
      </Badge>
    );
  }, []);

  // ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°
  const handleSearch = React.useCallback((value: string) => {
    setQueryParams(prev => ({ ...prev, search: value, page: 1 }));
  }, []);

  const handleFilter = React.useCallback((key: keyof ProductQueryParams, value: any) => {
    setQueryParams(prev => ({ ...prev, [key]: value, page: 1 }));
  }, []);

  // ... å…¶ä½™ä»£ç 
}
```

### 8. æ·»åŠ å•å…ƒæµ‹è¯•

**æ–°å»ºæ–‡ä»¶**: `__tests__/lib/api/products.test.ts`

```typescript
// __tests__/lib/api/products.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { getProducts, createProduct } from '@/lib/api/products';

// Mock fetch
global.fetch = vi.fn();

describe('Products API', () => {
  beforeEach(() => {
    vi.resetAllMocks();
  });

  describe('getProducts', () => {
    it('should fetch products with correct parameters', async () => {
      const mockResponse = {
        success: true,
        data: [],
        pagination: { page: 1, limit: 10, total: 0, totalPages: 0 },
      };

      (fetch as any).mockResolvedValueOnce({
        ok: true,
        json: async () => mockResponse,
      });

      const result = await getProducts({ page: 1, limit: 10 });

      expect(fetch).toHaveBeenCalledWith(
        '/api/products?page=1&limit=10',
        expect.objectContaining({
          method: 'GET',
          credentials: 'include',
        })
      );
      expect(result).toEqual(mockResponse);
    });
  });

  describe('createProduct', () => {
    it('should create product with correct data', async () => {
      const productData = {
        code: 'TEST001',
        name: 'Test Product',
        unit: 'piece' as const,
      };

      const mockResponse = {
        success: true,
        data: { id: '1', ...productData },
      };

      (fetch as any).mockResolvedValueOnce({
        ok: true,
        json: async () => mockResponse,
      });

      const result = await createProduct(productData);

      expect(fetch).toHaveBeenCalledWith(
        '/api/products',
        expect.objectContaining({
          method: 'POST',
          credentials: 'include',
          body: JSON.stringify(productData),
        })
      );
      expect(result).toEqual(mockResponse.data);
    });
  });
});
```

---

## ğŸ“‹ ä¿®å¤æ£€æŸ¥æ¸…å•

### ğŸ”´ é«˜ä¼˜å…ˆçº§ (å¿…é¡»å®Œæˆ)

- [ ] ç»Ÿä¸€APIå’Œå‰ç«¯çš„åˆ†é¡µé»˜è®¤å€¼ä¸º10
- [ ] ä¸ºæ‰€æœ‰APIè°ƒç”¨æ·»åŠ `credentials: 'include'`é…ç½®
- [ ] åˆå¹¶é‡å¤çš„éªŒè¯è§„åˆ™å®šä¹‰
- [ ] æµ‹è¯•æ‰€æœ‰ä¿®å¤åçš„åŠŸèƒ½

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ (å»ºè®®å®Œæˆ)

- [ ] ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- [ ] åˆ›å»ºé€šç”¨æ•°å­—è¾“å…¥Hook
- [ ] æ·»åŠ é”™è¯¯è¾¹ç•Œç»„ä»¶
- [ ] æ·»åŠ æ•°æ®åº“ç´¢å¼•

### ğŸŸ¢ é•¿æœŸä¼˜åŒ– (å¯é€‰å®Œæˆ)

- [ ] æ·»åŠ Reactæ€§èƒ½ä¼˜åŒ–
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] å®Œå–„APIæ–‡æ¡£
- [ ] æ·»åŠ ç»„ä»¶æ–‡æ¡£

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

å®Œæˆæ‰€æœ‰ä¿®å¤åï¼Œé¢„æœŸè¾¾åˆ°çš„æ•ˆæœï¼š

| è¯„ä¼°ç»´åº¦ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|---------|--------|--------|------|
| **æŠ€æœ¯æ ˆåˆè§„æ€§** | 85/100 | 95/100 | +10 |
| **ç±»å‹å®‰å…¨** | 90/100 | 95/100 | +5 |
| **æ€§èƒ½ä¼˜åŒ–** | 75/100 | 90/100 | +15 |
| **é”™è¯¯å¤„ç†** | 80/100 | 90/100 | +10 |
| **ä»£ç è´¨é‡** | 88/100 | 95/100 | +7 |

**æ€»ä½“è¯„åˆ†**: **83.6/100** â†’ **93/100** (+9.4åˆ†)

---

## ğŸš€ å®æ–½è®¡åˆ’

### ç¬¬1å¤©: é«˜ä¼˜å…ˆçº§ä¿®å¤
- ä¸Šåˆ: ç»Ÿä¸€åˆ†é¡µé»˜è®¤å€¼
- ä¸‹åˆ: ä¿®å¤APIå®¢æˆ·ç«¯é…ç½®

### ç¬¬2å¤©: éªŒè¯è§„åˆ™æ•´ç†
- ä¸Šåˆ: åˆå¹¶é‡å¤éªŒè¯è§„åˆ™
- ä¸‹åˆ: æµ‹è¯•æ‰€æœ‰ä¿®å¤åŠŸèƒ½

### ç¬¬3-7å¤©: ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–
- ç¬¬3å¤©: æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- ç¬¬4å¤©: åˆ›å»ºæ•°å­—è¾“å…¥Hook
- ç¬¬5å¤©: æ·»åŠ é”™è¯¯è¾¹ç•Œ
- ç¬¬6-7å¤©: æµ‹è¯•å’Œè°ƒè¯•

### ç¬¬2-4å‘¨: é•¿æœŸä¼˜åŒ–
- æ€§èƒ½ä¼˜åŒ–å’Œå•å…ƒæµ‹è¯•
- æ–‡æ¡£å®Œå–„
- ä»£ç å®¡æŸ¥å’Œæœ€ç»ˆæµ‹è¯•

å®Œæˆåå°†äº§å“ç®¡ç†æ¨¡å—æ‰“é€ æˆé¡¹ç›®çš„**æ ‡æ†æ¨¡å—**ï¼Œä¸ºå…¶ä»–æ¨¡å—æä¾›æœ€ä½³å®è·µå‚è€ƒã€‚
