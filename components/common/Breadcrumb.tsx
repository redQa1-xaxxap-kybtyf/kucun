'use client';

import { ChevronRight } from 'lucide-react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import * as React from 'react';

import { Button } from '@/components/ui/button';
import type { BreadcrumbItem } from '@/lib/types/layout';
import { cn } from '@/lib/utils';


interface BreadcrumbProps {
  /** 自定义面包屑项 */
  items?: BreadcrumbItem[];
  /** 是否显示首页链接 */
  showHome?: boolean;
  /** 自定义样式类名 */
  className?: string;
  /** 分隔符 */
  separator?: React.ReactNode;
}

/**
 * 路径到标题的映射
 */
const PATH_TITLES: Record<string, string> = {
  // 主要页面
  '/dashboard': '仪表盘',
  '/inventory': '库存管理',
  '/products': '产品管理',
  '/sales-orders': '销售订单',
  '/return-orders': '退货订单',
  '/customers': '客户管理',
  '/payments': '支付管理',
  '/settings': '系统设置',
  '/help': '帮助中心',
  '/profile': '个人资料',
  '/categories': '分类管理',

  // 库存管理子页面
  '/inventory/inbound': '入库管理',
  '/inventory/inbound/create': '产品入库',
  '/inventory/outbound': '出库管理',
  '/inventory/adjust': '库存调整',

  // 产品管理子页面
  '/products/create': '新建产品',
  '/products/categories': '产品分类',

  // 客户管理子页面
  '/customers/create': '新建客户',

  // 销售订单子页面
  '/sales-orders/create': '新建订单',

  // 退货订单子页面
  '/return-orders/create': '新建退货',

  // 认证相关页面
  '/auth': '认证',
  '/auth/signin': '登录',
  '/auth/register': '注册',
  '/auth/error': '认证错误',

  // 通用操作
  '/create': '新建',
  '/edit': '编辑',
  '/view': '查看',
  '/details': '详情',

  // 路径段映射（用于处理单独的路径段）
  'dashboard': '仪表盘',
  'inventory': '库存管理',
  'products': '产品管理',
  'sales-orders': '销售订单',
  'return-orders': '退货订单',
  'customers': '客户管理',
  'payments': '支付管理',
  'settings': '系统设置',
  'categories': '分类管理',
  'inbound': '入库管理',
  'outbound': '出库管理',
  'adjust': '库存调整',
  'create': '新建',
  'edit': '编辑',
  'view': '查看',
  'details': '详情',
  'auth': '认证',
  'signin': '登录',
  'register': '注册',
  'error': '错误',
};

/**
 * 面包屑导航组件
 * 自动根据当前路径生成面包屑，支持自定义项目
 */
export function Breadcrumb({
  items,
  showHome = true,
  className,
  separator = <ChevronRight className="h-4 w-4 text-muted-foreground" />,
}: BreadcrumbProps) {
  const pathname = usePathname();

  // 自动生成面包屑项
  const autoGeneratedItems = React.useMemo(() => {
    if (items) return items;

    const segments = pathname.split('/').filter(Boolean);
    const breadcrumbItems: BreadcrumbItem[] = [];

    // 添加首页
    if (showHome) {
      breadcrumbItems.push({
        title: '首页',
        href: '/dashboard',
        isCurrent: pathname === '/dashboard',
      });
    }

    // 如果当前就在仪表盘页面，不需要添加额外的路径段
    if (pathname === '/dashboard') {
      return breadcrumbItems;
    }

    // 构建路径面包屑
    let currentPath = '';
    segments.forEach((segment, index) => {
      currentPath += `/${segment}`;
      const isLast = index === segments.length - 1;

      // 获取标题 - 优先使用完整路径映射，然后使用路径段映射
      let title = PATH_TITLES[currentPath] || PATH_TITLES[segment] || segment;

      // 如果是ID（纯数字或UUID格式），尝试获取更友好的名称
      if (/^[0-9a-f-]{36}$|^\d+$/.test(segment)) {
        title = `详情 #${segment.slice(0, 8)}`;
      }

      breadcrumbItems.push({
        title,
        href: isLast ? undefined : currentPath,
        isCurrent: isLast,
      });
    });

    return breadcrumbItems;
  }, [pathname, items, showHome]);

  if (autoGeneratedItems.length <= 1 && !showHome) {
    return null;
  }

  return (
    <nav
      aria-label="面包屑导航"
      className={cn(
        'flex items-center space-x-1 text-sm text-muted-foreground',
        className
      )}
    >
      <ol className="flex items-center space-x-1">
        {autoGeneratedItems.map((item, index) => (
          <li key={index} className="flex items-center space-x-1">
            {index > 0 && (
              <span className="flex items-center" aria-hidden="true">
                {separator}
              </span>
            )}

            {item.isCurrent ? (
              <span className="font-medium text-foreground" aria-current="page">
                {item.title}
              </span>
            ) : item.href ? (
              <Link
                href={item.href}
                className="transition-colors hover:text-foreground"
              >
                {item.title}
              </Link>
            ) : (
              <span>{item.title}</span>
            )}
          </li>
        ))}
      </ol>
    </nav>
  );
}

/**
 * 紧凑型面包屑组件
 * 适用于移动端或空间有限的场景
 */
export function CompactBreadcrumb({
  items,
  showHome = false,
  className,
}: Omit<BreadcrumbProps, 'separator'>) {
  const pathname = usePathname();

  const autoGeneratedItems = React.useMemo(() => {
    if (items) return items;

    const segments = pathname.split('/').filter(Boolean);
    if (segments.length === 0) return [];

    const breadcrumbItems: BreadcrumbItem[] = [];

    // 只显示当前页面和上一级
    if (segments.length > 1) {
      const parentPath = `/${segments.slice(0, -1).join('/')}`;
      const parentSegment = segments[segments.length - 2];
      const parentTitle =
        PATH_TITLES[parentPath] || PATH_TITLES[parentSegment] || parentSegment;

      breadcrumbItems.push({
        title: parentTitle,
        href: parentPath,
        isCurrent: false,
      });
    }

    // 当前页面
    const currentSegment = segments[segments.length - 1];
    const currentTitle = PATH_TITLES[pathname] || PATH_TITLES[currentSegment] || currentSegment;
    breadcrumbItems.push({
      title: currentTitle,
      isCurrent: true,
    });

    return breadcrumbItems;
  }, [pathname, items]);

  if (autoGeneratedItems.length <= 1) {
    return null;
  }

  return (
    <nav
      aria-label="面包屑导航"
      className={cn('flex items-center space-x-2', className)}
    >
      <Button
        variant="ghost"
        size="sm"
        asChild
        className="h-8 px-2 text-muted-foreground hover:text-foreground"
      >
        <Link href={autoGeneratedItems[0].href || '#'}>
          <ChevronRight className="mr-1 h-4 w-4 rotate-180" />
          {autoGeneratedItems[0].title}
        </Link>
      </Button>

      <span className="font-medium text-foreground">
        {autoGeneratedItems[autoGeneratedItems.length - 1].title}
      </span>
    </nav>
  );
}

/**
 * 面包屑项组件
 * 可以单独使用的面包屑项
 */
export function BreadcrumbItem({
  title,
  href,
  isCurrent,
  className,
  children,
}: BreadcrumbItem & {
  className?: string;
  children?: React.ReactNode;
}) {
  if (isCurrent) {
    return (
      <span
        className={cn('font-medium text-foreground', className)}
        aria-current="page"
      >
        {children || title}
      </span>
    );
  }

  if (href) {
    return (
      <Link
        href={href}
        className={cn('transition-colors hover:text-foreground', className)}
      >
        {children || title}
      </Link>
    );
  }

  return <span className={className}>{children || title}</span>;
}
