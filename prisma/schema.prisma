// 库存管理工具 Prisma Schema
// 严格按照 TECH_ARCHITECTURE 文档设计
// 支持 MySQL 8.0+ 特性：JSON字段、全文搜索、窗口函数

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// SQLite 不支持枚举，使用字符串约束替代

// 用户表 - 系统用户管理
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  username     String   @unique // 新增用户名字段，用于登录
  name         String
  passwordHash String   @map("password_hash")
  role         String   @default("sales") // admin, sales
  status       String   @default("active") // active, inactive
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联关系
  salesOrders    SalesOrder[]
  inboundRecords InboundRecord[]
  paymentRecords PaymentRecord[]

  @@index([email])
  @@index([username])
  @@index([role])
  @@map("users")
}

// 客户表 - 客户信息管理，支持层级关系
model Customer {
  id               String    @id @default(uuid())
  name             String
  phone            String?
  address          String?
  extendedInfo     String?   @map("extended_info") // JSON格式的客户扩展信息（SQLite存储为文本）
  parentCustomerId String?   @map("parent_customer_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // 自关联：客户层级关系
  parentCustomer Customer?  @relation("CustomerHierarchy", fields: [parentCustomerId], references: [id])
  childCustomers Customer[] @relation("CustomerHierarchy")

  // 关联关系
  salesOrders    SalesOrder[]
  paymentRecords PaymentRecord[]

  @@index([name])
  @@index([phone])
  @@index([parentCustomerId], map: "idx_customers_parent")
  @@map("customers")
}

// 分类表 - 产品分类管理，支持层级结构
model Category {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  parentId    String?  @map("parent_id")
  sortOrder   Int      @default(0) @map("sort_order")
  status      String   @default("active") // active, inactive
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 自关联：分类层级关系
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  // 关联关系
  products Product[]

  @@index([name])
  @@index([code])
  @@index([parentId], map: "idx_categories_parent")
  @@index([status])
  @@map("categories")
}

// 产品表 - 产品基础信息管理
model Product {
  id             String   @id @default(uuid())
  code           String   @unique
  name           String
  specification  String?
  specifications String?  // JSON格式的详细规格信息（SQLite存储为文本）
  unit           String   @default("piece") // piece, sheet, strip
  piecesPerUnit  Int      @default(1) @map("pieces_per_unit")
  weight         Float?
  thickness      Float?   // 产品厚度(mm)，瓷砖行业重要参数
  categoryId     String?  @map("category_id") // 产品分类ID
  status         String   @default("active") // active, inactive
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // 关联关系
  category         Category?        @relation(fields: [categoryId], references: [id])
  variants         ProductVariant[]
  inventory        Inventory[]
  salesOrderItems  SalesOrderItem[]
  inboundRecords   InboundRecord[]

  @@index([code])
  @@index([categoryId], map: "idx_products_category")
  @@index([status])
  @@map("products")
}

// 产品变体表 - 管理产品的色号变体
model ProductVariant {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  colorCode   String   @map("color_code")
  colorName   String?  @map("color_name") // 色号的中文名称
  colorValue  String?  @map("color_value") // 色号对应的颜色值
  sku         String   @unique // 产品编码+色号的唯一SKU
  status      String   @default("active") // active, inactive
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联关系
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventory   Inventory[]

  @@unique([productId, colorCode], map: "uk_product_color")
  @@index([productId])
  @@index([colorCode])
  @@index([sku])
  @@map("product_variants")
}

// 销售单表 - 销售订单主表
model SalesOrder {
  id           String   @id @default(uuid())
  orderNumber  String   @unique @map("order_number")
  customerId   String   @map("customer_id")
  userId       String   @map("user_id")
  status       String   @default("draft") // draft, confirmed, shipped, completed, cancelled
  totalAmount  Float    @default(0) @map("total_amount")
  remarks      String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联关系
  customer Customer         @relation(fields: [customerId], references: [id])
  user     User             @relation(fields: [userId], references: [id])
  items    SalesOrderItem[]
  payments PaymentRecord[]

  @@index([customerId], map: "idx_sales_orders_customer")
  @@index([userId], map: "idx_sales_orders_user")
  @@index([status], map: "idx_sales_orders_status")
  @@index([createdAt(sort: Desc)], map: "idx_sales_orders_date")
  @@map("sales_orders")
}

// 销售单明细表 - 销售订单明细，包含瓷砖行业特有字段
model SalesOrderItem {
  id             String     @id @default(uuid())
  salesOrderId   String     @map("sales_order_id")
  productId      String     @map("product_id")
  colorCode      String?    @map("color_code")
  productionDate String?    @map("production_date") // 生产日期，瓷砖行业特有
  quantity       Float
  unitPrice      Float      @map("unit_price")
  subtotal       Float

  // 关联关系
  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id])

  @@index([salesOrderId], map: "idx_sales_order_items_order")
  @@index([productId], map: "idx_sales_order_items_product")
  @@index([productId, colorCode], map: "idx_sales_order_items_product_color")
  @@map("sales_order_items")
}

// 库存表 - 产品库存管理，支持变体和生产批次维度
model Inventory {
  id               String    @id @default(uuid())
  productId        String    @map("product_id")
  variantId        String?   @map("variant_id") // 产品变体ID（可选，兼容无色号产品）
  colorCode        String?   @map("color_code") // 保留字段，用于向后兼容
  productionDate   DateTime? @map("production_date")
  batchNumber      String?   @map("batch_number") // 生产批次号
  quantity         Int       @default(0)
  reservedQuantity Int       @default(0) @map("reserved_quantity") // 预留数量
  unitCost         Float?    @map("unit_cost") // 单位成本
  location         String?   // 存储位置
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // 关联关系
  product Product @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([productId, variantId, productionDate, batchNumber], map: "uk_inventory_variant_batch")
  @@index([productId], map: "idx_inventory_product")
  @@index([variantId], map: "idx_inventory_variant")
  @@index([quantity], map: "idx_inventory_quantity")
  @@index([productionDate], map: "idx_inventory_production_date")
  @@index([batchNumber], map: "idx_inventory_batch")
  @@map("inventory")
}

// 入库记录表 - 入库操作记录，支持多种入库类型
model InboundRecord {
  id             String    @id @default(uuid())
  recordNumber   String    @unique @map("record_number")
  productId      String    @map("product_id")
  quantity       Float     // 支持小数点，最小值0.01
  reason         String    @default("purchase") // purchase, return, transfer, surplus, other
  remarks        String?   // 最大500字符
  userId         String    @map("user_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // 关联关系
  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@index([productId], map: "idx_inbound_records_product")
  @@index([userId], map: "idx_inbound_records_user")
  @@index([reason], map: "idx_inbound_records_reason")
  @@index([createdAt(sort: Desc)], map: "idx_inbound_records_date")
  @@map("inbound_records")
}

// 收款记录表 - 收款管理，支持部分收款和分期收款
model PaymentRecord {
  id              String   @id @default(uuid())
  paymentNumber   String   @unique @map("payment_number")
  salesOrderId    String   @map("sales_order_id")
  customerId      String   @map("customer_id")
  userId          String   @map("user_id")
  paymentMethod   String   @default("cash") // cash, bank_transfer, check, other
  paymentAmount   Float    @map("payment_amount")
  paymentDate     DateTime @map("payment_date")
  status          String   @default("pending") // pending, confirmed, cancelled
  remarks         String?
  receiptNumber   String?  @map("receipt_number") // 收据号
  bankInfo        String?  @map("bank_info") // 银行信息（转账时使用）
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // 关联关系
  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id])
  customer   Customer   @relation(fields: [customerId], references: [id])
  user       User       @relation(fields: [userId], references: [id])

  @@index([salesOrderId], map: "idx_payment_records_order")
  @@index([customerId], map: "idx_payment_records_customer")
  @@index([userId], map: "idx_payment_records_user")
  @@index([status], map: "idx_payment_records_status")
  @@index([paymentDate(sort: Desc)], map: "idx_payment_records_date")
  @@index([paymentMethod], map: "idx_payment_records_method")
  @@map("payment_records")
}
