# å…¨å±€ä»£ç è´¨é‡é—®é¢˜æ£€æŸ¥æŠ¥å‘Š

> æ£€æŸ¥æ—¶é—´: 2025-10-02  
> æ£€æŸ¥èŒƒå›´: å…¨å±€ä»£ç åº“  
> æ£€æŸ¥æ ‡å‡†: å…¨å±€çº¦å®šè§„èŒƒã€æœ€ä½³å®è·µã€ä»£ç è´¨é‡ã€å”¯ä¸€çœŸç†åŸåˆ™

---

## ğŸ” æ£€æŸ¥å‘ç°

### ğŸ”´ ä¸¥é‡é—®é¢˜ - å¼€å‘ç¯å¢ƒç»•è¿‡èº«ä»½è®¤è¯

å‘ç°å¤šä¸ªAPIè·¯ç”±å­˜åœ¨å¼€å‘ç¯å¢ƒç»•è¿‡èº«ä»½è®¤è¯çš„é—®é¢˜,è¿™æ˜¯ä¸¥é‡çš„å®‰å…¨éšæ‚£ã€‚

#### å—å½±å“çš„æ–‡ä»¶åˆ—è¡¨

1. **å‚å®¶å‘è´§æ¨¡å—**:
   - `app/api/factory-shipments/route.ts`
   - `app/api/factory-shipments/[id]/route.ts`

2. **è´¢åŠ¡æ¨¡å— - åº”ä»˜æ¬¾**:
   - `app/api/finance/payables/route.ts`
   - `app/api/finance/payables/statistics/route.ts`
   - `app/api/finance/payables/[id]/route.ts`

3. **è´¢åŠ¡æ¨¡å— - ä»˜æ¬¾**:
   - `app/api/finance/payments-out/route.ts`
   - `app/api/finance/payments-out/[id]/route.ts`

4. **è´¢åŠ¡æ¨¡å— - åº”æ”¶æ¬¾**:
   - `app/api/finance/receivables/route.ts`
   - `app/api/finance/receivables/statistics/route.ts`

5. **è´¢åŠ¡æ¨¡å— - é€€æ¬¾**:
   - `app/api/finance/refunds/route.ts`
   - `app/api/finance/refunds/statistics/route.ts`

#### é—®é¢˜æ¨¡å¼

æ‰€æœ‰è¿™äº›æ–‡ä»¶éƒ½ä½¿ç”¨äº†ç±»ä¼¼çš„æ¨¡å¼:

```typescript
// âŒ é”™è¯¯æ¨¡å¼
if (env.NODE_ENV !== 'development') {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) {
    return NextResponse.json(
      { success: false, error: 'æœªæˆæƒè®¿é—®' },
      { status: 401 }
    );
  }
}
```

#### å®‰å…¨é£é™©

- å¼€å‘ç¯å¢ƒå®Œå…¨ç»•è¿‡èº«ä»½è®¤è¯
- å¯èƒ½å¯¼è‡´æœªæˆæƒè®¿é—®æ•æ„Ÿæ•°æ®
- è¿åå®‰å…¨æœ€ä½³å®è·µ
- ä¸ç¬¦åˆå…¨å±€çº¦å®šè§„èŒƒ

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ - å¯¼å…¥é¡ºåºä¸æ­£ç¡®

å‘ç°å¤šä¸ªæ–‡ä»¶çš„å¯¼å…¥é¡ºåºä¸ç¬¦åˆESLintè§„èŒƒã€‚

#### ESLinté”™è¯¯

```
Error: `next/server` import should occur before import of `next-auth`
```

#### å—å½±å“çš„æ–‡ä»¶

1. **è®¾ç½®æ¨¡å—**:
   - `app/(dashboard)/settings/basic/page.tsx`
   - `app/(dashboard)/settings/logs/page.tsx`
   - `app/(dashboard)/settings/storage/page.tsx`
   - `app/(dashboard)/settings/users/page.tsx`

2. **åº“å­˜æ¨¡å—**:
   - `app/api/inventory/adjust/route.ts`
   - `app/api/inventory/adjustments/route.ts`
   - `app/api/inventory/check-availability/route.ts`
   - `app/api/inventory/outbound/route.ts`

3. **ä¾›åº”å•†æ¨¡å—**:
   - `app/api/suppliers/route.ts`
   - `app/api/suppliers/[id]/route.ts`

4. **å¯¹è´¦å•æ¨¡å—**:
   - `app/api/statements/[id]/route.ts`

#### æ­£ç¡®çš„å¯¼å…¥é¡ºåº

```typescript
// âœ… æ­£ç¡®é¡ºåº
import { NextRequest, NextResponse } from 'next/server';  // Next.jsæ ¸å¿ƒ
import { getServerSession } from 'next-auth';              // ç¬¬ä¸‰æ–¹åº“

import { ... } from '@/lib/...';                           // é¡¹ç›®å†…éƒ¨
```

---

### ğŸŸ¢ è½»å¾®é—®é¢˜ - æœªä½¿ç”¨çš„å˜é‡

#### å—å½±å“çš„æ–‡ä»¶

1. `app/api/statements/[id]/route.ts:39` - `refundAmount` å˜é‡æœªä½¿ç”¨
2. `lib/cache/finance-cache.ts:12` - `buildCacheKey`, `getRandomTTL` æœªä½¿ç”¨

---

## ğŸ“Š é—®é¢˜ç»Ÿè®¡

| ä¸¥é‡ç¨‹åº¦ | é—®é¢˜æ•°é‡ | å—å½±å“æ–‡ä»¶æ•° | é¢„è®¡ä¿®å¤æ—¶é—´ |
| -------- | -------- | ------------ | ------------ |
| ğŸ”´ ä¸¥é‡  | 1ç±»      | 13ä¸ªæ–‡ä»¶     | 2-3å°æ—¶      |
| ğŸŸ¡ ä¸­ç­‰  | 1ç±»      | 12ä¸ªæ–‡ä»¶     | 1-2å°æ—¶      |
| ğŸŸ¢ è½»å¾®  | 2ä¸ª      | 2ä¸ªæ–‡ä»¶      | 15åˆ†é’Ÿ       |
| **æ€»è®¡** | **3ç±»**  | **27ä¸ªæ–‡ä»¶** | **3-5å°æ—¶**  |

---

## ğŸ¯ ä¿®å¤ä¼˜å…ˆçº§

### ç¬¬ä¸€ä¼˜å…ˆçº§ (ç«‹å³ä¿®å¤)

**ğŸ”´ ä¿®å¤æ‰€æœ‰å¼€å‘ç¯å¢ƒè®¤è¯ç»•è¿‡é—®é¢˜**

å½±å“èŒƒå›´: 13ä¸ªAPIè·¯ç”±æ–‡ä»¶

ä¿®å¤æ–¹æ¡ˆ:

```typescript
// ç§»é™¤å¼€å‘ç¯å¢ƒåˆ¤æ–­,å§‹ç»ˆéªŒè¯è®¤è¯
const session = await getServerSession(authOptions);
if (!session?.user?.id) {
  return NextResponse.json(
    { success: false, error: 'æœªæˆæƒè®¿é—®' },
    { status: 401 }
  );
}
```

### ç¬¬äºŒä¼˜å…ˆçº§ (æœ¬å‘¨å†…å®Œæˆ)

**ğŸŸ¡ ä¿®å¤æ‰€æœ‰å¯¼å…¥é¡ºåºé—®é¢˜**

å½±å“èŒƒå›´: 12ä¸ªæ–‡ä»¶

ä¿®å¤æ–¹æ¡ˆ:

```typescript
// è°ƒæ•´å¯¼å…¥é¡ºåº
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
```

### ç¬¬ä¸‰ä¼˜å…ˆçº§ (æœ‰æ—¶é—´æ—¶ä¿®å¤)

**ğŸŸ¢ æ¸…ç†æœªä½¿ç”¨çš„å˜é‡**

å½±å“èŒƒå›´: 2ä¸ªæ–‡ä»¶

ä¿®å¤æ–¹æ¡ˆ:

- ç§»é™¤æœªä½¿ç”¨çš„å˜é‡
- æˆ–è€…ä½¿ç”¨ä¸‹åˆ’çº¿å‰ç¼€æ ‡è®°ä¸ºæœ‰æ„æœªä½¿ç”¨

---

## ğŸ”§ ä¿®å¤è®¡åˆ’

### é˜¶æ®µ1: ä¿®å¤è®¤è¯ç»•è¿‡é—®é¢˜ (2-3å°æ—¶)

1. **å‚å®¶å‘è´§æ¨¡å—** (30åˆ†é’Ÿ)
   - [ ] `app/api/factory-shipments/route.ts`
   - [ ] `app/api/factory-shipments/[id]/route.ts`

2. **è´¢åŠ¡æ¨¡å— - åº”ä»˜æ¬¾** (30åˆ†é’Ÿ)
   - [ ] `app/api/finance/payables/route.ts`
   - [ ] `app/api/finance/payables/statistics/route.ts`
   - [ ] `app/api/finance/payables/[id]/route.ts`

3. **è´¢åŠ¡æ¨¡å— - ä»˜æ¬¾** (30åˆ†é’Ÿ)
   - [ ] `app/api/finance/payments-out/route.ts`
   - [ ] `app/api/finance/payments-out/[id]/route.ts`

4. **è´¢åŠ¡æ¨¡å— - åº”æ”¶æ¬¾** (30åˆ†é’Ÿ)
   - [ ] `app/api/finance/receivables/route.ts`
   - [ ] `app/api/finance/receivables/statistics/route.ts`

5. **è´¢åŠ¡æ¨¡å— - é€€æ¬¾** (30åˆ†é’Ÿ)
   - [ ] `app/api/finance/refunds/route.ts`
   - [ ] `app/api/finance/refunds/statistics/route.ts`

### é˜¶æ®µ2: ä¿®å¤å¯¼å…¥é¡ºåºé—®é¢˜ (1-2å°æ—¶)

1. **è®¾ç½®æ¨¡å—** (30åˆ†é’Ÿ)
   - [ ] `app/(dashboard)/settings/basic/page.tsx`
   - [ ] `app/(dashboard)/settings/logs/page.tsx`
   - [ ] `app/(dashboard)/settings/storage/page.tsx`
   - [ ] `app/(dashboard)/settings/users/page.tsx`

2. **åº“å­˜æ¨¡å—** (30åˆ†é’Ÿ)
   - [ ] `app/api/inventory/adjust/route.ts`
   - [ ] `app/api/inventory/adjustments/route.ts`
   - [ ] `app/api/inventory/check-availability/route.ts`
   - [ ] `app/api/inventory/outbound/route.ts`

3. **å…¶ä»–æ¨¡å—** (30åˆ†é’Ÿ)
   - [ ] `app/api/suppliers/route.ts`
   - [ ] `app/api/suppliers/[id]/route.ts`
   - [ ] `app/api/statements/[id]/route.ts`

### é˜¶æ®µ3: æ¸…ç†æœªä½¿ç”¨å˜é‡ (15åˆ†é’Ÿ)

- [ ] `app/api/statements/[id]/route.ts`
- [ ] `lib/cache/finance-cache.ts`

---

## âœ… éªŒæ”¶æ ‡å‡†

### å®‰å…¨éªŒæ”¶

- [ ] æ‰€æœ‰APIè·¯ç”±éƒ½å¼ºåˆ¶è¿›è¡Œèº«ä»½è®¤è¯
- [ ] æ— å¼€å‘ç¯å¢ƒè®¤è¯ç»•è¿‡
- [ ] ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ

### ä»£ç è´¨é‡éªŒæ”¶

- [ ] ESLintæ£€æŸ¥æ— Errorçº§åˆ«é”™è¯¯
- [ ] å¯¼å…¥é¡ºåºç¬¦åˆè§„èŒƒ
- [ ] æ— æœªä½¿ç”¨çš„å˜é‡è­¦å‘Š

### åŠŸèƒ½éªŒæ”¶

- [ ] æ‰€æœ‰APIæ¥å£æ­£å¸¸å·¥ä½œ
- [ ] èº«ä»½è®¤è¯æ­£å¸¸
- [ ] æ— åŠŸèƒ½å›å½’

---

## ğŸ“ ä¿®å¤å»ºè®®

### 1. ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶

å»ºè®®åˆ›å»ºç»Ÿä¸€çš„è®¤è¯ä¸­é—´ä»¶,é¿å…åœ¨æ¯ä¸ªAPIè·¯ç”±ä¸­é‡å¤è®¤è¯é€»è¾‘:

```typescript
// lib/api/auth-middleware.ts
export async function requireAuth() {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) {
    throw ApiError.unauthorized('æœªæˆæƒè®¿é—®');
  }
  return session;
}
```

### 2. ä½¿ç”¨ESLintè‡ªåŠ¨ä¿®å¤

å¯¹äºå¯¼å…¥é¡ºåºé—®é¢˜,å¯ä»¥ä½¿ç”¨ESLintè‡ªåŠ¨ä¿®å¤:

```bash
npm run lint:fix
```

### 3. é…ç½®ç¼–è¾‘å™¨

é…ç½®VSCodeè‡ªåŠ¨ä¿®å¤å¯¼å…¥é¡ºåº:

```json
{
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true,
    "source.organizeImports": true
  }
}
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å¼€å§‹ä¿®å¤è®¤è¯ç»•è¿‡é—®é¢˜** - è¿™æ˜¯æœ€ä¸¥é‡çš„å®‰å…¨éšæ‚£
2. **ä¿®å¤å¯¼å…¥é¡ºåºé—®é¢˜** - æå‡ä»£ç è´¨é‡
3. **æ¸…ç†æœªä½¿ç”¨å˜é‡** - ä¿æŒä»£ç æ•´æ´
4. **è¿è¡Œå®Œæ•´æµ‹è¯•** - ç¡®ä¿æ— åŠŸèƒ½å›å½’
5. **æ›´æ–°æ–‡æ¡£** - è®°å½•ä¿®å¤å†…å®¹

---

**æ£€æŸ¥å®Œæˆæ—¶é—´**: 2025-10-02 14:40  
**æ£€æŸ¥äººå‘˜**: AI Assistant  
**æ£€æŸ¥çŠ¶æ€**: âœ… å®Œæˆ
