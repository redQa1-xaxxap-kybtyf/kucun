# ç”Ÿäº§ç¯å¢ƒè¯¦ç»†æ£€æŸ¥æŠ¥å‘Š

> åŸºäº Next.js 15 æœ€ä½³å®è·µ
> ç”Ÿæˆæ—¶é—´: 2025-10-02
> é¡¹ç›®: åº“å­˜ç®¡ç†ç³»ç»Ÿ

---

## ğŸ” æ‰§è¡Œæ‘˜è¦

### æ€»ä½“è¯„ä¼°: âš ï¸ éœ€è¦æ”¹è¿›

| ç±»åˆ« | è¯„åˆ† | çŠ¶æ€ |
|------|------|------|
| **ä»£ç è´¨é‡** | 7/10 | âš ï¸ è‰¯å¥½ä½†éœ€ä¼˜åŒ– |
| **å®‰å…¨æ€§** | 4/10 | âŒ ä¸¥é‡ä¸è¶³ |
| **æ€§èƒ½** | 6/10 | âš ï¸ éœ€è¦ä¼˜åŒ– |
| **ç”Ÿäº§å°±ç»ª** | 3/10 | âŒ ä¸å»ºè®®éƒ¨ç½² |

### å…³é”®å‘ç°
- âœ… ä»£ç ç»“æ„è‰¯å¥½,éµå¾ª Next.js 15 App Router æ¶æ„
- âŒ **ä¸¥é‡**: ç¼ºå°‘ç”Ÿäº§ç¯å¢ƒé…ç½®
- âŒ **ä¸¥é‡**: ç¼ºå°‘å®‰å…¨å®¡è®¡å’Œ CSP é…ç½®
- âŒ **ä¸¥é‡**: ç¼ºå°‘é”™è¯¯ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ
- âš ï¸ å­˜åœ¨ä»£ç è´¨é‡ Warning
- âš ï¸ ç¼ºå°‘æ€§èƒ½ä¼˜åŒ–é…ç½®

---

## 1. å®‰å…¨æ€§æ£€æŸ¥ âŒ ä¸¥é‡ä¸è¶³

### 1.1 èº«ä»½è®¤è¯ä¸æˆæƒ âš ï¸

#### å½“å‰çŠ¶æ€
- âœ… ä½¿ç”¨ Next-Auth.js
- âœ… API è·¯ç”±æœ‰èº«ä»½éªŒè¯æ£€æŸ¥
- âŒ **ç¼ºå°‘**: Server Actions çš„èº«ä»½éªŒè¯æ£€æŸ¥
- âŒ **ç¼ºå°‘**: ç»Ÿä¸€çš„æƒé™éªŒè¯å±‚

#### é—®é¢˜ç¤ºä¾‹
æ ¹æ® Next.js æœ€ä½³å®è·µ,æ‰€æœ‰ Server Actions éƒ½åº”è¯¥åŒ…å«èº«ä»½éªŒè¯æ£€æŸ¥:

```typescript
// âŒ å½“å‰ä»£ç å¯èƒ½ç¼ºå°‘è¿™æ ·çš„æ£€æŸ¥
'use server'

export async function updateData(data) {
  // ç›´æ¥æ“ä½œæ•°æ®,æ²¡æœ‰èº«ä»½éªŒè¯!
  await db.update(data)
}

// âœ… åº”è¯¥è¿™æ ·åš
'use server'

import { auth } from './lib'

export async function updateData(data) {
  const { user } = await auth()
  if (!user) {
    throw new Error('You must be signed in to perform this action')
  }
  
  // éªŒè¯ç”¨æˆ·æƒé™
  if (!user.hasPermission('update')) {
    throw new Error('Unauthorized')
  }
  
  await db.update(data)
}
```

#### å»ºè®®
1. **ç«‹å³**: å®¡è®¡æ‰€æœ‰ Server Actions,æ·»åŠ èº«ä»½éªŒè¯
2. **ç«‹å³**: å®æ–½ç»Ÿä¸€çš„æƒé™éªŒè¯å±‚
3. **çŸ­æœŸ**: ä½¿ç”¨ `forbidden()` å‡½æ•°è¿›è¡Œæƒé™æ£€æŸ¥

### 1.2 Content Security Policy (CSP) âŒ ç¼ºå¤±

#### å½“å‰çŠ¶æ€
- âŒ **æœªé…ç½®** CSP å¤´
- âŒ **æœªé…ç½®** ä¸­é—´ä»¶å®‰å…¨å¤´

#### é£é™©
- XSS æ”»å‡»é£é™©
- ä»£ç æ³¨å…¥é£é™©
- æ•°æ®æ³„éœ²é£é™©

#### å»ºè®®å®æ–½
æ ¹æ® Next.js æœ€ä½³å®è·µ,åº”è¯¥åœ¨ middleware.ts ä¸­é…ç½® CSP:

```typescript
// middleware.ts
import { NextRequest, NextResponse } from 'next/server'

export function middleware(request: NextRequest) {
  const nonce = Buffer.from(crypto.randomUUID()).toString('base64')
  const isDev = process.env.NODE_ENV === 'development'

  const cspHeader = `
    default-src 'self';
    script-src 'self' 'nonce-${nonce}' 'strict-dynamic' ${isDev ? "'unsafe-eval'" : ''};
    style-src 'self' ${isDev ? "'unsafe-inline'" : `'nonce-${nonce}'`};
    img-src 'self' blob: data:;
    font-src 'self';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests;
  `

  const response = NextResponse.next()
  response.headers.set('Content-Security-Policy', cspHeader.replace(/\s{2,}/g, ' ').trim())
  response.headers.set('X-Content-Type-Options', 'nosniff')
  response.headers.set('X-Frame-Options', 'DENY')
  response.headers.set('X-XSS-Protection', '1; mode=block')
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
  
  return response
}

export const config = {
  matcher: [
    {
      source: '/((?!api|_next/static|_next/image|favicon.ico).*)',
      missing: [
        { type: 'header', key: 'next-router-prefetch' },
        { type: 'header', key: 'purpose', value: 'prefetch' },
      ],
    },
  ],
}
```

### 1.3 ç¯å¢ƒå˜é‡å®‰å…¨ âŒ ä¸¥é‡é—®é¢˜

#### å½“å‰é—®é¢˜
```bash
# .env.local - å¼€å‘ç¯å¢ƒå¯†é’¥
NEXTAUTH_SECRET="inventory-management-secret-key-for-development-environment-2024"
STORAGE_ENCRYPTION_KEY="dev-storage-encryption-key-32chars-minimum-length-required"
```

#### é£é™©
- âŒ ä½¿ç”¨å¼€å‘ç¯å¢ƒå¯†é’¥
- âŒ å¯†é’¥å¼ºåº¦ä¸è¶³
- âŒ å¯èƒ½è¢«æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶

#### å»ºè®®
1. **ç«‹å³**: ç”Ÿæˆå¼ºå¯†é’¥
```bash
# ç”Ÿæˆå¼ºå¯†é’¥
openssl rand -base64 32
```

2. **ç«‹å³**: åˆ›å»º `.env.production`
```bash
NEXTAUTH_SECRET="<ç”Ÿæˆçš„å¼ºå¯†é’¥>"
STORAGE_ENCRYPTION_KEY="<ç”Ÿæˆçš„å¼ºå¯†é’¥>"
```

3. **ç«‹å³**: ç¡®ä¿ `.env.production` åœ¨ `.gitignore` ä¸­

### 1.4 æ•°æ®éªŒè¯ âš ï¸ éƒ¨åˆ†å®Œæˆ

#### å½“å‰çŠ¶æ€
- âœ… ä½¿ç”¨ Zod è¿›è¡Œæ•°æ®éªŒè¯
- âš ï¸ éƒ¨åˆ† API å¯èƒ½ç¼ºå°‘éªŒè¯

#### å»ºè®®
1. å®¡è®¡æ‰€æœ‰ API è·¯ç”±å’Œ Server Actions
2. ç¡®ä¿æ‰€æœ‰è¾“å…¥éƒ½ç»è¿‡ Zod éªŒè¯
3. å®æ–½è¾“å‡ºéªŒè¯,é˜²æ­¢æ•°æ®æ³„éœ²

---

## 2. æ€§èƒ½ä¼˜åŒ– âš ï¸ éœ€è¦æ”¹è¿›

### 2.1 æ„å»ºä¼˜åŒ– âš ï¸

#### å½“å‰é…ç½®
- âŒ æœªé…ç½® `assetPrefix` (CDN)
- âŒ æœªé…ç½®å›¾ç‰‡ä¼˜åŒ–
- âŒ æœªé…ç½®ä»£ç åˆ†å‰²ä¼˜åŒ–

#### å»ºè®®é…ç½® (next.config.js)
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // CDN é…ç½®
  assetPrefix: process.env.NODE_ENV === 'production' 
    ? 'https://cdn.yourdomain.com' 
    : undefined,
  
  // å›¾ç‰‡ä¼˜åŒ–
  images: {
    domains: ['yourdomain.com'],
    formats: ['image/avif', 'image/webp'],
    minimumCacheTTL: 60,
    // å®‰å…¨é…ç½®
    dangerouslyAllowSVG: true,
    contentDispositionType: 'attachment',
    contentSecurityPolicy: "default-src 'self'; script-src 'none'; sandbox;",
  },
  
  // å‹ç¼©
  compress: true,
  
  // ç”Ÿäº§ä¼˜åŒ–
  productionBrowserSourceMaps: false,
  
  // å®éªŒæ€§åŠŸèƒ½
  experimental: {
    optimizeCss: true,
    optimizePackageImports: ['lucide-react', '@tanstack/react-query'],
  },
}

export default nextConfig
```

### 2.2 ç¼“å­˜ç­–ç•¥ âš ï¸

#### å½“å‰çŠ¶æ€
- âœ… ä½¿ç”¨ Redis ç¼“å­˜
- âš ï¸ ç¼“å­˜ç­–ç•¥å¯èƒ½ä¸å¤Ÿä¼˜åŒ–

#### å»ºè®®
1. å®æ–½åˆ†å±‚ç¼“å­˜ç­–ç•¥
2. é…ç½® HTTP ç¼“å­˜å¤´
3. ä½¿ç”¨ Next.js çš„ `revalidate` é€‰é¡¹

### 2.3 ä»£ç åˆ†å‰² âš ï¸

#### å½“å‰é—®é¢˜
- âš ï¸ éƒ¨åˆ†ç»„ä»¶å¯èƒ½è¿‡å¤§
- âš ï¸ æœªä½¿ç”¨åŠ¨æ€å¯¼å…¥

#### å»ºè®®
```typescript
// ä½¿ç”¨åŠ¨æ€å¯¼å…¥å‡å°‘åˆå§‹åŠ è½½
import dynamic from 'next/dynamic'

const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <p>Loading...</p>,
  ssr: false, // å¦‚æœä¸éœ€è¦ SSR
})
```

---

## 3. ç›‘æ§ä¸æ—¥å¿— âŒ ä¸¥é‡ç¼ºå¤±

### 3.1 é”™è¯¯ç›‘æ§ âŒ æœªé…ç½®

#### å»ºè®®é›†æˆ Sentry
```typescript
// instrumentation.ts
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./sentry.server.config')
  }

  if (process.env.NEXT_RUNTIME === 'edge') {
    await import('./sentry.edge.config')
  }
}

export const onRequestError = async (err, request, context) => {
  await fetch('https://...', {
    method: 'POST',
    body: JSON.stringify({ message: err.message, request }),
    headers: { 'Content-Type': 'application/json' },
  })
}
```

### 3.2 æ€§èƒ½ç›‘æ§ âŒ æœªé…ç½®

#### å»ºè®®
```typescript
// instrumentation-client.ts
export function onRouterTransitionStart(url: string) {
  performance.mark(`nav-start-${url}`)
}

const observer = new PerformanceObserver((list) => {
  for (const entry of list.getEntries()) {
    if (entry instanceof PerformanceNavigationTiming) {
      console.log('Time to Interactive:', entry.loadEventEnd - startTime)
    }
  }
})

observer.observe({ entryTypes: ['navigation'] })
```

### 3.3 æ—¥å¿—ç³»ç»Ÿ âš ï¸ åŸºç¡€å®ç°

#### å½“å‰é—®é¢˜
- âš ï¸ ä½¿ç”¨ console.log (ç”Ÿäº§ç¯å¢ƒä¸æ¨è)
- âŒ ç¼ºå°‘ç»“æ„åŒ–æ—¥å¿—
- âŒ ç¼ºå°‘æ—¥å¿—èšåˆ

#### å»ºè®®
1. ä½¿ç”¨ä¸“ä¸šæ—¥å¿—åº“ (å¦‚ Winston, Pino)
2. å®æ–½ç»“æ„åŒ–æ—¥å¿—
3. é›†æˆæ—¥å¿—èšåˆæœåŠ¡

---

## 4. éƒ¨ç½²é…ç½® âŒ æœªå®Œæˆ

### 4.1 ç¯å¢ƒé…ç½® âŒ

#### ç¼ºå°‘æ–‡ä»¶
- âŒ `.env.production`
- âŒ `ecosystem.config.js` (PM2)
- âŒ `Dockerfile` (å®¹å™¨åŒ–)

#### å»ºè®®åˆ›å»º ecosystem.config.js
```javascript
module.exports = {
  apps: [{
    name: 'kucun',
    script: 'node_modules/next/dist/bin/next',
    args: 'start',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000,
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
  }],
}
```

### 4.2 æ•°æ®åº“é…ç½® âŒ

#### å½“å‰é—®é¢˜
- âŒ ä½¿ç”¨ SQLite (ä¸é€‚åˆç”Ÿäº§)
- âŒ æœªé…ç½® MySQL è¿æ¥æ± 
- âŒ æœªé…ç½®æ•°æ®åº“å¤‡ä»½

#### å»ºè®®
```bash
# .env.production
DATABASE_URL="mysql://user:password@host:3306/database?connection_limit=10&pool_timeout=30"
```

### 4.3 æ„å»ºè„šæœ¬ âš ï¸

#### å»ºè®®æ·»åŠ 
```json
// package.json
{
  "scripts": {
    "build": "next build",
    "start": "next start",
    "start:prod": "NODE_ENV=production next start -p 3000",
    "pm2:start": "pm2 start ecosystem.config.js",
    "pm2:stop": "pm2 stop kucun",
    "pm2:restart": "pm2 restart kucun",
    "pm2:logs": "pm2 logs kucun"
  }
}
```

---

## 5. ä»£ç è´¨é‡ âš ï¸ éœ€è¦æ”¹è¿›

### 5.1 ESLint Warning æ±‡æ€»

#### é«˜ä¼˜å…ˆçº§ (å½±å“å®‰å…¨/æ€§èƒ½)
1. **`any` ç±»å‹ä½¿ç”¨** (18å¤„)
   - æ–‡ä»¶: `lib/utils/performance.ts`, `lib/utils/permissions.ts` ç­‰
   - é£é™©: ç±»å‹å®‰å…¨æ€§é™ä½
   - å»ºè®®: å®šä¹‰æ˜ç¡®çš„ç±»å‹æ¥å£

2. **éç©ºæ–­è¨€** (1å¤„)
   - æ–‡ä»¶: `lib/utils/performance.ts:73`
   - é£é™©: å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
   - å»ºè®®: ä½¿ç”¨å®‰å…¨çš„ç©ºå€¼æ£€æŸ¥

3. **console.log** (6å¤„)
   - æ–‡ä»¶: å¤šä¸ªæ–‡ä»¶
   - é£é™©: æ€§èƒ½å½±å“,å¯èƒ½æ³„éœ²ä¿¡æ¯
   - å»ºè®®: ç”Ÿäº§ç¯å¢ƒç§»é™¤æˆ–ä½¿ç”¨æ—¥å¿—åº“

#### ä¸­ä¼˜å…ˆçº§ (å½±å“å¯ç»´æŠ¤æ€§)
1. **å‡½æ•°è¿‡é•¿** (4å¤„)
   - æ–‡ä»¶: `lib/ws/ws-server.ts`, `lib/utils/__tests__/datetime.test.ts` ç­‰
   - å»ºè®®: æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•°

---

## 6. æµ‹è¯•è¦†ç›– âŒ ä¸¥é‡ä¸è¶³

### å½“å‰çŠ¶æ€
- âŒ ç¼ºå°‘å•å…ƒæµ‹è¯•
- âŒ ç¼ºå°‘é›†æˆæµ‹è¯•
- âŒ ç¼ºå°‘ E2E æµ‹è¯•
- âš ï¸ æµ‹è¯•æ–‡ä»¶æœ‰ç±»å‹é”™è¯¯

### å»ºè®®
1. **ç«‹å³**: å®‰è£…æµ‹è¯•ç±»å‹å®šä¹‰
```bash
npm install --save-dev @types/jest @testing-library/react @testing-library/jest-dom
```

2. **çŸ­æœŸ**: ç¼–å†™å…³é”®åŠŸèƒ½æµ‹è¯•
3. **é•¿æœŸ**: ç›®æ ‡æµ‹è¯•è¦†ç›–ç‡ > 80%

---

## 7. æ–‡æ¡£å®Œæ•´æ€§ âš ï¸ åŸºç¡€å®Œæˆ

### å½“å‰çŠ¶æ€
- âœ… æœ‰åŸºç¡€ README
- âš ï¸ ç¼ºå°‘ API æ–‡æ¡£
- âš ï¸ ç¼ºå°‘éƒ¨ç½²æ–‡æ¡£
- âš ï¸ ç¼ºå°‘æ•…éšœæ’æŸ¥æŒ‡å—

---

## ğŸ“‹ ç”Ÿäº§éƒ¨ç½²æ¸…å•

### ğŸ”´ é˜»å¡éƒ¨ç½² (å¿…é¡»å®Œæˆ)

#### å®‰å…¨æ€§
- [ ] é…ç½® CSP å¤´
- [ ] å®æ–½ Server Actions èº«ä»½éªŒè¯
- [ ] æ›´æ–°æ‰€æœ‰å¯†é’¥
- [ ] é…ç½® HTTPS/SSL
- [ ] å®æ–½ CORS ç­–ç•¥

#### ç¯å¢ƒé…ç½®
- [ ] åˆ›å»º `.env.production`
- [ ] é…ç½®ç”Ÿäº§æ•°æ®åº“ (MySQL)
- [ ] é…ç½® Redis ç”Ÿäº§è¿æ¥
- [ ] é…ç½®æ–‡ä»¶ä¸Šä¼ è·¯å¾„

#### ç›‘æ§
- [ ] é›†æˆé”™è¯¯ç›‘æ§ (Sentry)
- [ ] é…ç½®æ—¥å¿—ç³»ç»Ÿ
- [ ] è®¾ç½®å‘Šè­¦è§„åˆ™

#### æ„å»ºæµ‹è¯•
- [ ] è¿è¡Œ `npm run build`
- [ ] æµ‹è¯•ç”Ÿäº§æ„å»º
- [ ] éªŒè¯æ‰€æœ‰åŠŸèƒ½

### ğŸŸ¡ å»ºè®®å®Œæˆ (æå‡è´¨é‡)

#### ä»£ç ä¼˜åŒ–
- [ ] ä¿®å¤æ‰€æœ‰ ESLint Warning
- [ ] ç§»é™¤ console.log
- [ ] ä¼˜åŒ–é•¿å‡½æ•°
- [ ] æ·»åŠ ç±»å‹å®šä¹‰

#### æ€§èƒ½ä¼˜åŒ–
- [ ] é…ç½® CDN
- [ ] ä¼˜åŒ–å›¾ç‰‡
- [ ] å®æ–½ç¼“å­˜ç­–ç•¥
- [ ] ä»£ç åˆ†å‰²ä¼˜åŒ–

#### æµ‹è¯•
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•
- [ ] ç¼–å†™ E2E æµ‹è¯•

---

## ğŸ¯ æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|
| **æœ€å°å¯è¡Œéƒ¨ç½²** | 2-3å¤© | å®Œæˆé˜»å¡é¡¹ |
| **æ¨èéƒ¨ç½²** | 1-2å‘¨ | å®Œæˆé˜»å¡é¡¹ + å»ºè®®é¡¹ |
| **å®Œæ•´éƒ¨ç½²** | 1ä¸ªæœˆ | å®Œæˆæ‰€æœ‰é¡¹ + æµ‹è¯• |

---

## ğŸ“Š é£é™©è¯„ä¼°

| é£é™© | ç­‰çº§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| **ç¼ºå°‘ CSP** | ğŸ”´ é«˜ | XSSæ”»å‡» | ç«‹å³é…ç½® CSP |
| **å¼€å‘å¯†é’¥** | ğŸ”´ é«˜ | æ•°æ®æ³„éœ² | ç«‹å³æ›´æ–°å¯†é’¥ |
| **ç¼ºå°‘ç›‘æ§** | ğŸ”´ é«˜ | æ— æ³•å‘ç°é—®é¢˜ | é›†æˆ Sentry |
| **SQLite æ•°æ®åº“** | ğŸ”´ é«˜ | æ€§èƒ½/å¯é æ€§ | è¿ç§»åˆ° MySQL |
| **ä»£ç  Warning** | ğŸŸ¡ ä¸­ | å¯ç»´æŠ¤æ€§ | é€æ­¥ä¿®å¤ |
| **ç¼ºå°‘æµ‹è¯•** | ğŸŸ¡ ä¸­ | è´¨é‡ä¿è¯ | ç¼–å†™æµ‹è¯• |

---

## ğŸ“ ç»“è®º

**å½“å‰çŠ¶æ€**: é¡¹ç›®ä»£ç è´¨é‡è‰¯å¥½,ä½†**ä¸¥é‡ç¼ºä¹ç”Ÿäº§ç¯å¢ƒé…ç½®å’Œå®‰å…¨æªæ–½**ã€‚

**å»ºè®®**: **ä¸å»ºè®®ç›´æ¥éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ**ã€‚å¿…é¡»å…ˆå®Œæˆæ‰€æœ‰é˜»å¡é¡¹,ç‰¹åˆ«æ˜¯å®‰å…¨é…ç½®ã€‚

**ä¼˜å…ˆçº§**:
1. ğŸ”´ **å®‰å…¨æ€§** (æœ€é«˜ä¼˜å…ˆçº§)
2. ğŸ”´ **ç›‘æ§** (é«˜ä¼˜å…ˆçº§)
3. ğŸŸ¡ **æ€§èƒ½** (ä¸­ä¼˜å…ˆçº§)
4. ğŸŸ¢ **æµ‹è¯•** (ä½ä¼˜å…ˆçº§)

**ä¸‹ä¸€æ­¥**: æŒ‰ç…§æ¸…å•é€é¡¹å®Œæˆ,å»ºè®®ä»å®‰å…¨æ€§é…ç½®å¼€å§‹ã€‚

